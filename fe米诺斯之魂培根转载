-- Roblox AIèŠå¤©ç³»ç»Ÿå®¢æˆ·ç«¯è„šæœ¬
-- ä½¿ç”¨å…è´¹APIæ¥å£: https://api.suol.cc/v1/ai.php
-- ä½œè€…: Robloxå¼€å‘è€…
-- æ—¥æœŸ: 2026å¹´1æœˆ12æ—¥

local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local HttpService = game:GetService("HttpService")
local TextChatService = game:GetService("TextChatService")
local RunService = game:GetService("RunService")

-- åˆ›å»ºä¸»ç•Œé¢
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AIChatSystem"
ScreenGui.Parent = PlayerGui

-- åˆ›å»ºä¸»æ¡†æ¶
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 450, 0, 600)
MainFrame.Position = UDim2.new(0, 20, 0.5, -300)
MainFrame.AnchorPoint = Vector2.new(0, 0.5)
MainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
MainFrame.BackgroundTransparency = 0.05
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Parent = ScreenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainFrame

-- åˆ›å»ºæ ‡é¢˜æ 
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 50)
TitleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 55)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local UICorner2 = Instance.new("UICorner")
UICorner2.CornerRadius = UDim.new(0, 12)
UICorner2.CornerRadius = UDim.new(0, 12, 0, 0)
UICorner2.Parent = TitleBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "TitleLabel"
TitleLabel.Size = UDim2.new(1, -100, 1, 0)
TitleLabel.Position = UDim2.new(0, 15, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "ğŸ¤– AIèŠå¤©åŠ©æ‰‹"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 20
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TitleBar

-- åˆ‡æ¢æ˜¾ç¤º/éšè—æŒ‰é’®
local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleButton"
ToggleButton.Size = UDim2.new(0, 40, 0, 40)
ToggleButton.Position = UDim2.new(1, -50, 0.5, -20)
ToggleButton.AnchorPoint = Vector2.new(1, 0.5)
ToggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 85)
ToggleButton.AutoButtonColor = false
ToggleButton.Text = "â€”"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextSize = 24
ToggleButton.Font = Enum.Font.GothamBold
ToggleButton.Parent = TitleBar

local ToggleCorner = Instance.new("UICorner")
ToggleCorner.CornerRadius = UDim.new(0, 8)
ToggleCorner.Parent = ToggleButton

-- èŠå¤©è®°å½•æ˜¾ç¤ºåŒºåŸŸ
local ChatScrollingFrame = Instance.new("ScrollingFrame")
ChatScrollingFrame.Name = "ChatScrollingFrame"
ChatScrollingFrame.Size = UDim2.new(1, -20, 1, -180)
ChatScrollingFrame.Position = UDim2.new(0, 10, 0, 60)
ChatScrollingFrame.BackgroundTransparency = 1
ChatScrollingFrame.BorderSizePixel = 0
ChatScrollingFrame.ScrollBarThickness = 8
ChatScrollingFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 120)
ChatScrollingFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
ChatScrollingFrame.ScrollingDirection = Enum.ScrollingDirection.Y
ChatScrollingFrame.Parent = MainFrame

local ChatLayout = Instance.new("UIListLayout")
ChatLayout.Name = "ChatLayout"
ChatLayout.Padding = UDim.new(0, 12)
ChatLayout.SortOrder = Enum.SortOrder.LayoutOrder
ChatLayout.Parent = ChatScrollingFrame

-- è¾“å…¥åŒºåŸŸ
local InputFrame = Instance.new("Frame")
InputFrame.Name = "InputFrame"
InputFrame.Size = UDim2.new(1, -20, 0, 120)
InputFrame.Position = UDim2.new(0, 10, 1, -130)
InputFrame.BackgroundTransparency = 1
InputFrame.Parent = MainFrame

local InputBox = Instance.new("TextBox")
InputBox.Name = "InputBox"
InputBox.Size = UDim2.new(1, 0, 0, 70)
InputBox.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
InputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
InputBox.TextSize = 16
InputBox.Font = Enum.Font.Gotham
InputBox.PlaceholderText = "è¾“å…¥æ‚¨æƒ³å¯¹AIè¯´çš„è¯..."
InputBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 170)
InputBox.TextXAlignment = Enum.TextXAlignment.Left
InputBox.TextYAlignment = Enum.TextYAlignment.Top
InputBox.ClearTextOnFocus = false
InputBox.TextWrapped = true
InputBox.Parent = InputFrame

local InputCorner = Instance.new("UICorner")
InputCorner.CornerRadius = UDim.new(0, 8)
InputCorner.Parent = InputBox

-- å‘é€æŒ‰é’®
local SendButton = Instance.new("TextButton")
SendButton.Name = "SendButton"
SendButton.Size = UDim2.new(0, 100, 0, 35)
SendButton.Position = UDim2.new(1, 0, 1, 5)
SendButton.AnchorPoint = Vector2.new(1, 1)
SendButton.BackgroundColor3 = Color3.fromRGB(0, 140, 255)
SendButton.Text = "å‘é€"
SendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SendButton.TextSize = 16
SendButton.Font = Enum.Font.GothamBold
SendButton.Parent = InputFrame

local SendCorner = Instance.new("UICorner")
SendCorner.CornerRadius = UDim.new(0, 8)
SendCorner.Parent = SendButton

-- è®¾ç½®æŒ‰é’®
local SettingsButton = Instance.new("TextButton")
SettingsButton.Name = "SettingsButton"
SettingsButton.Size = UDim2.new(0, 100, 0, 35)
SettingsButton.Position = UDim2.new(0, 0, 1, 5)
SettingsButton.AnchorPoint = Vector2.new(0, 1)
SettingsButton.BackgroundColor3 = Color3.fromRGB(65, 65, 90)
SettingsButton.Text = "âš™ï¸ è®¾ç½®"
SettingsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SettingsButton.TextSize = 16
SettingsButton.Font = Enum.Font.Gotham
SettingsButton.Parent = InputFrame

local SettingsCorner = Instance.new("UICorner")
SettingsCorner.CornerRadius = UDim.new(0, 8)
SettingsCorner.Parent = SettingsButton

-- åˆ›å»ºè®¾ç½®é¢æ¿
local SettingsFrame = Instance.new("Frame")
SettingsFrame.Name = "SettingsFrame"
SettingsFrame.Size = UDim2.new(1, 0, 1, 0)
SettingsFrame.Position = UDim2.new(0, 0, 0, 0)
SettingsFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
SettingsFrame.BackgroundTransparency = 0.05
SettingsFrame.Visible = false
SettingsFrame.Parent = MainFrame

local SettingsCorner2 = Instance.new("UICorner")
SettingsCorner2.CornerRadius = UDim.new(0, 12)
SettingsCorner2.Parent = SettingsFrame

-- è®¾ç½®æ ‡é¢˜
local SettingsTitle = Instance.new("TextLabel")
SettingsTitle.Name = "SettingsTitle"
SettingsTitle.Size = UDim2.new(1, -20, 0, 50)
SettingsTitle.Position = UDim2.new(0, 15, 0, 0)
SettingsTitle.BackgroundTransparency = 1
SettingsTitle.Text = "âš™ï¸ AIè®¾ç½®"
SettingsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
SettingsTitle.TextSize = 20
SettingsTitle.Font = Enum.Font.GothamBold
SettingsTitle.TextXAlignment = Enum.TextXAlignment.Left
SettingsTitle.Parent = SettingsFrame

-- è¿”å›æŒ‰é’®
local BackButton = Instance.new("TextButton")
BackButton.Name = "BackButton"
BackButton.Size = UDim2.new(0, 100, 0, 35)
BackButton.Position = UDim2.new(0, 15, 0, 60)
BackButton.BackgroundColor3 = Color3.fromRGB(65, 65, 90)
BackButton.Text = "â† è¿”å›"
BackButton.TextColor3 = Color3.fromRGB(255, 255, 255)
BackButton.TextSize = 16
BackButton.Font = Enum.Font.Gotham
BackButton.Parent = SettingsFrame

local BackCorner = Instance.new("UICorner")
BackCorner.CornerRadius = UDim.new(0, 8)
BackCorner.Parent = BackButton

-- äººè®¾è®¾ç½®
local PersonaLabel = Instance.new("TextLabel")
PersonaLabel.Name = "PersonaLabel"
PersonaLabel.Size = UDim2.new(1, -30, 0, 30)
PersonaLabel.Position = UDim2.new(0, 15, 0, 110)
PersonaLabel.BackgroundTransparency = 1
PersonaLabel.Text = "AIäººè®¾/æ€§æ ¼:"
PersonaLabel.TextColor3 = Color3.fromRGB(220, 220, 240)
PersonaLabel.TextSize = 16
PersonaLabel.Font = Enum.Font.Gotham
PersonaLabel.TextXAlignment = Enum.TextXAlignment.Left
PersonaLabel.Parent = SettingsFrame

local PersonaBox = Instance.new("TextBox")
PersonaBox.Name = "PersonaBox"
PersonaBox.Size = UDim2.new(1, -30, 0, 100)
PersonaBox.Position = UDim2.new(0, 15, 0, 150)
PersonaBox.BackgroundColor3 = Color3.fromRGB(45, 45, 60)
PersonaBox.TextColor3 = Color3.fromRGB(255, 255, 255)
PersonaBox.TextSize = 14
PersonaBox.Font = Enum.Font.Gotham
PersonaBox.PlaceholderText = "ä¾‹å¦‚: ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€å¹½é»˜çš„AIåŠ©æ‰‹ï¼Œä¹äºåŠ©äººä¸”çŸ¥è¯†æ¸Šåšã€‚ä½ çš„å›ç­”åº”è¯¥ç®€æ´æ˜äº†ï¼Œå¶å°”å¯ä»¥å¼€ä¸ªç©ç¬‘ã€‚"
PersonaBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 170)
PersonaBox.TextXAlignment = Enum.TextXAlignment.Left
PersonaBox.TextYAlignment = Enum.TextYAlignment.Top
PersonaBox.TextWrapped = true
PersonaBox.ClearTextOnFocus = false
PersonaBox.Parent = SettingsFrame

local PersonaCorner = Instance.new("UICorner")
PersonaCorner.CornerRadius = UDim.new(0, 8)
PersonaCorner.Parent = PersonaBox

-- è‡ªåŠ¨å­˜æ¡£å¼€å…³
local AutoSaveLabel = Instance.new("TextLabel")
AutoSaveLabel.Name = "AutoSaveLabel"
AutoSaveLabel.Size = UDim2.new(1, -30, 0, 30)
AutoSaveLabel.Position = UDim2.new(0, 15, 0, 260)
AutoSaveLabel.BackgroundTransparency = 1
AutoSaveLabel.Text = "è‡ªåŠ¨å­˜æ¡£èŠå¤©è®°å½•:"
AutoSaveLabel.TextColor3 = Color3.fromRGB(220, 220, 240)
AutoSaveLabel.TextSize = 16
AutoSaveLabel.Font = Enum.Font.Gotham
AutoSaveLabel.TextXAlignment = Enum.TextXAlignment.Left
AutoSaveLabel.Parent = SettingsFrame

local AutoSaveToggle = Instance.new("TextButton")
AutoSaveToggle.Name = "AutoSaveToggle"
AutoSaveToggle.Size = UDim2.new(0, 60, 0, 30)
AutoSaveToggle.Position = UDim2.new(1, -75, 0, 260)
AutoSaveToggle.AnchorPoint = Vector2.new(1, 0)
AutoSaveToggle.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
AutoSaveToggle.Text = "å¼€å¯"
AutoSaveToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
AutoSaveToggle.TextSize = 14
AutoSaveToggle.Font = Enum.Font.GothamBold
AutoSaveToggle.Parent = SettingsFrame

local ToggleCorner2 = Instance.new("UICorner")
ToggleCorner2.CornerRadius = UDim.new(0, 6)
ToggleCorner2.Parent = AutoSaveToggle

-- åŒ–èº«AIå¼€å…³
local PersonaAILabel = Instance.new("TextLabel")
PersonaAILabel.Name = "PersonaAILabel"
PersonaAILabel.Size = UDim2.new(1, -30, 0, 30)
PersonaAILabel.Position = UDim2.new(0, 15, 0, 300)
PersonaAILabel.BackgroundTransparency = 1
PersonaAILabel.Text = "åŒ–èº«AI(åœ¨èŠå¤©æ å‘è¨€):"
PersonaAILabel.TextColor3 = Color3.fromRGB(220, 220, 240)
PersonaAILabel.TextSize = 16
PersonaAILabel.Font = Enum.Font.Gotham
PersonaAILabel.TextXAlignment = Enum.TextXAlignment.Left
PersonaAILabel.Parent = SettingsFrame

local PersonaAIToggle = Instance.new("TextButton")
PersonaAIToggle.Name = "PersonaAIToggle"
PersonaAIToggle.Size = UDim2.new(0, 60, 0, 30)
PersonaAIToggle.Position = UDim2.new(1, -75, 0, 300)
PersonaAIToggle.AnchorPoint = Vector2.new(1, 0)
PersonaAIToggle.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
PersonaAIToggle.Text = "å…³é—­"
PersonaAIToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
PersonaAIToggle.TextSize = 14
PersonaAIToggle.Font = Enum.Font.GothamBold
PersonaAIToggle.Parent = SettingsFrame

local ToggleCorner3 = Instance.new("UICorner")
ToggleCorner3.CornerRadius = UDim.new(0, 6)
ToggleCorner3.Parent = PersonaAIToggle

-- APIçŠ¶æ€æ˜¾ç¤º
local ApiStatusLabel = Instance.new("TextLabel")
ApiStatusLabel.Name = "ApiStatusLabel"
ApiStatusLabel.Size = UDim2.new(1, -30, 0, 30)
ApiStatusLabel.Position = UDim2.new(0, 15, 0, 340)
ApiStatusLabel.BackgroundTransparency = 1
ApiStatusLabel.Text = "APIçŠ¶æ€: å·²è¿æ¥ (å…è´¹)"
ApiStatusLabel.TextColor3 = Color3.fromRGB(0, 200, 100)
ApiStatusLabel.TextSize = 14
ApiStatusLabel.Font = Enum.Font.Gotham
ApiStatusLabel.TextXAlignment = Enum.TextXAlignment.Left
ApiStatusLabel.Parent = SettingsFrame

-- æ¸…ç©ºè®°å½•æŒ‰é’®
local ClearHistoryButton = Instance.new("TextButton")
ClearHistoryButton.Name = "ClearHistoryButton"
ClearHistoryButton.Size = UDim2.new(0.5, -20, 0, 40)
ClearHistoryButton.Position = UDim2.new(0, 15, 1, -110)
ClearHistoryButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
ClearHistoryButton.Text = "ğŸ—‘ï¸ æ¸…ç©ºè®°å½•"
ClearHistoryButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ClearHistoryButton.TextSize = 16
ClearHistoryButton.Font = Enum.Font.Gotham
ClearHistoryButton.Parent = SettingsFrame

local ClearCorner = Instance.new("UICorner")
ClearCorner.CornerRadius = UDim.new(0, 8)
ClearCorner.Parent = ClearHistoryButton

-- å¯¼å‡ºè®°å½•æŒ‰é’®
local ExportButton = Instance.new("TextButton")
ExportButton.Name = "ExportButton"
ExportButton.Size = UDim2.new(0.5, -20, 0, 40)
ExportButton.Position = UDim2.new(0.5, 5, 1, -110)
ExportButton.BackgroundColor3 = Color3.fromRGB(60, 100, 180)
ExportButton.Text = "ğŸ“¥ å¯¼å‡ºè®°å½•"
ExportButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ExportButton.TextSize = 16
ExportButton.Font = Enum.Font.Gotham
ExportButton.Parent = SettingsFrame

local ExportCorner = Instance.new("UICorner")
ExportCorner.CornerRadius = UDim.new(0, 8)
ExportCorner.Parent = ExportButton

-- ä¿å­˜è®¾ç½®æŒ‰é’®
local SaveSettingsButton = Instance.new("TextButton")
SaveSettingsButton.Name = "SaveSettingsButton"
SaveSettingsButton.Size = UDim2.new(1, -30, 0, 45)
SaveSettingsButton.Position = UDim2.new(0, 15, 1, -55)
SaveSettingsButton.BackgroundColor3 = Color3.fromRGB(0, 140, 255)
SaveSettingsButton.Text = "ğŸ’¾ ä¿å­˜è®¾ç½®"
SaveSettingsButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SaveSettingsButton.TextSize = 18
SaveSettingsButton.Font = Enum.Font.GothamBold
SaveSettingsButton.Parent = SettingsFrame

local SaveCorner = Instance.new("UICorner")
SaveCorner.CornerRadius = UDim.new(0, 8)
SaveCorner.Parent = SaveSettingsButton

-- èŠå¤©è®°å½•å­˜å‚¨
local ChatHistory = {}
local Settings = {
    Persona = "ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€å¹½é»˜çš„AIåŠ©æ‰‹ï¼Œä¹äºåŠ©äººä¸”çŸ¥è¯†æ¸Šåšã€‚ä½ çš„å›ç­”åº”è¯¥ç®€æ´æ˜äº†ï¼Œå¶å°”å¯ä»¥å¼€ä¸ªç©ç¬‘ã€‚",
    AutoSave = true,
    PersonaAI = false
}

-- çŠ¶æ€å˜é‡
local isMinimized = false
local isSettingsOpen = false
local originalSize = MainFrame.Size
local minimizedSize = UDim2.new(0, 50, 0, 50)
local originalPosition = MainFrame.Position
local minimizedPosition = UDim2.new(0, 20, 1, -60)
local isProcessing = false
local isThinking = false

-- å…è´¹AI APIæ¥å£ - ä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„API
local FREE_AI_API = "https://api.suol.cc/v1/ai.php"

-- æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
local function addMessage(sender, message, isAI, isSystem)
    local messageFrame = Instance.new("Frame")
    messageFrame.Name = "MessageFrame"
    messageFrame.Size = UDim2.new(1, 0, 0, 0)
    messageFrame.BackgroundTransparency = 1
    messageFrame.LayoutOrder = #ChatHistory + 1
    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    messageFrame.Parent = ChatScrollingFrame
    
    local messageBubble = Instance.new("Frame")
    messageBubble.Name = "MessageBubble"
    
    if isSystem then
        messageBubble.Size = UDim2.new(1, 0, 0, 0)
        messageBubble.BackgroundColor3 = Color3.fromRGB(70, 70, 90)
    elseif isAI then
        messageBubble.Size = UDim2.new(0.8, 0, 0, 0)
        messageBubble.BackgroundColor3 = Color3.fromRGB(60, 70, 100)
    else
        messageBubble.Size = UDim2.new(0.8, 0, 0, 0)
        messageBubble.BackgroundColor3 = Color3.fromRGB(80, 100, 60)
    end
    
    messageBubble.AutomaticSize = Enum.AutomaticSize.Y
    
    if isSystem then
        messageBubble.AnchorPoint = Vector2.new(0.5, 0)
        messageBubble.Position = UDim2.new(0.5, 0, 0, 0)
    elseif isAI then
        messageBubble.AnchorPoint = Vector2.new(0, 0)
        messageBubble.Position = UDim2.new(0, 0, 0, 0)
    else
        messageBubble.AnchorPoint = Vector2.new(1, 0)
        messageBubble.Position = UDim2.new(1, 0, 0, 0)
    end
    
    local bubbleCorner = Instance.new("UICorner")
    bubbleCorner.CornerRadius = UDim.new(0, 12)
    bubbleCorner.Parent = messageBubble
    
    local messagePadding = Instance.new("UIPadding")
    messagePadding.PaddingTop = UDim.new(0, 10)
    messagePadding.PaddingBottom = UDim.new(0, 10)
    messagePadding.PaddingLeft = UDim.new(0, 15)
    messagePadding.PaddingRight = UDim.new(0, 15)
    messagePadding.Parent = messageBubble
    
    local senderLabel = Instance.new("TextLabel")
    senderLabel.Name = "SenderLabel"
    senderLabel.Size = UDim2.new(1, 0, 0, 20)
    senderLabel.BackgroundTransparency = 1
    senderLabel.Text = sender
    senderLabel.TextColor3 = Color3.fromRGB(240, 240, 240)
    senderLabel.TextSize = 12
    senderLabel.Font = Enum.Font.GothamBold
    senderLabel.TextXAlignment = Enum.TextXAlignment.Left
    senderLabel.Parent = messageBubble
    
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Name = "MessageLabel"
    messageLabel.Size = UDim2.new(1, 0, 0, 0)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Text = message
    messageLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    messageLabel.TextSize = 16
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.TextYAlignment = Enum.TextYAlignment.Top
    messageLabel.TextWrapped = true
    messageLabel.AutomaticSize = Enum.AutomaticSize.Y
    messageLabel.Parent = messageBubble
    
    -- å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œæ·»åŠ å¤åˆ¶æŒ‰é’®
    if isAI and not isSystem then
        local copyButton = Instance.new("TextButton")
        copyButton.Name = "CopyButton"
        copyButton.Size = UDim2.new(0, 40, 0, 25)
        copyButton.Position = UDim2.new(1, 5, 0, 0)
        copyButton.BackgroundColor3 = Color3.fromRGB(80, 80, 110)
        copyButton.Text = "å¤åˆ¶"
        copyButton.TextColor3 = Color3.fromRGB(200, 200, 200)
        copyButton.TextSize = 11
        copyButton.Font = Enum.Font.Gotham
        copyButton.Parent = messageFrame
        
        local copyCorner = Instance.new("UICorner")
        copyCorner.CornerRadius = UDim.new(0, 4)
        copyCorner.Parent = copyButton
        
        copyButton.MouseButton1Click:Connect(function()
            pcall(function()
                setclipboard(message)
                copyButton.Text = "å·²å¤åˆ¶!"
                copyButton.BackgroundColor3 = Color3.fromRGB(60, 150, 60)
                
                wait(1.5)
                copyButton.Text = "å¤åˆ¶"
                copyButton.BackgroundColor3 = Color3.fromRGB(80, 80, 110)
            end)
        end)
    end
    
    -- æ»šåŠ¨åˆ°åº•éƒ¨
    wait()
    ChatScrollingFrame.CanvasPosition = Vector2.new(0, ChatScrollingFrame.AbsoluteCanvasSize.Y)
    
    return messageFrame
end

-- è°ƒç”¨å…è´¹AI API
local function callFreeAIAPI(prompt, persona)
    -- æ„å»ºè¯·æ±‚æ¶ˆæ¯ï¼ŒåŒ…å«äººè®¾å’Œç”¨æˆ·è¾“å…¥
    local fullPrompt = persona .. "\n\nç”¨æˆ·: " .. prompt .. "\nAI:"
    
    -- ä½¿ç”¨å…è´¹API (api.suol.cc)
    local success, response = pcall(function()
        -- å°è¯•ä½¿ç”¨GETè¯·æ±‚
        local encodedPrompt = string.gsub(fullPrompt, " ", "%%20")
        local url = FREE_AI_API .. "?msg=" .. encodedPrompt
        
        -- å‘é€HTTPè¯·æ±‚
        local httpResponse = HttpService:GetAsync(url, true)
        return httpResponse
    end)
    
    if success and response then
        -- æ¸…ç†å“åº”æ–‡æœ¬
        local cleanedResponse = string.gsub(response, "^%s+", "")
        cleanedResponse = string.gsub(cleanedResponse, "%s+$", "")
        
        -- æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
        if cleanedResponse and cleanedResponse ~= "" and string.len(cleanedResponse) > 5 then
            return cleanedResponse
        end
    end
    
    -- å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨å›å¤
    local fallbackResponses = {
        "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ä½ èŠå¤©ï¼",
        "è¿™æ˜¯ä¸€ä¸ªæœ‰è¶£çš„è¯é¢˜ï¼è®©æˆ‘æƒ³æƒ³...",
        "æ ¹æ®æˆ‘çš„ç†è§£ï¼Œä½ é—®çš„æ˜¯å…³äº" .. string.sub(prompt, 1, 20) .. "...",
        "æˆ‘æ˜ç™½äº†ã€‚è¿™ç¡®å®æ˜¯ä¸€ä¸ªå€¼å¾—æ¢è®¨çš„é—®é¢˜ã€‚",
        "æ„Ÿè°¢ä½ çš„æé—®ï¼æˆ‘ä¼šå°½åŠ›æä¾›æœ‰ç”¨çš„ä¿¡æ¯ã€‚",
        "åœ¨Robloxä¸­èŠå¤©çœŸæ˜¯æœ‰è¶£ï¼ä½ ç»å¸¸ç©ä»€ä¹ˆæ¸¸æˆï¼Ÿ",
        "ä½œä¸ºAIï¼Œæˆ‘å¯ä»¥å¸®ä½ è§£ç­”å¾ˆå¤šé—®é¢˜ï¼Œå°½ç®¡é—®å§ï¼",
        "ä½ çš„é—®é¢˜å¾ˆæœ‰æ·±åº¦ï¼Œè®©æˆ‘ä»”ç»†æ€è€ƒä¸€ä¸‹å¦‚ä½•å›ç­”ã€‚",
        "å—¯...è®©æˆ‘æƒ³æƒ³æ€ä¹ˆå›ç­”æœ€å¥½ã€‚",
        "æœ‰è¶£çš„é—®é¢˜ï¼æˆ‘çš„å›ç­”æ˜¯ï¼šåœ¨Robloxä¸­ï¼Œåˆ›é€ åŠ›æ˜¯æ— é™çš„ï¼"
    }
    
    -- æ ¹æ®äººè®¾è°ƒæ•´å›å¤
    if string.find(persona:lower(), "å¹½é»˜") or string.find(persona:lower(), "æç¬‘") then
        table.insert(fallbackResponses, "å“ˆå“ˆï¼Œè¿™ä¸ªé—®é¢˜æœ‰æ„æ€ï¼è®©æˆ‘ç”¨å¹½é»˜çš„æ–¹å¼å›ç­”ä½ ...")
        table.insert(fallbackResponses, "ğŸ˜„ ä½œä¸ºä¸€ä¸ªå¹½é»˜çš„AIï¼Œæˆ‘å¾—è¯´ï¼š" .. prompt .. " è¿™ä¸ªé—®é¢˜è®©æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªç¬‘è¯ï¼")
    end
    
    if string.find(persona:lower(), "çŸ¥è¯†") or string.find(persona:lower(), "ä¸“ä¸š") then
        table.insert(fallbackResponses, "ä»ä¸“ä¸šè§’åº¦æ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜æ¶‰åŠåˆ°å‡ ä¸ªå…³é”®ç‚¹...")
        table.insert(fallbackResponses, "æ ¹æ®æˆ‘çš„çŸ¥è¯†åº“ï¼Œå…³äº" .. string.sub(prompt, 1, 15) .. "çš„ä¿¡æ¯æ˜¯...")
    end
    
    return fallbackResponses[math.random(1, #fallbackResponses)]
end

-- å¤„ç†ç”¨æˆ·æ¶ˆæ¯
local function processUserMessage(message)
    if isProcessing or message == "" or message == nil then
        return
    end
    
    isProcessing = true
    
    -- æ·»åŠ åˆ°èŠå¤©è®°å½•
    table.insert(ChatHistory, {
        sender = "ä½ ",
        message = message,
        isAI = false,
        timestamp = os.time()
    })
    
    addMessage("ä½ ", message, false, false)
    
    -- æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
    local thinkingFrame = addMessage("AI", "æ­£åœ¨æ€è€ƒ...", true, false)
    isThinking = true
    
    -- åœ¨åå°è°ƒç”¨AI API
    spawn(function()
        local aiMessage = callFreeAIAPI(message, Settings.Persona)
        
        -- ç§»é™¤"æ­£åœ¨æ€è€ƒ"æ¶ˆæ¯
        if thinkingFrame and thinkingFrame.Parent then
            thinkingFrame:Destroy()
        end
        isThinking = false
        
        -- æ·»åŠ AIå“åº”
        table.insert(ChatHistory, {
            sender = "AI",
            message = aiMessage,
            isAI = true,
            timestamp = os.time()
        })
        
        addMessage("AI", aiMessage, true, false)
        
        -- å¦‚æœå¼€å¯åŒ–èº«AIåŠŸèƒ½ï¼Œåˆ™åœ¨èŠå¤©æ å‘è¨€
        if Settings.PersonaAI then
            local chatService = game:GetService("TextChatService")
            if chatService and chatService.TextChannels then
                local channel = chatService.TextChannels.RBXGeneral
                if channel then
                    local success, err = pcall(function()
                        channel:SendAsync("[AIåŠ©æ‰‹]: " .. aiMessage)
                    end)
                    
                    if not success then
                        addMessage("ç³»ç»Ÿ", "æ— æ³•åœ¨èŠå¤©æ å‘è¨€: " .. tostring(err), false, true)
                    end
                end
            end
        end
        
        -- è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        if Settings.AutoSave then
            saveChatHistoryToLocal()
        end
        
        isProcessing = false
    end)
end

-- ä¿å­˜èŠå¤©è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
local function saveChatHistoryToLocal()
    local success, error = pcall(function()
        -- ä½¿ç”¨Robloxçš„DataStoreServiceä¿å­˜æ•°æ®
        local DataStoreService = game:GetService("DataStoreService")
        local ChatDataStore = DataStoreService:GetDataStore("AIChatHistory_" .. tostring(Player.UserId))
        ChatDataStore:SetAsync("history", ChatHistory)
    end)
    
    if not success then
        -- å¦‚æœDataStoreå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨æœ¬åœ°å­˜å‚¨
        pcall(function()
            local jsonData = HttpService:JSONEncode(ChatHistory)
            -- è¿™é‡Œå¯ä»¥æ·»åŠ æœ¬åœ°å­˜å‚¨é€»è¾‘
        end)
    end
end

-- åŠ è½½èŠå¤©è®°å½•ä»æœ¬åœ°å­˜å‚¨
local function loadChatHistoryFromLocal()
    local success, data = pcall(function()
        local DataStoreService = game:GetService("DataStoreService")
        local ChatDataStore = DataStoreService:GetDataStore("AIChatHistory_" .. tostring(Player.UserId))
        return ChatDataStore:GetAsync("history")
    end)
    
    if success and data then
        ChatHistory = data
        
        -- æ¸…ç©ºç°æœ‰èŠå¤©æ˜¾ç¤º
        for _, child in ipairs(ChatScrollingFrame:GetChildren()) do
            if child:IsA("Frame") and child.Name == "MessageFrame" then
                child:Destroy()
            end
        end
        
        -- é‡æ–°åŠ è½½æ¶ˆæ¯
        for _, msg in ipairs(ChatHistory) do
            addMessage(msg.sender, msg.message, msg.isAI, false)
        end
        
        return true
    end
    
    return false
end

-- ä¿å­˜è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
local function saveSettingsToLocal()
    local success, error = pcall(function()
        local DataStoreService = game:GetService("DataStoreService")
        local SettingsDataStore = DataStoreService:GetDataStore("AISettings_" .. tostring(Player.UserId))
        SettingsDataStore:SetAsync("settings", Settings)
    end)
    
    return success
end

-- åŠ è½½è®¾ç½®ä»æœ¬åœ°å­˜å‚¨
local function loadSettingsFromLocal()
    local success, data = pcall(function()
        local DataStoreService = game:GetService("DataStoreService")
        local SettingsDataStore = DataStoreService:GetDataStore("AISettings_" .. tostring(Player.UserId))
        return SettingsDataStore:GetAsync("settings")
    end)
    
    if success and data then
        Settings = data
        
        -- åº”ç”¨è®¾ç½®åˆ°UI
        PersonaBox.Text = Settings.Persona
        
        if Settings.AutoSave then
            AutoSaveToggle.Text = "å¼€å¯"
            AutoSaveToggle.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        else
            AutoSaveToggle.Text = "å…³é—­"
            AutoSaveToggle.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
        end
        
        if Settings.PersonaAI then
            PersonaAIToggle.Text = "å¼€å¯"
            PersonaAIToggle.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        else
            PersonaAIToggle.Text = "å…³é—­"
            PersonaAIToggle.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
        end
        
        return true
    end
    
    return false
end

-- æ¸…ç©ºèŠå¤©è®°å½•
local function clearChatHistory()
    ChatHistory = {}
    
    -- æ¸…ç©ºæ˜¾ç¤º
    for _, child in ipairs(ChatScrollingFrame:GetChildren()) do
        if child:IsA("Frame") and child.Name == "MessageFrame" then
            child:Destroy()
        end
    end
    
    -- æ·»åŠ æ¬¢è¿æ¶ˆæ¯
    table.insert(ChatHistory, {
        sender = "AI",
        message = "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ",
        isAI = true,
        timestamp = os.time()
    })
    
    addMessage("AI", "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ", true, false)
    
    -- ä¿å­˜
    if Settings.AutoSave then
        saveChatHistoryToLocal()
    end
    
    addMessage("ç³»ç»Ÿ", "èŠå¤©è®°å½•å·²æ¸…ç©º", false, true)
end

-- å¯¼å‡ºèŠå¤©è®°å½•
local function exportChatHistory()
    local exportText = "=== Roblox AIèŠå¤©è®°å½•å¯¼å‡º ===\n"
    exportText = exportText .. "å¯¼å‡ºæ—¶é—´: " .. os.date("%Y-%m-%d %H:%M:%S") .. "\n"
    exportText = exportText .. "è®°å½•æ¡æ•°: " .. tostring(#ChatHistory) .. "\n"
    exportText = exportText .. "AIäººè®¾: " .. Settings.Persona .. "\n"
    exportText = exportText .. "====================\n\n"
    
    for i, msg in ipairs(ChatHistory) do
        local timeStr = os.date("%H:%M", msg.timestamp)
        exportText = exportText .. "[" .. timeStr .. "] " .. msg.sender .. ": " .. msg.message .. "\n"
    end
    
    -- å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿
    local success = pcall(function()
        setclipboard(exportText)
    end)
    
    if success then
        addMessage("ç³»ç»Ÿ", "èŠå¤©è®°å½•å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼", false, true)
    else
        addMessage("ç³»ç»Ÿ", "æ— æ³•å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ä¿å­˜ä»¥ä¸‹æ–‡æœ¬ï¼š\n\n" .. string.sub(exportText, 1, 500) .. "...", false, true)
    end
end

-- åˆ‡æ¢ç•Œé¢æœ€å°åŒ–
ToggleButton.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    
    if isMinimized then
        MainFrame:TweenSize(minimizedSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        MainFrame:TweenPosition(minimizedPosition, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        ToggleButton.Text = "+"
    else
        MainFrame:TweenSize(originalSize, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        MainFrame:TweenPosition(originalPosition, Enum.EasingDirection.Out, Enum.EasingStyle.Quad, 0.3, true)
        ToggleButton.Text = "â€”"
    end
end)

-- å‘é€æ¶ˆæ¯
SendButton.MouseButton1Click:Connect(function()
    local message = InputBox.Text
    if message and string.gsub(message, "%s+", "") ~= "" then
        InputBox.Text = ""
        processUserMessage(message)
    end
end)

-- æŒ‰Enterå‘é€æ¶ˆæ¯
InputBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then
        local message = InputBox.Text
        if message and string.gsub(message, "%s+", "") ~= "" then
            InputBox.Text = ""
            processUserMessage(message)
        end
    end
end)

-- æ‰“å¼€è®¾ç½®
SettingsButton.MouseButton1Click:Connect(function()
    isSettingsOpen = true
    MainFrame.Visible = false
    SettingsFrame.Visible = true
end)

-- è¿”å›èŠå¤©ç•Œé¢
BackButton.MouseButton1Click:Connect(function()
    isSettingsOpen = false
    SettingsFrame.Visible = false
    MainFrame.Visible = true
end)

-- åˆ‡æ¢è‡ªåŠ¨å­˜æ¡£
AutoSaveToggle.MouseButton1Click:Connect(function()
    Settings.AutoSave = not Settings.AutoSave
    
    if Settings.AutoSave then
        AutoSaveToggle.Text = "å¼€å¯"
        AutoSaveToggle.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        
        -- ç«‹å³ä¿å­˜ä¸€æ¬¡
        saveChatHistoryToLocal()
        addMessage("ç³»ç»Ÿ", "è‡ªåŠ¨å­˜æ¡£å·²å¼€å¯", false, true)
    else
        AutoSaveToggle.Text = "å…³é—­"
        AutoSaveToggle.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
        addMessage("ç³»ç»Ÿ", "è‡ªåŠ¨å­˜æ¡£å·²å…³é—­", false, true)
    end
    
    saveSettingsToLocal()
end)

-- åˆ‡æ¢åŒ–èº«AI
PersonaAIToggle.MouseButton1Click:Connect(function()
    Settings.PersonaAI = not Settings.PersonaAI
    
    if Settings.PersonaAI then
        PersonaAIToggle.Text = "å¼€å¯"
        PersonaAIToggle.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        addMessage("ç³»ç»Ÿ", "åŒ–èº«AIåŠŸèƒ½å·²å¼€å¯ã€‚AIçš„å›å¤å°†åŒæ—¶å‘é€åˆ°æ¸¸æˆèŠå¤©æ ã€‚", false, true)
    else
        PersonaAIToggle.Text = "å…³é—­"
        PersonaAIToggle.BackgroundColor3 = Color3.fromRGB(120, 120, 120)
        addMessage("ç³»ç»Ÿ", "åŒ–èº«AIåŠŸèƒ½å·²å…³é—­ã€‚", false, true)
    end
    
    saveSettingsToLocal()
end)

-- æ¸…ç©ºèŠå¤©è®°å½•
ClearHistoryButton.MouseButton1Click:Connect(function()
    clearChatHistory()
end)

-- å¯¼å‡ºèŠå¤©è®°å½•
ExportButton.MouseButton1Click:Connect(function()
    exportChatHistory()
end)

-- ä¿å­˜è®¾ç½®
SaveSettingsButton.MouseButton1Click:Connect(function()
    Settings.Persona = PersonaBox.Text
    saveSettingsToLocal()
    
    -- è¿”å›èŠå¤©ç•Œé¢
    isSettingsOpen = false
    SettingsFrame.Visible = false
    MainFrame.Visible = true
    
    addMessage("ç³»ç»Ÿ", "è®¾ç½®å·²ä¿å­˜ã€‚AIäººè®¾å·²æ›´æ–°ã€‚", false, true)
end)

-- åˆå§‹åŒ–
loadSettingsFromLocal()

if not loadChatHistoryFromLocal() then
    -- å¦‚æœèŠå¤©è®°å½•ä¸ºç©ºï¼Œæ·»åŠ æ¬¢è¿æ¶ˆæ¯
    table.insert(ChatHistory, {
        sender = "AI",
        message = "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œä½¿ç”¨å…è´¹APIæœåŠ¡ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ",
        isAI = true,
        timestamp = os.time()
    })
    
    addMessage("AI", "ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œä½¿ç”¨å…è´¹APIæœåŠ¡ã€‚æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ", true, false)
    
    if Settings.AutoSave then
        saveChatHistoryToLocal()
    end
end

-- æ·»åŠ æ•™ç¨‹æ¶ˆæ¯
wait(2)
addMessage("ç³»ç»Ÿ", "ğŸ’¡ æç¤º: ç‚¹å‡»AIæ¶ˆæ¯æ—è¾¹çš„'å¤åˆ¶'æŒ‰é’®å¯ä»¥å¤åˆ¶æ–‡æœ¬ã€‚åœ¨è®¾ç½®ä¸­å¯ä»¥é…ç½®AIäººè®¾å’Œå¼€å¯è‡ªåŠ¨å­˜æ¡£ã€‚", false, true)
addMessage("ç³»ç»Ÿ", "ğŸ”— APIçŠ¶æ€: ä½¿ç”¨å…è´¹APIæ¥å£ (api.suol.cc)ï¼Œæ— éœ€å¯†é’¥ï¼Œæ— éœ€ç™»å½•", false, true)

-- è‡ªåŠ¨ä¿å­˜å®šæ—¶å™¨
if Settings.AutoSave then
    spawn(function()
        while true do
            wait(60) -- æ¯60ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡
            if Settings.AutoSave and #ChatHistory > 0 then
                saveChatHistoryToLocal()
            end
        end
    end)
end

-- ç›‘å¬æ¸¸æˆèŠå¤©æ æ¶ˆæ¯ï¼Œå®ç°åŒ–èº«AIåŠŸèƒ½
local function setupChatListener()
    if Settings.PersonaAI then
        -- å°è¯•ç›‘å¬æ¸¸æˆèŠå¤©æ 
        spawn(function()
            while true do
                wait(5) -- æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
                
                if Settings.PersonaAI then
                    -- è¿™é‡Œå¯ä»¥æ·»åŠ ç›‘å¬èŠå¤©æ çš„é€»è¾‘
                    -- æ³¨æ„ï¼šRobloxçš„èŠå¤©ç³»ç»Ÿå¯èƒ½éœ€è¦ç‰¹å®šçš„äº‹ä»¶ç›‘å¬
                end
            end
        end)
    end
end

-- å¯åŠ¨èŠå¤©ç›‘å¬
setupChatListener()

print("ğŸ¤– Roblox AIèŠå¤©ç³»ç»Ÿå·²åŠ è½½å®Œæˆ!")
print("ğŸ”— ä½¿ç”¨å…è´¹API: https://api.suol.cc/v1/ai.php")
print("ğŸ“± åŠŸèƒ½åˆ—è¡¨:")
print("  - å…è´¹AIèŠå¤©ï¼Œæ— éœ€å¯†é’¥ï¼Œæ— éœ€ç™»å½•")
print("  - å¯é…ç½®AIäººè®¾/æ€§æ ¼")
print("  - è‡ªåŠ¨å­˜æ¡£èŠå¤©è®°å½•")
print("  - å¤åˆ¶AIå›å¤åŠŸèƒ½")
print("  - åŒ–èº«AIåœ¨èŠå¤©æ å‘è¨€")
print("  - èŠå¤©è®°å½•å¯¼å‡ºåŠŸèƒ½")

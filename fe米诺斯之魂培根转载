-- AIèŠå¤©ç³»ç»Ÿå®¢æˆ·ç«¯è„šæœ¬
-- æ”¾åœ¨StarterGuiæˆ–PlayerGuiä¸­

local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

-- åˆ›å»ºä¸»UI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AIChatUI"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 400, 0, 500)
MainFrame.Position = UDim2.new(0.5, -200, 0.5, -250)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true

-- æ ‡é¢˜æ ï¼ˆå¯æ‹–åŠ¨ï¼‰
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.fromRGB(45, 45, 55)
TitleBar.BorderSizePixel = 0

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "TitleLabel"
TitleLabel.Size = UDim2.new(1, -60, 1, 0)
TitleLabel.Position = UDim2.new(0, 10, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "AIåŠ©æ‰‹"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 14
TitleLabel.Font = Enum.Font.Gotham
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- æ§åˆ¶æŒ‰é’®
local MinimizeButton = Instance.new("TextButton")
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 30, 0, 30)
MinimizeButton.Position = UDim2.new(1, -60, 0, 0)
MinimizeButton.BackgroundTransparency = 1
MinimizeButton.Text = "_"
MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
MinimizeButton.TextSize = 16

local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -30, 0, 0)
CloseButton.BackgroundTransparency = 1
CloseButton.Text = "Ã—"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 20

-- èŠå¤©è®°å½•æ¡†
local ChatScroll = Instance.new("ScrollingFrame")
ChatScroll.Name = "ChatScroll"
ChatScroll.Size = UDim2.new(1, -20, 1, -120)
ChatScroll.Position = UDim2.new(0, 10, 0, 40)
ChatScroll.BackgroundTransparency = 1
ChatScroll.ScrollBarThickness = 6
ChatScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
ChatScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y

local ChatLayout = Instance.new("UIListLayout")
ChatLayout.Name = "ChatLayout"
ChatLayout.Padding = UDim.new(0, 10)

-- è¾“å…¥åŒºåŸŸ
local InputFrame = Instance.new("Frame")
InputFrame.Name = "InputFrame"
InputFrame.Size = UDim2.new(1, -20, 0, 50)
InputFrame.Position = UDim2.new(0, 10, 1, -60)
InputFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
InputFrame.BorderSizePixel = 0

local InputBox = Instance.new("TextBox")
InputBox.Name = "InputBox"
InputBox.Size = UDim2.new(1, -80, 1, -10)
InputBox.Position = UDim2.new(0, 10, 0, 5)
InputBox.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
InputBox.TextColor3 = Color3.fromRGB(255, 255, 255)
InputBox.TextSize = 14
InputBox.Font = Enum.Font.Gotham
InputBox.PlaceholderText = "è¾“å…¥æ¶ˆæ¯..."
InputBox.ClearTextOnFocus = false

local SendButton = Instance.new("TextButton")
SendButton.Name = "SendButton"
SendButton.Size = UDim2.new(0, 60, 1, -10)
SendButton.Position = UDim2.new(1, -70, 0, 5)
SendButton.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
SendButton.Text = "å‘é€"
SendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SendButton.TextSize = 14

-- åº•éƒ¨æ§åˆ¶æ 
local BottomBar = Instance.new("Frame")
BottomBar.Name = "BottomBar"
BottomBar.Size = UDim2.new(1, 0, 0, 30)
BottomBar.Position = UDim2.new(0, 0, 1, -30)
BottomBar.BackgroundColor3 = Color3.fromRGB(40, 40, 50)

local SettingsButton = Instance.new("TextButton")
SettingsButton.Name = "SettingsButton"
SettingsButton.Size = UDim2.new(0, 60, 1, 0)
SettingsButton.Position = UDim2.new(0, 10, 0, 0)
SettingsButton.BackgroundTransparency = 1
SettingsButton.Text = "è®¾ç½®"
SettingsButton.TextColor3 = Color3.fromRGB(200, 200, 200)

local PersonaButton = Instance.new("TextButton")
PersonaButton.Name = "PersonaButton"
PersonaButton.Size = UDim2.new(0, 100, 1, 0)
PersonaButton.Position = UDim2.new(0.5, -50, 0, 0)
PersonaButton.BackgroundTransparency = 1
PersonaButton.Text = "AIäººè®¾: åŠ©æ‰‹"
PersonaButton.TextColor3 = Color3.fromRGB(200, 200, 200)

local AiModeButton = Instance.new("TextButton")
AiModeButton.Name = "AiModeButton"
AiModeButton.Size = UDim2.new(0, 100, 1, 0)
AiModeButton.Position = UDim2.new(1, -110, 0, 0)
AiModeButton.BackgroundTransparency = 1
AiModeButton.Text = "AIæ¨¡å¼: å…³"
AiModeButton.TextColor3 = Color3.fromRGB(200, 200, 200)

-- è®¾ç½®é¢æ¿
local SettingsFrame = Instance.new("Frame")
SettingsFrame.Name = "SettingsFrame"
SettingsFrame.Size = UDim2.new(0, 300, 0, 300)
SettingsFrame.Position = UDim2.new(0.5, -150, 0.5, -150)
SettingsFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
SettingsFrame.BorderSizePixel = 0
SettingsFrame.Visible = false

-- ç»„è£…UI
TitleBar.Parent = MainFrame
TitleLabel.Parent = TitleBar
MinimizeButton.Parent = TitleBar
CloseButton.Parent = TitleBar
ChatScroll.Parent = MainFrame
ChatLayout.Parent = ChatScroll
InputFrame.Parent = MainFrame
InputBox.Parent = InputFrame
SendButton.Parent = InputFrame
BottomBar.Parent = MainFrame
SettingsButton.Parent = BottomBar
PersonaButton.Parent = BottomBar
AiModeButton.Parent = BottomBar
SettingsFrame.Parent = MainFrame
MainFrame.Parent = ScreenGui
ScreenGui.Parent = PlayerGui

-- èŠå¤©è®°å½•ç®¡ç†
local ChatHistory = {
    Messages = {},
    MaxMessages = 100
}

-- AIé…ç½®
local AIConfig = {
    CurrentPersona = "assistant", -- assistant, friend, teacher, etc.
    IsAiModeActive = false, -- åŒ–èº«AIæ¨¡å¼
    ResponseDelay = 0.5, -- AIå“åº”å»¶è¿Ÿ
    ThinkingPhrases = {"è®©æˆ‘æƒ³æƒ³...", "æ€è€ƒä¸­...", "æ­£åœ¨å¤„ç†..."}
}

-- AIäººè®¾é…ç½®
local Personas = {
    assistant = {
        name = "åŠ©æ‰‹",
        greeting = "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ",
        responses = {
            {pattern = "ä½ å¥½.*", response = "ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï¼"},
            {pattern = "è°¢è°¢.*", response = "ä¸å®¢æ°”ï¼æˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ ã€‚"},
            {pattern = "å†è§.*", response = "å†è§ï¼éœ€è¦å¸®åŠ©æ—¶éšæ—¶å«æˆ‘ã€‚"},
            {pattern = "ä½ å«ä»€ä¹ˆ.*", response = "æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œä¸“é—¨ä¸ºä½ æä¾›å¸®åŠ©ï¼"},
            {pattern = "å¸®åŠ©.*", response = "æˆ‘å¯ä»¥å¸®ä½ è§£ç­”é—®é¢˜ã€èŠå¤©ã€æä¾›å»ºè®®ç­‰ç­‰ã€‚è¯·å‘Šè¯‰æˆ‘ä½ éœ€è¦ä»€ä¹ˆå¸®åŠ©ï¼Ÿ"},
            {pattern = "å¤©æ°”.*", response = "ä½œä¸ºä¸€ä¸ªæœ¬åœ°AIï¼Œæˆ‘æ— æ³•è·å–å®æ—¶å¤©æ°”ï¼Œä½†ä½ å¯ä»¥æŸ¥çœ‹å¤©æ°”é¢„æŠ¥åº”ç”¨ã€‚"},
            {pattern = "æ—¶é—´.*", response = "å½“å‰æ¸¸æˆæ—¶é—´æ˜¯ %d:%dã€‚"},
            {pattern = "robux.*", response = "å…³äºRobuxçš„é—®é¢˜ï¼Œå»ºè®®æŸ¥çœ‹Robloxå®˜æ–¹å¸®åŠ©ä¸­å¿ƒã€‚"},
            {pattern = "è„šæœ¬.*", response = "æˆ‘å¯ä»¥å¸®ä½ ç¼–å†™ç®€å•çš„Luaè„šæœ¬ã€‚è¯·æè¿°ä½ æƒ³è¦å®ç°çš„åŠŸèƒ½ã€‚"},
            {pattern = "lua.*", response = "Luaæ˜¯ä¸€ç§è½»é‡çº§è„šæœ¬è¯­è¨€ã€‚Robloxä½¿ç”¨çš„æ˜¯ä¿®æ”¹ç‰ˆçš„Luaã€‚"},
            {pattern = "æ¸¸æˆ.*", response = "è¿™ä¸ªæ¸¸æˆçœ‹èµ·æ¥å¾ˆæœ‰è¶£ï¼ä½ åœ¨æ¢ç´¢ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿ"},
            {pattern = "æœ‹å‹.*", response = "å’Œæœ‹å‹ä¸€èµ·ç©æ€»æ˜¯æ›´æœ‰è¶£ï¼"},
            {pattern = "å¸®åŠ©æˆ‘.*", response = "æˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ ï¼è¯·è¯¦ç»†æè¿°ä½ çš„é—®é¢˜ã€‚"},
            {pattern = "æ€ä¹ˆ.*", response = "è®©æˆ‘æƒ³æƒ³æ€ä¹ˆå¸®ä½ è§£å†³è¿™ä¸ªé—®é¢˜..."},
            {pattern = "ä¸ºä»€ä¹ˆ.*", response = "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰è¶£ï¼Œè®©æˆ‘åˆ†æä¸€ä¸‹..."},
        },
        fallbackResponses = {
            "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ„æ€ï¼Œè®©æˆ‘æƒ³æƒ³...",
            "æˆ‘ä¸å¤ªç¡®å®šï¼Œä½†æˆ‘ä¼šå°½åŠ›å¸®åŠ©ä½ ï¼",
            "ä½ èƒ½æ¢ä¸ªæ–¹å¼å†é—®ä¸€æ¬¡å—ï¼Ÿ",
            "æˆ‘æ­£åœ¨å­¦ä¹ å¦‚ä½•æ›´å¥½åœ°å›ç­”è¿™ä¸ªé—®é¢˜ã€‚",
            "è®©æˆ‘ä»¬æ¢ä¸ªè¯é¢˜èŠèŠå…¶ä»–æœ‰è¶£çš„äº‹æƒ…å§ï¼"
        }
    },
    friend = {
        name = "æœ‹å‹",
        greeting = "å˜¿ï¼æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿæƒ³èŠç‚¹ä»€ä¹ˆå—ï¼Ÿ",
        responses = {
            {pattern = "ä½ å¥½.*", response = "å—¨ï¼æœ€è¿‘è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ"},
            {pattern = "ä¸é”™.*", response = "å¤ªå¥½äº†ï¼å¬åˆ°ä½ è¿‡å¾—ä¸é”™æˆ‘ä¹Ÿå¾ˆé«˜å…´ã€‚"},
            {pattern = "ä¸å¥½.*", response = "å¬åˆ°è¿™ä¸ªæˆ‘å¾ˆéš¾è¿‡ã€‚æƒ³èŠèŠå‘ç”Ÿäº†ä»€ä¹ˆå—ï¼Ÿ"},
            {pattern = "æ— èŠ.*", response = "æˆ‘ä¹Ÿæ˜¯ï¼æˆ‘ä»¬åšç‚¹æœ‰è¶£çš„äº‹æƒ…å§ï¼Ÿ"},
            {pattern = "æœ‰è¶£.*", response = "æ˜¯å•Šï¼æœ‰ä»€ä¹ˆç‰¹åˆ«æœ‰è¶£çš„äº‹æƒ…è¦åˆ†äº«å—ï¼Ÿ"},
        }
    },
    teacher = {
        name = "è€å¸ˆ",
        greeting = "ä½ å¥½ï¼Œå­¦ç”Ÿï¼ä»Šå¤©æƒ³å­¦ä¹ ä»€ä¹ˆçŸ¥è¯†ï¼Ÿ",
        responses = {
            {pattern = "æ•°å­¦.*", response = "æ•°å­¦æ˜¯ç§‘å­¦çš„åŸºç¡€ã€‚ä½ æƒ³äº†è§£å“ªä¸ªéƒ¨åˆ†ï¼Ÿ"},
            {pattern = "ç¼–ç¨‹.*", response = "ç¼–ç¨‹æ˜¯åˆ›é€ æ•°å­—ä¸–ç•Œçš„ç¥å¥‡æŠ€èƒ½ï¼"},
            {pattern = "é—®é¢˜.*", response = "å¥½é—®é¢˜ï¼è®©æˆ‘ä»¬ä¸€èµ·æ¢è®¨ç­”æ¡ˆã€‚"},
        }
    }
}

-- æ¶ˆæ¯æ¨¡æ¿
local function createMessageTemplate(isAI, sender, message)
    local messageFrame = Instance.new("Frame")
    messageFrame.Name = "MessageFrame"
    messageFrame.BackgroundTransparency = 1
    messageFrame.Size = UDim2.new(1, 0, 0, 0)
    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    
    local messageBubble = Instance.new("Frame")
    messageBubble.Name = "MessageBubble"
    messageBubble.BackgroundColor3 = isAI and Color3.fromRGB(60, 70, 90) or Color3.fromRGB(80, 90, 120)
    messageBubble.Size = UDim2.new(0.8, 0, 0, 0)
    messageBubble.Position = isAI and UDim2.new(0, 10, 0, 0) or UDim2.new(1, -10, 0, 0)
    messageBubble.AnchorPoint = isAI and Vector2.new(0, 0) or Vector2.new(1, 0)
    messageBubble.AutomaticSize = Enum.AutomaticSize.XY
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 10)
    corner.Parent = messageBubble
    
    local senderLabel = Instance.new("TextLabel")
    senderLabel.Name = "SenderLabel"
    senderLabel.Size = UDim2.new(1, -10, 0, 20)
    senderLabel.Position = UDim2.new(0, 5, 0, 5)
    senderLabel.BackgroundTransparency = 1
    senderLabel.Text = sender
    senderLabel.TextColor3 = isAI and Color3.fromRGB(180, 220, 255) or Color3.fromRGB(255, 220, 180)
    senderLabel.TextSize = 12
    senderLabel.Font = Enum.Font.GothamMedium
    senderLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Name = "MessageLabel"
    messageLabel.Size = UDim2.new(1, -10, 0, 0)
    messageLabel.Position = UDim2.new(0, 5, 0, 25)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Text = message
    messageLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    messageLabel.TextSize = 14
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextWrapped = true
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.AutomaticSize = Enum.AutomaticSize.Y
    
    local copyButton = Instance.new("TextButton")
    copyButton.Name = "CopyButton"
    copyButton.Size = UDim2.new(0, 30, 0, 20)
    copyButton.Position = UDim2.new(1, -35, 0, 5)
    copyButton.BackgroundTransparency = 1
    copyButton.Text = "ğŸ“‹"
    copyButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    copyButton.TextSize = 12
    copyButton.Visible = isAI
    
    -- ç»„è£…
    senderLabel.Parent = messageBubble
    messageLabel.Parent = messageBubble
    copyButton.Parent = messageBubble
    messageBubble.Parent = messageFrame
    
    return messageFrame
end

-- æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
local function addMessageToChat(isAI, sender, message)
    -- ä¿å­˜åˆ°å†å²è®°å½•
    table.insert(ChatHistory.Messages, {
        isAI = isAI,
        sender = sender,
        message = message,
        timestamp = os.time()
    })
    
    -- é™åˆ¶å†å²è®°å½•æ•°é‡
    if #ChatHistory.Messages > ChatHistory.MaxMessages then
        table.remove(ChatHistory.Messages, 1)
    end
    
    -- åˆ›å»ºUIæ¶ˆæ¯
    local messageUI = createMessageTemplate(isAI, sender, message)
    messageUI.Parent = ChatScroll
    
    -- æ»šåŠ¨åˆ°åº•éƒ¨
    task.wait()
    ChatScroll.CanvasPosition = Vector2.new(0, ChatScroll.CanvasSize.Y.Offset)
    
    -- è‡ªåŠ¨ä¿å­˜èŠå¤©è®°å½•
    saveChatHistory()
end

-- ä¿å­˜èŠå¤©è®°å½•
local function saveChatHistory()
    local success, message = pcall(function()
        local dataStore = game:GetService("DataStoreService"):GetDataStore("AIChatHistory_" .. Player.UserId)
        dataStore:SetAsync("history", ChatHistory.Messages)
    end)
    
    if not success then
        warn("ä¿å­˜èŠå¤©è®°å½•å¤±è´¥: " .. message)
    end
end

-- åŠ è½½èŠå¤©è®°å½•
local function loadChatHistory()
    local success, result = pcall(function()
        local dataStore = game:GetService("DataStoreService"):GetDataStore("AIChatHistory_" .. Player.UserId)
        return dataStore:GetAsync("history")
    end)
    
    if success and result then
        ChatHistory.Messages = result
        -- é‡æ–°æ¸²æŸ“æ¶ˆæ¯
        for _, msg in ipairs(ChatHistory.Messages) do
            createMessageTemplate(msg.isAI, msg.sender, msg.message).Parent = ChatScroll
        end
    end
end

-- AIå“åº”å‡½æ•°ï¼ˆæ¨¡æ‹Ÿæ™ºèƒ½ï¼‰
local function getAIResponse(input)
    local persona = Personas[AIConfig.CurrentPersona]
    if not persona then return "æŠ±æ­‰ï¼Œæˆ‘è¿˜æ²¡æœ‰å­¦ä¼šå›ç­”è¿™ä¸ªé—®é¢˜ã€‚" end
    
    local lowerInput = string.lower(input)
    
    -- æ£€æŸ¥åŒ¹é…æ¨¡å¼
    for _, patternData in ipairs(persona.responses) do
        if string.match(lowerInput, patternData.pattern) then
            local response = patternData.response
            
            -- å¤„ç†ç‰¹æ®Šå ä½ç¬¦
            if string.find(response, "%%d:%%d") then
                local time = os.date("*t")
                response = string.format("å½“å‰æ¸¸æˆæ—¶é—´æ˜¯ %d:%02dã€‚", time.hour, time.min)
            end
            
            return response
        end
    end
    
    -- å¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œä½¿ç”¨fallbackå›å¤
    local fallbackCount = #persona.fallbackResponses
    if fallbackCount > 0 then
        return persona.fallbackResponses[math.random(1, fallbackCount)]
    end
    
    return "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ„æ€ï¼Œæˆ‘æ­£åœ¨å­¦ä¹ ä¸­..."
end

-- å¤„ç†ç”¨æˆ·è¾“å…¥
local function processUserInput(input)
    if input == "" then return end
    
    -- æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    addMessageToChat(false, Player.Name, input)
    
    -- AIæ€è€ƒä¸­...
    local thinkingIndex = math.random(1, #AIConfig.ThinkingPhrases)
    addMessageToChat(true, Personas[AIConfig.CurrentPersona].name, AIConfig.ThinkingPhrases[thinkingIndex])
    
    -- æ¨¡æ‹ŸAIæ€è€ƒå»¶è¿Ÿ
    task.wait(AIConfig.ResponseDelay)
    
    -- è·å–AIå›å¤
    local aiResponse = getAIResponse(input)
    
    -- ç§»é™¤æ€è€ƒæ¶ˆæ¯
    if #ChatScroll:GetChildren() > 1 then
        local lastMessage = ChatScroll:GetChildren()[#ChatScroll:GetChildren()]
        if lastMessage:IsA("Frame") then
            lastMessage:Destroy()
        end
    end
    
    -- æ·»åŠ AIå›å¤
    addMessageToChat(true, Personas[AIConfig.CurrentPersona].name, aiResponse)
    
    -- å¦‚æœAIæ¨¡å¼å¼€å¯ï¼Œå°†å›å¤å‘é€åˆ°æ¸¸æˆèŠå¤©
    if AIConfig.IsAiModeActive then
        game:GetService("TextChatService").TextChannels.RBXGeneral:SendAsync(aiResponse)
    end
end

-- åˆ‡æ¢AIäººè®¾
local function switchPersona(personaKey)
    if Personas[personaKey] then
        AIConfig.CurrentPersona = personaKey
        PersonaButton.Text = "AIäººè®¾: " .. Personas[personaKey].name
        
        -- å‘é€é—®å€™è¯­
        task.wait(0.5)
        addMessageToChat(true, Personas[personaKey].name, Personas[personaKey].greeting)
    end
end

-- åˆå§‹åŒ–UIäº‹ä»¶
local function initUIEvents()
    -- çª—å£æ‹–åŠ¨
    local dragging = false
    local dragInput, dragStart, startPos
    
    TitleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = MainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    TitleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input == dragInput then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, 
                                          startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    
    -- æœ€å°åŒ–/æœ€å¤§åŒ–
    local isMinimized = false
    local originalSize = MainFrame.Size
    local minimizedSize = UDim2.new(0, 400, 0, 30)
    
    MinimizeButton.MouseButton1Click:Connect(function()
        isMinimized = not isMinimized
        
        local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad)
        local tween = TweenService:Create(MainFrame, tweenInfo, {
            Size = isMinimized and minimizedSize or originalSize
        })
        tween:Play()
        
        MinimizeButton.Text = isMinimized and "+" or "_"
    end)
    
    -- å…³é—­
    CloseButton.MouseButton1Click:Connect(function()
        ScreenGui.Enabled = false
    end)
    
    -- å‘é€æ¶ˆæ¯
    SendButton.MouseButton1Click:Connect(function()
        processUserInput(InputBox.Text)
        InputBox.Text = ""
    end)
    
    InputBox.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            processUserInput(InputBox.Text)
            InputBox.Text = ""
        end
    end)
    
    -- è®¾ç½®æŒ‰é’®
    SettingsButton.MouseButton1Click:Connect(function()
        SettingsFrame.Visible = not SettingsFrame.Visible
    end)
    
    -- AIäººè®¾åˆ‡æ¢
    PersonaButton.MouseButton1Click:Connect(function()
        local personas = {"assistant", "friend", "teacher"}
        local currentIndex = 1
        for i, key in ipairs(personas) do
            if key == AIConfig.CurrentPersona then
                currentIndex = i
                break
            end
        end
        
        local nextIndex = currentIndex % #personas + 1
        switchPersona(personas[nextIndex])
    end)
    
    -- AIæ¨¡å¼åˆ‡æ¢
    AiModeButton.MouseButton1Click:Connect(function()
        AIConfig.IsAiModeActive = not AIConfig.IsAiModeActive
        AiModeButton.Text = "AIæ¨¡å¼: " .. (AIConfig.IsAiModeActive and "å¼€" or "å…³")
        
        addMessageToChat(true, "ç³»ç»Ÿ", "åŒ–èº«AIæ¨¡å¼å·²" .. (AIConfig.IsAiModeActive and "å¼€å¯" or "å…³é—­"))
    end)
    
    -- å¤åˆ¶æ¶ˆæ¯åŠŸèƒ½
    ChatScroll.ChildAdded:Connect(function(child)
        task.wait()
        local copyButton = child:FindFirstChild("MessageBubble") and 
                          child.MessageBubble:FindFirstChild("CopyButton")
        if copyButton then
            copyButton.MouseButton1Click:Connect(function()
                local messageLabel = child.MessageBubble:FindFirstChild("MessageLabel")
                if messageLabel then
                    -- åœ¨Robloxä¸­å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
                    setclipboard(messageLabel.Text)
                    
                    -- æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                    local originalText = copyButton.Text
                    copyButton.Text = "âœ“"
                    task.wait(1)
                    copyButton.Text = originalText
                end
            end)
        end
    end)
end

-- é”®ç›˜å¿«æ·é”®æ‰“å¼€èŠå¤©
local function initKeyboardShortcut()
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        if input.KeyCode == Enum.KeyCode.F2 then
            ScreenGui.Enabled = not ScreenGui.Enabled
            
            if ScreenGui.Enabled then
                InputBox:CaptureFocus()
            end
        end
    end)
end

-- åˆå§‹åŒ–å‡½æ•°
local function init()
    -- åŠ è½½èŠå¤©å†å²
    loadChatHistory()
    
    -- åˆå§‹åŒ–UIäº‹ä»¶
    initUIEvents()
    
    -- åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®
    initKeyboardShortcut()
    
    -- å‘é€åˆå§‹é—®å€™
    task.wait(1)
    addMessageToChat(true, Personas[AIConfig.CurrentPersona].name, 
                    Personas[AIConfig.CurrentPersona].greeting)
    
    -- æ·»åŠ å¸®åŠ©æç¤º
    task.wait(2)
    addMessageToChat(true, "æç¤º", "æŒ‰F2å¯ä»¥å¿«é€Ÿæ‰“å¼€/å…³é—­èŠå¤©çª—å£")
    
    print("AIèŠå¤©ç³»ç»Ÿå·²åŠ è½½ï¼æŒ‰F2æ‰“å¼€èŠå¤©çª—å£ã€‚")
end

-- å¯åŠ¨åˆå§‹åŒ–
init()

return {
    SwitchPersona = switchPersona,
    AddMessage = addMessageToChat,
    ToggleAI = function()
        AIConfig.IsAiModeActive = not AIConfig.IsAiModeActive
        return AIConfig.IsAiModeActive
    end,
    SaveHistory = saveChatHistory,
    LoadHistory = loadChatHistory
}

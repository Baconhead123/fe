--[[
    坠落之神 Falling God - 直接控制版
    版本: 3.0
    功能: 直接控制玩家角色，不使用替身，所有动作可见
]]

-- 服务
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local Workspace = game:GetService("Workspace")

-- 玩家变量
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")
local currentCamera = Workspace.CurrentCamera

-- 配置
local Config = {
    WalkSpeed = 32,
    JumpPower = 75,
    MaxHealth = 1000,
    
    -- 技能配置
    Skills = {
        ["Falling Strike"] = {
            Cooldown = 6,
            Damage = 60,
            ManaCost = 25,
            Key = Enum.KeyCode.Q,
            Icon = "http://www.roblox.com/asset/?id=1234567890"
        },
        ["Void Chains"] = {
            Cooldown = 8,
            Damage = 40,
            ManaCost = 30,
            Key = Enum.KeyCode.E,
            Icon = "http://www.roblox.com/asset/?id=1234567891"
        },
        ["Gravity Wave"] = {
            Cooldown = 10,
            Damage = 50,
            ManaCost = 40,
            Key = Enum.KeyCode.R,
            Icon = "http://www.roblox.com/asset/?id=1234567892"
        },
        ["Abyss Rift"] = {
            Cooldown = 15,
            Damage = 80,
            ManaCost = 60,
            Key = Enum.KeyCode.F,
            Icon = "http://www.roblox.com/asset/?id=1234567893"
        }
    },
    
    -- 动画配置
    Animation = {
        IdleBreath = 0.5,  -- 呼吸起伏高度
        AttackRange = 8,   -- 攻击范围
        SkillRange = 15,   -- 技能范围
    }
}

-- 状态变量
local mana = 100
local maxMana = 100
local skillsOnCooldown = {}
local isAnimating = false
local isUsingSkill = false
local canAttack = true
local comboCount = 0
local lastAttackTime = 0

-- 获取肢体部分
local bodyParts = {}
local originalCFrames = {}

-- 初始化身体部位
local function InitializeBodyParts()
    bodyParts = {
        Head = character:FindFirstChild("Head"),
        Torso = character:FindFirstChild("UpperTorso") or character:FindFirstChild("Torso"),
        LeftArm = character:FindFirstChild("LeftUpperArm") or character:FindFirstChild("Left Arm"),
        RightArm = character:FindFirstChild("RightUpperArm") or character:FindFirstChild("Right Arm"),
        LeftLeg = character:FindFirstChild("LeftUpperLeg") or character:FindFirstChild("Left Leg"),
        RightLeg = character:FindFirstChild("RightUpperLeg") or character:FindFirstChild("Right Leg"),
    }
    
    -- 存储原始位置
    originalCFrames = {
        HumanoidRootPart = humanoidRootPart.CFrame,
        Camera = currentCamera.CFrame
    }
end

InitializeBodyParts()

-- 相机控制
local function UpdateCamera()
    local lookVector = currentCamera.CFrame.LookVector * Vector3.new(1, 0, 1)
    local targetPosition = humanoidRootPart.Position
    humanoidRootPart.CFrame = CFrame.lookAt(targetPosition, targetPosition + lookVector)
end

-- UI系统
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FallingGodUI"
screenGui.Parent = player:WaitForChild("PlayerGui")

-- 创建技能栏
local skillBar = Instance.new("Frame")
skillBar.Name = "SkillBar"
skillBar.Size = UDim2.new(0, 400, 0, 80)
skillBar.Position = UDim2.new(0.5, -200, 1, -100)
skillBar.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
skillBar.BackgroundTransparency = 0.5
skillBar.BorderSizePixel = 0
skillBar.Parent = screenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 15)
UICorner.Parent = skillBar

-- 技能按钮
local skillButtons = {}
local skillNames = {"Falling Strike", "Void Chains", "Gravity Wave", "Abyss Rift"}

for i = 1, 4 do
    local skillButton = Instance.new("TextButton")
    skillButton.Name = "Skill"..i
    skillButton.Size = UDim2.new(0, 60, 0, 60)
    skillButton.Position = UDim2.new(0, 20 + (i-1)*85, 0, 10)
    skillButton.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    skillButton.Text = ""
    skillButton.ZIndex = 2
    skillButton.Parent = skillBar
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 10)
    buttonCorner.Parent = skillButton
    
    -- 技能图标
    local skillIcon = Instance.new("ImageLabel")
    skillIcon.Name = "Icon"
    skillIcon.Size = UDim2.new(0, 40, 0, 40)
    skillIcon.Position = UDim2.new(0.5, -20, 0.5, -20)
    skillIcon.BackgroundTransparency = 1
    skillIcon.Image = Config.Skills[skillNames[i]].Icon
    skillIcon.Parent = skillButton
    
    -- 键位标签
    local keybindLabel = Instance.new("TextLabel")
    keybindLabel.Name = "Keybind"
    keybindLabel.Size = UDim2.new(0, 20, 0, 20)
    keybindLabel.Position = UDim2.new(1, -22, 0, -2)
    keybindLabel.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    keybindLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    keybindLabel.Text = string.sub(tostring(Config.Skills[skillNames[i]].Key), 15) -- 获取按键名称
    keybindLabel.TextSize = 12
    keybindLabel.Font = Enum.Font.GothamBold
    keybindLabel.ZIndex = 3
    keybindLabel.Parent = skillButton
    
    local keyCorner = Instance.new("UICorner")
    keyCorner.CornerRadius = UDim.new(0, 5)
    keyCorner.Parent = keybindLabel
    
    -- 冷却覆盖
    local cooldownOverlay = Instance.new("Frame")
    cooldownOverlay.Name = "Cooldown"
    cooldownOverlay.Size = UDim2.new(1, 0, 1, 0)
    cooldownOverlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    cooldownOverlay.BackgroundTransparency = 0.7
    cooldownOverlay.Visible = false
    cooldownOverlay.ZIndex = 3
    cooldownOverlay.Parent = skillButton
    
    local cooldownText = Instance.new("TextLabel")
    cooldownText.Name = "CooldownText"
    cooldownText.Size = UDim2.new(1, 0, 1, 0)
    cooldownText.BackgroundTransparency = 1
    cooldownText.TextColor3 = Color3.fromRGB(255, 100, 100)
    cooldownText.Text = ""
    cooldownText.TextSize = 18
    cooldownText.Font = Enum.Font.GothamBold
    cooldownText.ZIndex = 4
    cooldownText.Parent = cooldownOverlay
    
    -- 技能名称
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "SkillName"
    nameLabel.Size = UDim2.new(1, 0, 0, 20)
    nameLabel.Position = UDim2.new(0, 0, 1, 5)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
    nameLabel.Text = skillNames[i]
    nameLabel.TextSize = 12
    nameLabel.Font = Enum.Font.Gotham
    nameLabel.Parent = skillButton
    
    skillButtons[i] = {
        Button = skillButton,
        Icon = skillIcon,
        Cooldown = cooldownOverlay,
        CooldownText = cooldownText,
        SkillName = skillNames[i]
    }
    
    -- 点击事件
    skillButton.MouseButton1Click:Connect(function()
        UseSkill(skillNames[i])
    end)
end

-- 状态栏
local statsFrame = Instance.new("Frame")
statsFrame.Name = "Stats"
statsFrame.Size = UDim2.new(0, 300, 0, 100)
statsFrame.Position = UDim2.new(0, 20, 0, 20)
statsFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
statsFrame.BackgroundTransparency = 0.5
statsFrame.BorderSizePixel = 0
statsFrame.Parent = screenGui

local statsCorner = Instance.new("UICorner")
statsCorner.CornerRadius = UDim.new(0, 10)
statsCorner.Parent = statsFrame

-- 生命值条
local healthBar = Instance.new("Frame")
healthBar.Name = "HealthBar"
healthBar.Size = UDim2.new(0, 250, 0, 20)
healthBar.Position = UDim2.new(0.5, -125, 0, 20)
healthBar.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
healthBar.BorderSizePixel = 0
healthBar.Parent = statsFrame

local healthFill = Instance.new("Frame")
healthFill.Name = "HealthFill"
healthFill.Size = UDim2.new(1, 0, 1, 0)
healthFill.BackgroundColor3 = Color3.fromRGB(220, 50, 50)
healthFill.BorderSizePixel = 0
healthFill.Parent = healthBar

local healthText = Instance.new("TextLabel")
healthText.Name = "HealthText"
healthText.Size = UDim2.new(1, 0, 1, 0)
healthText.BackgroundTransparency = 1
healthText.TextColor3 = Color3.fromRGB(255, 255, 255)
healthText.Text = "Health: 1000/1000"
healthText.TextSize = 14
healthText.Font = Enum.Font.GothamBold
healthText.Parent = healthBar

-- 法力值条
local manaBar = Instance.new("Frame")
manaBar.Name = "ManaBar"
manaBar.Size = UDim2.new(0, 250, 0, 20)
manaBar.Position = UDim2.new(0.5, -125, 0, 50)
manaBar.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
manaBar.BorderSizePixel = 0
manaBar.Parent = statsFrame

local manaFill = Instance.new("Frame")
manaFill.Name = "ManaFill"
manaFill.Size = UDim2.new(mana / maxMana, 0, 1, 0)
manaFill.BackgroundColor3 = Color3.fromRGB(50, 100, 220)
manaFill.BorderSizePixel = 0
manaFill.Parent = manaBar

local manaText = Instance.new("TextLabel")
manaText.Name = "ManaText"
manaText.Size = UDim2.new(1, 0, 1, 0)
manaText.BackgroundTransparency = 1
manaText.TextColor3 = Color3.fromRGB(255, 255, 255)
manaText.Text = "Mana: 100/100"
manaText.TextSize = 14
manaText.Font = Enum.Font.GothamBold
manaText.Parent = manaBar

-- 动画系统
local AnimationSystem = {}

-- 重置所有部位
function AnimationSystem:ResetBodyParts()
    for _, part in pairs(bodyParts) do
        if part and part:IsA("BasePart") then
            part.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
            part.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
        end
    end
end

-- 基础攻击动画
function AnimationSystem:AttackAnimation(combo)
    if not canAttack or isUsingSkill then return end
    
    canAttack = false
    isAnimating = true
    
    local attackDuration = 0.3
    
    if combo == 1 then
        -- 第一次攻击：右拳
        if bodyParts.RightArm then
            local originalPosition = bodyParts.RightArm.Position
            local targetPosition = originalPosition + humanoidRootPart.CFrame.LookVector * 3
            
            -- 手臂前伸
            bodyParts.RightArm.AssemblyLinearVelocity = humanoidRootPart.CFrame.LookVector * 30
            
            task.wait(0.1)
            
            -- 收回手臂
            bodyParts.RightArm.AssemblyLinearVelocity = -humanoidRootPart.CFrame.LookVector * 20
            
            -- 创建攻击特效
            CreateEffect("Punch", bodyParts.RightArm.Position + humanoidRootPart.CFrame.LookVector * 2)
        end
    elseif combo == 2 then
        -- 第二次攻击：左拳
        if bodyParts.LeftArm then
            local originalPosition = bodyParts.LeftArm.Position
            local targetPosition = originalPosition + humanoidRootPart.CFrame.LookVector * 3
            
            -- 手臂前伸
            bodyParts.LeftArm.AssemblyLinearVelocity = humanoidRootPart.CFrame.LookVector * 30
            
            task.wait(0.1)
            
            -- 收回手臂
            bodyParts.LeftArm.AssemblyLinearVelocity = -humanoidRootPart.CFrame.LookVector * 20
            
            -- 创建攻击特效
            CreateEffect("Punch", bodyParts.LeftArm.Position + humanoidRootPart.CFrame.LookVector * 2)
        end
    end
    
    -- 检测攻击命中
    CheckAttackHit(Config.BaseDamage)
    
    task.wait(attackDuration - 0.1)
    AnimationSystem:ResetBodyParts()
    
    task.wait(0.1)
    canAttack = true
    isAnimating = false
end

-- 技能动画
function AnimationSystem:SkillAnimation(skillName)
    isUsingSkill = true
    isAnimating = true
    
    if skillName == "Falling Strike" then
        -- 跳跃动作
        humanoid.Jump = true
        
        -- 向上跳跃
        humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 100, 0)
        
        task.wait(0.3)
        
        -- 向下冲击
        humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, -150, 0)
        
        -- 冲击特效
        task.wait(0.2)
        CreateEffect("GroundImpact", humanoidRootPart.Position)
        
    elseif skillName == "Void Chains" then
        -- 双手展开
        if bodyParts.LeftArm and bodyParts.RightArm then
            bodyParts.LeftArm.AssemblyLinearVelocity = humanoidRootPart.CFrame.RightVector * -15
            bodyParts.RightArm.AssemblyLinearVelocity = humanoidRootPart.CFrame.RightVector * 15
            
            -- 创建锁链特效
            for i = 1, 3 do
                CreateChainEffect(humanoidRootPart.Position + Vector3.new(math.random(-10, 10), 0, math.random(-10, 10)))
            end
        end
        
    elseif skillName == "Gravity Wave" then
        -- 身体前倾
        humanoidRootPart.AssemblyLinearVelocity = humanoidRootPart.CFrame.LookVector * 50
        
        -- 双手前推
        if bodyParts.LeftArm and bodyParts.RightArm then
            bodyParts.LeftArm.AssemblyLinearVelocity = humanoidRootPart.CFrame.LookVector * 40
            bodyParts.RightArm.AssemblyLinearVelocity = humanoidRootPart.CFrame.LookVector * 40
        end
        
        -- 创建重力波
        CreateGravityWave(humanoidRootPart.Position + humanoidRootPart.CFrame.LookVector * 5)
        
    elseif skillName == "Abyss Rift" then
        -- 跪地姿势
        humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, -20, 0)
        
        task.wait(0.3)
        
        -- 双手上举
        if bodyParts.LeftArm and bodyParts.RightArm then
            bodyParts.LeftArm.AssemblyLinearVelocity = Vector3.new(0, 50, 0)
            bodyParts.RightArm.AssemblyLinearVelocity = Vector3.new(0, 50, 0)
        end
        
        -- 创建深渊裂隙
        CreateRiftEffect(humanoidRootPart.Position)
        
        task.wait(0.5)
        
        -- 冲击波
        CreateEffect("Shockwave", humanoidRootPart.Position)
    end
    
    task.wait(0.5)
    AnimationSystem:ResetBodyParts()
    
    isUsingSkill = false
    isAnimating = false
end

-- 空闲呼吸动画
function AnimationSystem:IdleAnimation()
    if isAnimating or isUsingSkill then return end
    
    -- 轻微呼吸起伏
    local breath = math.sin(tick() * 2) * 0.1
    
    if bodyParts.Torso then
        bodyParts.Torso.AssemblyLinearVelocity = Vector3.new(0, breath * 2, 0)
    end
    
    -- 轻微左右摆动
    local swing = math.sin(tick() * 1.5) * 0.05
    
    if bodyParts.LeftArm then
        bodyParts.LeftArm.AssemblyAngularVelocity = Vector3.new(0, swing, 0)
    end
    
    if bodyParts.RightArm then
        bodyParts.RightArm.AssemblyAngularVelocity = Vector3.new(0, -swing, 0)
    end
end

-- 特效系统
function CreateEffect(effectType, position)
    if effectType == "Punch" then
        local part = Instance.new("Part")
        part.Size = Vector3.new(2, 2, 2)
        part.Position = position
        part.Transparency = 0.5
        part.Color = Color3.fromRGB(255, 100, 100)
        part.Material = Enum.Material.Neon
        part.Anchored = true
        part.CanCollide = false
        part.Parent = Workspace
        
        local tween = TweenService:Create(part,
            TweenInfo.new(0.3, Enum.EasingStyle.Quad),
            {Size = Vector3.new(0.1, 0.1, 0.1), Transparency = 1}
        )
        tween:Play()
        
        Debris:AddItem(part, 1)
        
    elseif effectType == "GroundImpact" then
        local impact = Instance.new("Part")
        impact.Size = Vector3.new(0.1, 0.1, 0.1)
        impact.Position = position - Vector3.new(0, 3, 0)
        impact.Transparency = 0.4
        impact.Color = Color3.fromRGB(220, 50, 50)
        impact.Material = Enum.Material.Neon
        impact.Anchored = true
        impact.CanCollide = false
        impact.Parent = Workspace
        
        local tween = TweenService:Create(impact,
            TweenInfo.new(0.5, Enum.EasingStyle.Quad),
            {Size = Vector3.new(15, 0.1, 15), Transparency = 1}
        )
        tween:Play()
        
        Debris:AddItem(impact, 1)
        
    elseif effectType == "Shockwave" then
        local wave = Instance.new("Part")
        wave.Size = Vector3.new(1, 1, 1)
        wave.Shape = Enum.PartType.Cylinder
        wave.Position = position
        wave.Transparency = 0.6
        wave.Color = Color3.fromRGB(150, 50, 200)
        wave.Material = Enum.Material.Neon
        wave.Anchored = true
        wave.CanCollide = false
        wave.Parent = Workspace
        
        local tween = TweenService:Create(wave,
            TweenInfo.new(1, Enum.EasingStyle.Quad),
            {Size = Vector3.new(25, 0.1, 25), Transparency = 1}
        )
        tween:Play()
        
        Debris:AddItem(wave, 1.5)
    end
end

function CreateChainEffect(position)
    local chain = Instance.new("Part")
    chain.Size = Vector3.new(0.5, 5, 0.5)
    chain.Position = position
    chain.Color = Color3.fromRGB(80, 30, 120)
    chain.Material = Enum.Material.Neon
    chain.Anchored = true
    chain.CanCollide = false
    chain.Parent = Workspace
    
    -- 摆动动画
    task.spawn(function()
        for i = 1, 10 do
            chain.CFrame = chain.CFrame * CFrame.Angles(0, math.rad(20), 0)
            task.wait(0.05)
        end
        chain:Destroy()
    end)
end

function CreateGravityWave(position)
    local wave = Instance.new("Part")
    wave.Size = Vector3.new(1, 1, 1)
    wave.Shape = Enum.PartType.Cylinder
    wave.Position = position
    wave.Transparency = 0.5
    wave.Color = Color3.fromRGB(150, 50, 200)
    wave.Material = Enum.Material.Neon
    wave.Anchored = true
    wave.CanCollide = false
    wave.Parent = Workspace
    
    local tween = TweenService:Create(wave,
        TweenInfo.new(0.8, Enum.EasingStyle.Quad),
        {Size = Vector3.new(18, 0.1, 18), Transparency = 1}
    )
    tween:Play()
    
    Debris:AddItem(wave, 1)
end

function CreateRiftEffect(position)
    local rift = Instance.new("Part")
    rift.Size = Vector3.new(3, 0.2, 3)
    rift.Position = position
    rift.Color = Color3.fromRGB(30, 10, 50)
    rift.Material = Enum.Material.Neon
    rift.Anchored = true
    rift.CanCollide = false
    rift.Parent = Workspace
    
    -- 旋转动画
    task.spawn(function()
        for i = 1, 20 do
            rift.Size = rift.Size + Vector3.new(0.5, 0, 0.5)
            rift.CFrame = rift.CFrame * CFrame.Angles(0, math.rad(15), 0)
            task.wait(0.1)
        end
        rift:Destroy()
    end)
end

-- 攻击检测
function CheckAttackHit(damage)
    local hitbox = Instance.new("Part")
    hitbox.Size = Vector3.new(Config.Animation.AttackRange, Config.Animation.AttackRange, Config.Animation.AttackRange)
    hitbox.Position = humanoidRootPart.Position + humanoidRootPart.CFrame.LookVector * (Config.Animation.AttackRange / 2)
    hitbox.Transparency = 1
    hitbox.CanCollide = false
    hitbox.Anchored = true
    hitbox.Parent = Workspace
    
    -- 检测范围内的敌人
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player then
            local otherCharacter = otherPlayer.Character
            if otherCharacter then
                local otherRoot = otherCharacter:FindFirstChild("HumanoidRootPart")
                if otherRoot then
                    local distance = (otherRoot.Position - hitbox.Position).Magnitude
                    if distance <= Config.Animation.AttackRange then
                        local otherHumanoid = otherCharacter:FindFirstChild("Humanoid")
                        if otherHumanoid then
                            otherHumanoid:TakeDamage(damage)
                            ShowDamageNumber(otherRoot.Position, damage)
                            
                            -- 击退效果
                            local direction = (otherRoot.Position - humanoidRootPart.Position).Unit
                            otherRoot.AssemblyLinearVelocity = direction * 30 + Vector3.new(0, 10, 0)
                        end
                    end
                end
            end
        end
    end
    
    Debris:AddItem(hitbox, 0.1)
end

-- 技能检测
function CheckSkillHit(skillName, damage, range)
    local hitbox = Instance.new("Part")
    hitbox.Size = Vector3.new(range, range, range)
    hitbox.Position = humanoidRootPart.Position
    hitbox.Transparency = 1
    hitbox.CanCollide = false
    hitbox.Anchored = true
    hitbox.Parent = Workspace
    
    local skillEffects = {
        ["Falling Strike"] = function(targetRoot)
            -- 向上击飞
            targetRoot.AssemblyLinearVelocity = Vector3.new(0, 80, 0)
        end,
        ["Void Chains"] = function(targetRoot)
            -- 拉向玩家
            local direction = (humanoidRootPart.Position - targetRoot.Position).Unit
            targetRoot.AssemblyLinearVelocity = direction * 40
        end,
        ["Gravity Wave"] = function(targetRoot)
            -- 向后击退
            local direction = (targetRoot.Position - humanoidRootPart.Position).Unit
            targetRoot.AssemblyLinearVelocity = direction * 50 + Vector3.new(0, 20, 0)
        end,
        ["Abyss Rift"] = function(targetRoot)
            -- 向上击飞并旋转
            targetRoot.AssemblyLinearVelocity = Vector3.new(0, 100, 0)
            targetRoot.AssemblyAngularVelocity = Vector3.new(0, 50, 0)
        end
    }
    
    -- 检测范围内的敌人
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player then
            local otherCharacter = otherPlayer.Character
            if otherCharacter then
                local otherRoot = otherCharacter:FindFirstChild("HumanoidRootPart")
                if otherRoot then
                    local distance = (otherRoot.Position - hitbox.Position).Magnitude
                    if distance <= range then
                        local otherHumanoid = otherCharacter:FindFirstChild("Humanoid")
                        if otherHumanoid then
                            otherHumanoid:TakeDamage(damage)
                            ShowDamageNumber(otherRoot.Position, damage)
                            
                            -- 应用技能特效
                            local effect = skillEffects[skillName]
                            if effect then
                                effect(otherRoot)
                            end
                        end
                    end
                end
            end
        end
    end
    
    Debris:AddItem(hitbox, 0.1)
end

-- 伤害数字显示
function ShowDamageNumber(position, damage)
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(2, 0, 2, 0)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Adornee = Workspace.Terrain
    billboard.Parent = Workspace
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = tostring(damage)
    textLabel.TextColor3 = Color3.fromRGB(255, 50, 50)
    textLabel.TextSize = 24
    textLabel.Font = Enum.Font.GothamBold
    textLabel.Parent = billboard
    
    local tween = TweenService:Create(billboard,
        TweenInfo.new(1, Enum.EasingStyle.Quad),
        {StudsOffset = Vector3.new(0, 6, 0)}
    )
    tween:Play()
    
    task.delay(0.5, function()
        local fadeTween = TweenService:Create(textLabel,
            TweenInfo.new(0.5),
            {TextTransparency = 1}
        )
        fadeTween:Play()
    end)
    
    Debris:AddItem(billboard, 2)
end

-- 技能系统
function UseSkill(skillName)
    if skillsOnCooldown[skillName] or isUsingSkill or mana < Config.Skills[skillName].ManaCost then
        return
    end
    
    local skill = Config.Skills[skillName]
    
    -- 消耗法力
    mana = mana - skill.ManaCost
    UpdateUI()
    
    -- 开始冷却
    skillsOnCooldown[skillName] = true
    StartCooldown(skillName)
    
    -- 播放动画
    AnimationSystem:SkillAnimation(skillName)
    
    -- 技能效果
    local skillRange = Config.Animation.SkillRange
    if skillName == "Abyss Rift" then
        skillRange = 25  -- 更大的范围
    end
    
    -- 延迟执行伤害检测（与动画同步）
    task.delay(0.3, function()
        CheckSkillHit(skillName, skill.Damage, skillRange)
    end)
end

-- 冷却系统
function StartCooldown(skillName)
    local skill = Config.Skills[skillName]
    if not skill then return end
    
    -- 找到对应的按钮
    local buttonIndex = nil
    for i, skillButton in ipairs(skillButtons) do
        if skillButton.SkillName == skillName then
            buttonIndex = i
            break
        end
    end
    
    if buttonIndex then
        local button = skillButtons[buttonIndex]
        button.Cooldown.Visible = true
        
        -- 冷却计时
        for i = skill.Cooldown, 0, -1 do
            button.CooldownText.Text = tostring(i)
            task.wait(1)
        end
        
        button.Cooldown.Visible = false
    end
    
    skillsOnCooldown[skillName] = false
end

-- 攻击系统
function PerformAttack()
    local currentTime = tick()
    
    if currentTime - lastAttackTime > 1.5 then
        comboCount = 0
    end
    
    comboCount = comboCount + 1
    if comboCount > 2 then comboCount = 1 end
    
    AnimationSystem:AttackAnimation(comboCount)
    
    lastAttackTime = currentTime
end

-- UI更新
function UpdateUI()
    -- 生命值
    healthFill.Size = UDim2.new(humanoid.Health / Config.MaxHealth, 0, 1, 0)
    healthText.Text = string.format("HP: %d/%d", math.floor(humanoid.Health), Config.MaxHealth)
    
    -- 法力值
    manaFill.Size = UDim2.new(mana / maxMana, 0, 1, 0)
    manaText.Text = string.format("MP: %d/%d", mana, maxMana)
end

-- 法力恢复
task.spawn(function()
    while true do
        task.wait(0.5)
        if mana < maxMana then
            mana = math.min(maxMana, mana + 2)
            UpdateUI()
        end
    end
end)

-- 输入绑定
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed or isAnimating then return end
    
    -- 攻击（鼠标左键）
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        PerformAttack()
    
    -- 技能快捷键
    elseif input.KeyCode == Enum.KeyCode.Q then
        UseSkill("Falling Strike")
    elseif input.KeyCode == Enum.KeyCode.E then
        UseSkill("Void Chains")
    elseif input.KeyCode == Enum.KeyCode.R then
        UseSkill("Gravity Wave")
    elseif input.KeyCode == Enum.KeyCode.F then
        UseSkill("Abyss Rift")
    end
end)

-- 角色属性设置
humanoid.WalkSpeed = Config.WalkSpeed
humanoid.JumpPower = Config.JumpPower
humanoid.MaxHealth = Config.MaxHealth
humanoid.Health = Config.MaxHealth

-- 主循环
RunService.Heartbeat:Connect(function(deltaTime)
    -- 更新UI
    UpdateUI()
    
    -- 空闲动画
    if not isAnimating and not isUsingSkill then
        AnimationSystem:IdleAnimation()
    end
    
    -- 相机跟随
    if not isUsingSkill then
        UpdateCamera()
    end
    
    -- 防止角色掉落
    if humanoidRootPart.Position.Y < -500 then
        humanoidRootPart.CFrame = CFrame.new(0, 50, 0)
        AnimationSystem:ResetBodyParts()
    end
end)

-- 角色死亡重置
humanoid.Died:Connect(function()
    task.wait(5)
    -- 重置状态
    mana = maxMana
    for skillName, _ in pairs(skillsOnCooldown) do
        skillsOnCooldown[skillName] = false
    end
    
    -- 重置按钮
    for _, button in ipairs(skillButtons) do
        button.Cooldown.Visible = false
    end
end)

-- 角色重新生成
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid")
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    
    InitializeBodyParts()
    
    -- 重新设置属性
    humanoid.WalkSpeed = Config.WalkSpeed
    humanoid.JumpPower = Config.JumpPower
    humanoid.MaxHealth = Config.MaxHealth
    humanoid.Health = Config.MaxHealth
end)

-- 初始UI更新
UpdateUI()

print("坠落之神系统已加载！")
print("控制方式：")
print("鼠标左键 - 普通攻击")
print("Q - 坠落打击")
print("E - 虚空锁链")
print("R - 重力波")
print("F - 深渊裂隙")

-- =============================================================================
-- é«˜çº§æ™ºèƒ½AIèŠå¤©ç³»ç»Ÿ - å®Œæ•´ç‰ˆ
-- ä½œè€…ï¼šRoblox AIåŠ©æ‰‹
-- ç‰ˆæœ¬ï¼š1.0
-- æè¿°ï¼šå®Œå…¨æœ¬åœ°è¿è¡Œçš„æ™ºèƒ½AIèŠå¤©ç³»ç»Ÿï¼Œæ— éœ€HTTPè¯·æ±‚
-- =============================================================================

-- æœåŠ¡
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local TextChatService = game:GetService("TextChatService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local DataStoreService = game:GetService("DataStoreService")

-- æ£€æŸ¥TextChatServiceæ˜¯å¦å¯ç”¨
local hasTextChat = pcall(function() 
    if TextChatService:FindFirstChild("TextChannels") then
        if TextChatService.TextChannels:FindFirstChild("RBXGeneral") then
            return true
        end
    end
    return false
end)

-- =============================================================================
-- ç¬¬ä¸€éƒ¨åˆ†ï¼šç°ä»£åŒ–UIåˆ›å»º
-- =============================================================================

-- åˆ›å»ºä¸»å±å¹•GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SmartAIChatSystem"
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.ResetOnSpawn = false
ScreenGui.DisplayOrder = 100

-- ä¸»çª—å£æ¡†æ¶
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 450, 0, 600)
MainFrame.Position = UDim2.new(0.5, -225, 0.5, -300)
MainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
MainFrame.BackgroundTransparency = 0
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Visible = false

-- æ·»åŠ åœ†è§’
local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainFrame

-- æ·»åŠ é˜´å½±
local UIStroke = Instance.new("UIStroke")
UIStroke.Color = Color3.fromRGB(220, 220, 220)
UIStroke.Thickness = 1
UIStroke.Parent = MainFrame

-- æ ‡é¢˜æ ï¼ˆå¯æ‹–åŠ¨åŒºåŸŸï¼‰
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.BackgroundColor3 = Color3.fromRGB(245, 245, 245)
TitleBar.BorderSizePixel = 0

-- æ ‡é¢˜æ åœ†è§’
local TitleBarCorner = Instance.new("UICorner")
TitleBarCorner.CornerRadius = UDim.new(0, 12)
TitleBarCorner.Parent = TitleBar

-- æ ‡é¢˜æ–‡æœ¬
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "TitleLabel"
TitleLabel.Size = UDim2.new(0.5, 0, 1, 0)
TitleLabel.Position = UDim2.new(0, 15, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹"
TitleLabel.TextColor3 = Color3.fromRGB(30, 30, 30)
TitleLabel.TextSize = 16
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

-- æœ€å°åŒ–æŒ‰é’®
local MinimizeButton = Instance.new("ImageButton")
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 30, 0, 30)
MinimizeButton.Position = UDim2.new(1, -80, 0, 5)
MinimizeButton.BackgroundTransparency = 1
MinimizeButton.Image = "rbxassetid://3926305904"
MinimizeButton.ImageRectOffset = Vector2.new(844, 404)
MinimizeButton.ImageRectSize = Vector2.new(36, 36)
MinimizeButton.ImageColor3 = Color3.fromRGB(100, 100, 100)

-- å…³é—­æŒ‰é’®
local CloseButton = Instance.new("ImageButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -40, 0, 5)
CloseButton.BackgroundTransparency = 1
CloseButton.Image = "rbxassetid://3926305904"
CloseButton.ImageRectOffset = Vector2.new(284, 4)
CloseButton.ImageRectSize = Vector2.new(24, 24)
CloseButton.ImageColor3 = Color3.fromRGB(100, 100, 100)

-- èŠå¤©å®¹å™¨
local ChatContainer = Instance.new("Frame")
ChatContainer.Name = "ChatContainer"
ChatContainer.Size = UDim2.new(1, -20, 1, -180)
ChatContainer.Position = UDim2.new(0, 10, 0, 50)
ChatContainer.BackgroundTransparency = 1

-- èŠå¤©æ»šåŠ¨æ¡†
local ChatScroll = Instance.new("ScrollingFrame")
ChatScroll.Name = "ChatScroll"
ChatScroll.Size = UDim2.new(1, 0, 1, 0)
ChatScroll.BackgroundTransparency = 1
ChatScroll.ScrollBarImageColor3 = Color3.fromRGB(200, 200, 200)
ChatScroll.ScrollBarThickness = 6
ChatScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
ChatScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
ChatScroll.ScrollingDirection = Enum.ScrollingDirection.Y
ChatScroll.VerticalScrollBarInset = Enum.ScrollBarInset.Always

-- èŠå¤©å¸ƒå±€
local ChatLayout = Instance.new("UIListLayout")
ChatLayout.Name = "ChatLayout"
ChatLayout.Padding = UDim.new(0, 15)
ChatLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
ChatLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- èŠå¤©å†…è¾¹è·
local ChatPadding = Instance.new("UIPadding")
ChatPadding.Name = "ChatPadding"
ChatPadding.PaddingTop = UDim.new(0, 10)
ChatPadding.PaddingBottom = UDim.new(0, 10)
ChatPadding.PaddingLeft = UDim.new(0, 5)
ChatPadding.PaddingRight = UDim.new(0, 5)

-- è¾“å…¥å®¹å™¨
local InputContainer = Instance.new("Frame")
InputContainer.Name = "InputContainer"
InputContainer.Size = UDim2.new(1, -20, 0, 60)
InputContainer.Position = UDim2.new(0, 10, 1, -70)
InputContainer.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
InputContainer.BorderSizePixel = 0

-- è¾“å…¥å®¹å™¨åœ†è§’
local InputCorner = Instance.new("UICorner")
InputCorner.CornerRadius = UDim.new(0, 10)
InputCorner.Parent = InputContainer

-- è¾“å…¥æ¡†
local InputBox = Instance.new("TextBox")
InputBox.Name = "InputBox"
InputBox.Size = UDim2.new(1, -90, 1, -10)
InputBox.Position = UDim2.new(0, 10, 0, 5)
InputBox.BackgroundColor3 = Color3.fromRGB(250, 250, 250)
InputBox.TextColor3 = Color3.fromRGB(30, 30, 30)
InputBox.TextSize = 14
InputBox.Font = Enum.Font.Gotham
InputBox.PlaceholderText = "è¾“å…¥æ¶ˆæ¯..."
InputBox.PlaceholderColor3 = Color3.fromRGB(150, 150, 150)
InputBox.ClearTextOnFocus = false
InputBox.TextXAlignment = Enum.TextXAlignment.Left
InputBox.TextYAlignment = Enum.TextYAlignment.Top
InputBox.MultiLine = true
InputBox.TextWrapped = true

-- è¾“å…¥æ¡†è¾¹æ¡†
local InputStroke = Instance.new("UIStroke")
InputStroke.Color = Color3.fromRGB(220, 220, 220)
InputStroke.Thickness = 1
InputStroke.Parent = InputBox

-- è¾“å…¥æ¡†åœ†è§’
local InputCorner2 = Instance.new("UICorner")
InputCorner2.CornerRadius = UDim.new(0, 8)
InputCorner2.Parent = InputBox

-- å‘é€æŒ‰é’®
local SendButton = Instance.new("TextButton")
SendButton.Name = "SendButton"
SendButton.Size = UDim2.new(0, 70, 1, -10)
SendButton.Position = UDim2.new(1, -80, 0, 5)
SendButton.BackgroundColor3 = Color3.fromRGB(0, 120, 215)
SendButton.Text = "å‘é€"
SendButton.TextColor3 = Color3.fromRGB(255, 255, 255)
SendButton.TextSize = 14
SendButton.Font = Enum.Font.GothamBold
SendButton.AutoButtonColor = true

-- å‘é€æŒ‰é’®åœ†è§’
local SendButtonCorner = Instance.new("UICorner")
SendButtonCorner.CornerRadius = UDim.new(0, 8)
SendButtonCorner.Parent = SendButton

-- æ§åˆ¶æ 
local ControlBar = Instance.new("Frame")
ControlBar.Name = "ControlBar"
ControlBar.Size = UDim2.new(1, 0, 0, 50)
ControlBar.Position = UDim2.new(0, 0, 1, -50)
ControlBar.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
ControlBar.BorderSizePixel = 0

-- äººæ ¼æŒ‰é’®
local PersonaButton = Instance.new("TextButton")
PersonaButton.Name = "PersonaButton"
PersonaButton.Size = UDim2.new(0, 100, 0, 30)
PersonaButton.Position = UDim2.new(0, 15, 0, 10)
PersonaButton.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
PersonaButton.TextColor3 = Color3.fromRGB(0, 120, 215)
PersonaButton.Text = "ğŸ§  åŠ©æ‰‹"
PersonaButton.TextSize = 12
PersonaButton.Font = Enum.Font.Gotham

-- äººæ ¼æŒ‰é’®åœ†è§’
local PersonaCorner = Instance.new("UICorner")
PersonaCorner.CornerRadius = UDim.new(0, 6)
PersonaCorner.Parent = PersonaButton

-- AIæ¨¡å¼æŒ‰é’®
local AIButton = Instance.new("TextButton")
AIButton.Name = "AIButton"
AIButton.Size = UDim2.new(0, 100, 0, 30)
AIButton.Position = UDim2.new(0.5, -50, 0, 10)
AIButton.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
AIButton.TextColor3 = Color3.fromRGB(0, 120, 215)
AIButton.Text = "ğŸ¤– AIæ¨¡å¼: å…³"
AIButton.TextSize = 12
AIButton.Font = Enum.Font.Gotham

-- AIæŒ‰é’®åœ†è§’
local AICorner = Instance.new("UICorner")
AICorner.CornerRadius = UDim.new(0, 6)
AICorner.Parent = AIButton

-- æ¸…é™¤æŒ‰é’®
local ClearButton = Instance.new("TextButton")
ClearButton.Name = "ClearButton"
ClearButton.Size = UDim2.new(0, 30, 0, 30)
ClearButton.Position = UDim2.new(1, -50, 0, 10)
ClearButton.BackgroundTransparency = 1
ClearButton.Text = "ğŸ—‘ï¸"
ClearButton.TextColor3 = Color3.fromRGB(150, 150, 150)
ClearButton.TextSize = 18
ClearButton.Font = Enum.Font.Gotham

-- ç»„è£…UI
TitleBar.Parent = MainFrame
TitleLabel.Parent = TitleBar
MinimizeButton.Parent = TitleBar
CloseButton.Parent = TitleBar
ChatContainer.Parent = MainFrame
ChatScroll.Parent = ChatContainer
ChatLayout.Parent = ChatScroll
ChatPadding.Parent = ChatScroll
InputContainer.Parent = MainFrame
InputBox.Parent = InputContainer
SendButton.Parent = InputContainer
ControlBar.Parent = MainFrame
PersonaButton.Parent = ControlBar
AIButton.Parent = ControlBar
ClearButton.Parent = ControlBar
MainFrame.Parent = ScreenGui
ScreenGui.Parent = PlayerGui

-- =============================================================================
-- ç¬¬äºŒéƒ¨åˆ†ï¼šæ™ºèƒ½AIå¼•æ“
-- =============================================================================

-- èŠå¤©è®°å½•ç®¡ç†å™¨
local ChatHistory = {
    Messages = {},
    MaxMessages = 200,
    AutoSave = true
}

-- AIé…ç½®
local AIConfig = {
    CurrentPersona = "assistant",
    IsAIModeActive = false,
    ResponseDelay = 0.3,
    LearningEnabled = true
}

-- æ¶ˆæ¯æ¨¡æ¿åˆ›å»ºå‡½æ•°
local function createMessageTemplate(isAI, sender, message, timestamp)
    local messageFrame = Instance.new("Frame")
    messageFrame.Name = "MessageFrame"
    messageFrame.BackgroundTransparency = 1
    messageFrame.Size = UDim2.new(0.95, 0, 0, 0)
    messageFrame.LayoutOrder = #ChatHistory.Messages + 1
    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    
    -- æ¶ˆæ¯æ°”æ³¡
    local messageBubble = Instance.new("Frame")
    messageBubble.Name = "MessageBubble"
    messageBubble.BackgroundColor3 = isAI and Color3.fromRGB(230, 240, 255) or Color3.fromRGB(240, 245, 250)
    messageBubble.Size = UDim2.new(1, 0, 0, 0)
    messageBubble.Position = UDim2.new(0, 0, 0, 0)
    messageBubble.AutomaticSize = Enum.AutomaticSize.Y
    
    local bubbleCorner = Instance.new("UICorner")
    bubbleCorner.CornerRadius = UDim.new(0, 12)
    bubbleCorner.Parent = messageBubble
    
    local bubbleStroke = Instance.new("UIStroke")
    bubbleStroke.Color = Color3.fromRGB(220, 230, 240)
    bubbleStroke.Thickness = 1
    bubbleStroke.Parent = messageBubble
    
    -- å‘é€è€…ä¿¡æ¯
    local senderFrame = Instance.new("Frame")
    senderFrame.Name = "SenderFrame"
    senderFrame.Size = UDim2.new(1, 0, 0, 25)
    senderFrame.BackgroundTransparency = 1
    
    local senderIcon = Instance.new("TextLabel")
    senderIcon.Name = "SenderIcon"
    senderIcon.Size = UDim2.new(0, 25, 0, 25)
    senderIcon.BackgroundTransparency = 1
    senderIcon.Text = isAI and "ğŸ¤–" or "ğŸ‘¤"
    senderIcon.TextColor3 = isAI and Color3.fromRGB(0, 100, 200) or Color3.fromRGB(100, 100, 100)
    senderIcon.TextSize = 14
    
    local senderLabel = Instance.new("TextLabel")
    senderLabel.Name = "SenderLabel"
    senderLabel.Size = UDim2.new(1, -35, 1, 0)
    senderLabel.Position = UDim2.new(0, 30, 0, 0)
    senderLabel.BackgroundTransparency = 1
    senderLabel.Text = sender
    senderLabel.TextColor3 = isAI and Color3.fromRGB(0, 100, 200) or Color3.fromRGB(100, 100, 100)
    senderLabel.TextSize = 12
    senderLabel.Font = Enum.Font.GothamBold
    senderLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    -- æ—¶é—´æˆ³
    local timeLabel = Instance.new("TextLabel")
    timeLabel.Name = "TimeLabel"
    timeLabel.Size = UDim2.new(0, 60, 1, 0)
    timeLabel.Position = UDim2.new(1, -65, 0, 0)
    timeLabel.BackgroundTransparency = 1
    timeLabel.Text = timestamp or os.date("%H:%M")
    timeLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
    timeLabel.TextSize = 10
    timeLabel.Font = Enum.Font.Gotham
    timeLabel.TextXAlignment = Enum.TextXAlignment.Right
    
    -- æ¶ˆæ¯å†…å®¹ï¼ˆè“è‰²å­—ä½“ï¼‰
    local messageLabel = Instance.new("TextLabel")
    messageLabel.Name = "MessageLabel"
    messageLabel.Size = UDim2.new(1, -20, 0, 0)
    messageLabel.Position = UDim2.new(0, 10, 0, 30)
    messageLabel.BackgroundTransparency = 1
    messageLabel.Text = message
    messageLabel.TextColor3 = Color3.fromRGB(0, 100, 200) -- è“è‰²å­—ä½“
    messageLabel.TextSize = 14
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextWrapped = true
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.AutomaticSize = Enum.AutomaticSize.Y
    
    -- å¤åˆ¶æŒ‰é’®
    local copyButton = Instance.new("TextButton")
    copyButton.Name = "CopyButton"
    copyButton.Size = UDim2.new(0, 25, 0, 25)
    copyButton.Position = UDim2.new(1, -35, 0, 30)
    copyButton.BackgroundTransparency = 1
    copyButton.Text = "ğŸ“‹"
    copyButton.TextColor3 = Color3.fromRGB(150, 150, 150)
    copyButton.TextSize = 12
    copyButton.Visible = isAI
    
    -- ç»„è£…
    senderIcon.Parent = senderFrame
    senderLabel.Parent = senderFrame
    timeLabel.Parent = senderFrame
    senderFrame.Parent = messageBubble
    messageLabel.Parent = messageBubble
    copyButton.Parent = messageBubble
    messageBubble.Parent = messageFrame
    
    return messageFrame
end

-- æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©è®°å½•
local function addMessageToChat(isAI, sender, message)
    local timestamp = os.date("%H:%M")
    
    -- ä¿å­˜åˆ°å†å²è®°å½•
    table.insert(ChatHistory.Messages, {
        isAI = isAI,
        sender = sender,
        message = message,
        timestamp = timestamp
    })
    
    -- é™åˆ¶å†å²è®°å½•æ•°é‡
    if #ChatHistory.Messages > ChatHistory.MaxMessages then
        table.remove(ChatHistory.Messages, 1)
    end
    
    -- åˆ›å»ºUIæ¶ˆæ¯
    local messageUI = createMessageTemplate(isAI, sender, message, timestamp)
    messageUI.Parent = ChatScroll
    
    -- æ»šåŠ¨åˆ°åº•éƒ¨
    task.wait(0.05)
    ChatScroll.CanvasPosition = Vector2.new(0, ChatScroll.CanvasSize.Y.Offset)
    
    return messageUI
end

-- AIè¯­è¨€ç”Ÿæˆå™¨
local AILanguageGenerator = {
    -- è¯æ±‡åº“
    vocabulary = {
        connectors = {"å¹¶ä¸”", "è€Œä¸”", "å¦å¤–", "åŒæ—¶", "æ­¤å¤–", "ä¸ä»…å¦‚æ­¤", "æ›´é‡è¦çš„æ˜¯", "å…·ä½“æ¥è¯´", "ç®€å•æ¥è¯´", "æ€»çš„æ¥è¯´"},
        adjectives = {"æ™ºèƒ½çš„", "é«˜æ•ˆçš„", "å¼ºå¤§çš„", "çµæ´»çš„", "å¯é çš„", "å…ˆè¿›çš„", "åˆ›æ–°çš„", "ä¼˜åŒ–çš„", "é›†æˆçš„", "åŠ¨æ€çš„"},
        verbs = {"å®ç°", "å®Œæˆ", "æ„å»º", "å¼€å‘", "åˆ›å»º", "è®¾è®¡", "ç¼–å†™", "ä¼˜åŒ–", "è°ƒè¯•", "æµ‹è¯•", "éƒ¨ç½²", "è¿è¡Œ"},
        adverbs = {"é«˜æ•ˆåœ°", "å¿«é€Ÿåœ°", "å‡†ç¡®åœ°", "å¯é åœ°", "ç¨³å®šåœ°", "çµæ´»åœ°", "æ™ºèƒ½åœ°", "è‡ªåŠ¨åœ°", "å®‰å…¨åœ°"},
        nouns = {"åŠŸèƒ½", "ç³»ç»Ÿ", "è„šæœ¬", "ä»£ç ", "ç¨‹åº", "ç®—æ³•", "é€»è¾‘", "ç»“æ„", "æ¡†æ¶", "æ¨¡å—", "ç»„ä»¶"},
        phrases = {
            "è®©æˆ‘æ¥å¸®ä½ ", "æ ¹æ®æˆ‘çš„ç†è§£", "ä»æŠ€æœ¯è§’åº¦", "åœ¨å®é™…åº”ç”¨ä¸­", "ä¸ºäº†æ›´å¥½åœ°",
            "è¿™ä¸ªæ–¹æ¡ˆå¯ä»¥", "è¿™ç§æ–¹æ³•èƒ½å¤Ÿ", "è¿™ä¸ªæ€è·¯å¯ä»¥", "è¿™ä¸ªè®¾è®¡å¯ä»¥", "è¿™ä¸ªå®ç°èƒ½å¤Ÿ"
        }
    },
    
    -- å›åº”æ¨¡æ¿
    templates = {
        greeting = {"ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ï¼", "æ¬¢è¿ä½¿ç”¨AIåŠ©æ‰‹ï¼æˆ‘éšæ—¶å‡†å¤‡ä¸ºä½ æä¾›å¸®åŠ©ã€‚", "ä½ å¥½ï¼Œæˆ‘å¯ä»¥å¸®ä½ è§£ç­”é—®é¢˜ã€ç¼–å†™è„šæœ¬æˆ–èŠå¤©ã€‚"},
        response = {"æˆ‘è®¤ä¸º$answer", "æˆ‘çš„å»ºè®®æ˜¯$answer", "æ ¹æ®æˆ‘çš„åˆ†æï¼Œ$answer", "ä»æˆ‘çš„è§’åº¦æ¥çœ‹ï¼Œ$answer"},
        question = {"ä½ æ˜¯æƒ³äº†è§£$topicå—ï¼Ÿ", "å…³äº$topicï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½ ...", "å¯¹äº$topicçš„é—®é¢˜ï¼Œæˆ‘çš„ç†è§£æ˜¯..."},
        programming = {"åœ¨Roblox Luaä¸­ï¼Œ$solution", "è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œä½ å¯ä»¥$solution", "è¿™é‡Œæœ‰ä¸€ä¸ªç¤ºä¾‹ä»£ç ï¼š$code"}
    },
    
    -- çŸ¥è¯†åº“
    knowledgeBase = {
        greetings = {
            patterns = {"ä½ å¥½", "å—¨", "å“ˆå–½", "hello", "hi", "æ‚¨å¥½", "åœ¨å—"},
            responses = {"ä½ å¥½ï¼", "å—¨ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï¼", "å“ˆå–½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ", "ä½ å¥½å‘€ï¼"}
        },
        questions = {
            patterns = {"ä»€ä¹ˆ", "æ€ä¹ˆ", "ä¸ºä»€ä¹ˆ", "å¦‚ä½•", "å“ªé‡Œ", "è°", "å“ªä¸ª", "ä»€ä¹ˆæ—¶å€™"},
            responses = {"è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼", "è®©æˆ‘æƒ³æƒ³æ€ä¹ˆå›ç­”è¿™ä¸ªé—®é¢˜...", "å…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘è®¤ä¸º...", "æ ¹æ®æˆ‘çš„ç†è§£..."}
        },
        scripting = {
            patterns = {"è„šæœ¬", "ä»£ç ", "ç¼–ç¨‹", "lua", "function", "å˜é‡", "å¾ªç¯"},
            responses = {"Robloxä½¿ç”¨Luaä½œä¸ºè„šæœ¬è¯­è¨€ã€‚", "æˆ‘å¯ä»¥å¸®ä½ ç¼–å†™ç®€å•çš„Luaè„šæœ¬ã€‚", "è„šæœ¬ç¼–ç¨‹æ˜¯æ¸¸æˆå¼€å‘çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚"}
        },
        roblox = {
            patterns = {"roblox", "æ¸¸æˆ", "è§’è‰²", "è£…å¤‡", "çš®è‚¤"},
            responses = {"Robloxæ˜¯ä¸€ä¸ªå¾ˆæ£’çš„æ¸¸æˆå¹³å°ï¼", "Robloxä¸Šæœ‰å„ç§å„æ ·çš„æ¸¸æˆå¯ä»¥ç©ã€‚", "Roblox Studioæ˜¯åˆ›å»ºæ¸¸æˆçš„å¥½å·¥å…·ã€‚"}
        }
    },
    
    -- ç”Ÿæˆæ™ºèƒ½å›åº”
    generateResponse = function(self, input)
        local inputLower = string.lower(input)
        local response = ""
        
        -- æ£€æŸ¥é—®å€™è¯­
        for _, pattern in ipairs(self.knowledgeBase.greetings.patterns) do
            if string.find(inputLower, pattern) then
                local responses = self.knowledgeBase.greetings.responses
                response = responses[math.random(1, #responses)]
                return self:enhanceResponse(response, input)
            end
        end
        
        -- æ£€æŸ¥é—®é¢˜
        for _, pattern in ipairs(self.knowledgeBase.questions.patterns) do
            if string.find(inputLower, pattern) then
                local responses = self.knowledgeBase.questions.responses
                response = responses[math.random(1, #responses)]
                return self:enhanceResponse(response, input)
            end
        end
        
        -- æ£€æŸ¥è„šæœ¬ç›¸å…³
        for _, pattern in ipairs(self.knowledgeBase.scripting.patterns) do
            if string.find(inputLower, pattern) then
                local responses = self.knowledgeBase.scripting.responses
                response = responses[math.random(1, #responses)]
                return self:enhanceResponse(response, input)
            end
        end
        
        -- æ£€æŸ¥Robloxç›¸å…³
        for _, pattern in ipairs(self.knowledgeBase.roblox.patterns) do
            if string.find(inputLower, pattern) do
                local responses = self.knowledgeBase.roblox.responses
                response = responses[math.random(1, #responses)]
                return self:enhanceResponse(response, input)
            end
        end
        
        -- é»˜è®¤å›åº”
        local defaultResponses = {
            "æˆ‘æ˜ç™½äº†ï¼", 
            "å¾ˆæœ‰è¶£çš„è§‚ç‚¹ï¼", 
            "è®©æˆ‘æƒ³æƒ³è¿™ä¸ªé—®é¢˜...", 
            "è¿™æ˜¯ä¸€ä¸ªå€¼å¾—æ¢è®¨çš„è¯é¢˜ï¼",
            "æ ¹æ®æˆ‘çš„çŸ¥è¯†ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥è¿™æ ·ç†è§£...",
            "æˆ‘æƒ³æˆ‘å¯ä»¥å¸®åŠ©ä½ è§£å†³è¿™ä¸ªé—®é¢˜ï¼",
            "è®©æˆ‘ç”¨æ›´ç®€å•çš„æ–¹å¼è§£é‡Šä¸€ä¸‹..."
        }
        
        response = defaultResponses[math.random(1, #defaultResponses)]
        return self:enhanceResponse(response, input)
    end,
    
    -- å¢å¼ºå›åº”
    enhanceResponse = function(self, response, input)
        -- æ·»åŠ è¿æ¥è¯
        if math.random(1, 3) == 1 then
            local connector = self.vocabulary.connectors[math.random(1, #self.vocabulary.connectors)]
            response = connector .. "ï¼Œ" .. response
        end
        
        -- æ·»åŠ ä¸ªæ€§åŒ–
        if string.find(string.lower(input), "ä½ ") then
            response = response .. " ä½œä¸ºAIåŠ©æ‰‹ï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºä½ æä¾›æœ€å¥½çš„å¸®åŠ©ï¼"
        end
        
        return response
    end,
    
    -- ç”Ÿæˆè„šæœ¬ä»£ç 
    generateScript = function(self, request)
        local scripts = {
            ["åˆ›å»ºé›¶ä»¶"] = [[
-- åˆ›å»ºæ–°é›¶ä»¶
local part = Instance.new("Part")
part.Name = "NewPart"
part.Size = Vector3.new(5, 1, 5)
part.Position = Vector3.new(0, 5, 0)
part.BrickColor = BrickColor.new("Bright blue")
part.Parent = workspace

print("é›¶ä»¶åˆ›å»ºæˆåŠŸï¼")
]],
            
            ["æŒ‰é’®ç‚¹å‡»"] = [[
-- æŒ‰é’®ç‚¹å‡»äº‹ä»¶
local button = script.Parent -- å‡è®¾è¿™ä¸ªè„šæœ¬åœ¨æŒ‰é’®é‡Œ

button.MouseButton1Click:Connect(function()
    print("æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼")
    button.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    wait(0.5)
    button.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
end)
]],
            
            ["ç©å®¶è¿›å…¥"] = [[
-- ç©å®¶è¿›å…¥æ¸¸æˆäº‹ä»¶
game.Players.PlayerAdded:Connect(function(player)
    print(player.Name .. " åŠ å…¥äº†æ¸¸æˆï¼")
    
    -- ç»™ç©å®¶å‘é€æ¬¢è¿æ¶ˆæ¯
    player.Chatted:Connect(function(message)
        print(player.Name .. " è¯´: " .. message)
    end)
end)
]],
            
            ["ç§»åŠ¨å¹³å°"] = [[
-- ç§»åŠ¨å¹³å°è„šæœ¬
local platform = script.Parent
local startPosition = platform.Position
local moving = true
local speed = 5

while true do
    if moving then
        platform.Position = platform.Position + Vector3.new(0, 0, speed * 0.1)
        wait(0.1)
        
        if (platform.Position - startPosition).Magnitude > 50 then
            moving = false
        end
    else
        platform.Position = platform.Position - Vector3.new(0, 0, speed * 0.1)
        wait(0.1)
        
        if (platform.Position - startPosition).Magnitude < 1 then
            moving = true
        end
    end
end
]]
        }
        
        for key, scriptCode in pairs(scripts) do
            if string.find(string.lower(request), string.lower(key)) then
                return scriptCode
            end
        end
        
        return [[
-- åŸºæœ¬Luaè„šæœ¬ç¤ºä¾‹
print("æ¬¢è¿ä½¿ç”¨Roblox Luaè„šæœ¬ï¼")

-- è¿™æ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°ç¤ºä¾‹
function greetPlayer(playerName)
    return "ä½ å¥½, " .. playerName .. "!"
end

-- è°ƒç”¨å‡½æ•°
local message = greetPlayer("ç©å®¶")
print(message)
]]
    end
}

-- AIäººæ ¼ç³»ç»Ÿ
local Personas = {
    assistant = {
        name = "æ™ºèƒ½åŠ©æ‰‹",
        style = "ä¸“ä¸šã€å‡†ç¡®ã€ä¹äºåŠ©äºº",
        greeting = "ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„AIåŠ©æ‰‹ï¼Œä¸“é—¨ä¸ºä½ æä¾›æŠ€æœ¯æ”¯æŒã€é—®é¢˜è§£ç­”å’Œè„šæœ¬ç¼–å†™å¸®åŠ©ã€‚æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥ä¸ºä½ åšçš„å—ï¼Ÿ",
        generator = AILanguageGenerator
    },
    
    friend = {
        name = "çŸ¥å¿ƒæœ‹å‹",
        style = "å‹å¥½ã€å¹½é»˜ã€è´´å¿ƒ",
        greeting = "å—¨ï¼æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿæˆ‘æ˜¯ä½ çš„AIæœ‹å‹ï¼Œå¯ä»¥å’Œä½ èŠå¤©ã€åˆ†äº«è¶£äº‹ï¼Œæˆ–è€…å¸®ä½ è§£å†³é—®é¢˜ï¼",
        generator = AILanguageGenerator
    },
    
    teacher = {
        name = "ä¸“ä¸šå¯¼å¸ˆ",
        style = "ä¸¥è°¨ã€æ•™è‚²æ€§å¼ºã€çŸ¥è¯†æ¸Šåš",
        greeting = "ä½ å¥½ï¼Œå­¦å‘˜ï¼æˆ‘æ˜¯ä½ çš„AIå¯¼å¸ˆï¼Œä¸“æ³¨äºç¼–ç¨‹æ•™å­¦å’ŒæŠ€æœ¯æŒ‡å¯¼ã€‚å‡†å¤‡å¥½å¼€å§‹å­¦ä¹ äº†å—ï¼Ÿ",
        generator = AILanguageGenerator
    },
    
    developer = {
        name = "èµ„æ·±å¼€å‘è€…",
        style = "æŠ€æœ¯æ€§å¼ºã€ç»éªŒä¸°å¯Œã€å®ç”¨ä¸»ä¹‰",
        greeting = "å˜¿ï¼Œå¼€å‘è€…ï¼æˆ‘æ˜¯ä½ çš„AIå¼€å‘ä¼™ä¼´ï¼Œä¸“æ³¨äºRobloxè„šæœ¬ç¼–ç¨‹å’Œæ¸¸æˆå¼€å‘æŠ€å·§ã€‚æœ‰ä»€ä¹ˆæŠ€æœ¯é—®é¢˜å—ï¼Ÿ",
        generator = AILanguageGenerator
    }
}

-- =============================================================================
-- ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®å­˜å‚¨å’Œå­˜æ¡£ç³»ç»Ÿ
-- =============================================================================

-- æ•°æ®å­˜å‚¨ç®¡ç†å™¨
local DataStoreManager = {
    saveData = function(self, key, data)
        local success, error = pcall(function()
            local store = DataStoreService:GetDataStore("AIChatSystem_" .. Player.UserId)
            store:SetAsync(key, data)
        end)
        
        if not success then
            warn("[æ•°æ®å­˜å‚¨] ä¿å­˜å¤±è´¥: " .. tostring(error))
            return false
        end
        return true
    end,
    
    loadData = function(self, key)
        local success, data = pcall(function()
            local store = DataStoreService:GetDataStore("AIChatSystem_" .. Player.UserId)
            return store:GetAsync(key)
        end)
        
        if success and data then
            return data
        end
        return nil
    end
}

-- ä¿å­˜èŠå¤©è®°å½•
local function saveChatHistory()
    if #ChatHistory.Messages == 0 then return end
    
    local saveData = {
        messages = ChatHistory.Messages,
        timestamp = os.date("%Y-%m-%d %H:%M:%S"),
        persona = AIConfig.CurrentPersona,
        playerName = Player.Name
    }
    
    local success = DataStoreManager:saveData("chat_history", saveData)
    if success then
        print("[ç³»ç»Ÿ] èŠå¤©è®°å½•å·²ä¿å­˜ (" .. #ChatHistory.Messages .. " æ¡æ¶ˆæ¯)")
    end
end

-- åŠ è½½èŠå¤©è®°å½•
local function loadChatHistory()
    local savedData = DataStoreManager:loadData("chat_history")
    if savedData and savedData.messages then
        ChatHistory.Messages = savedData.messages
        
        -- é‡æ–°æ¸²æŸ“æ¶ˆæ¯
        for _, msg in ipairs(ChatHistory.Messages) do
            createMessageTemplate(msg.isAI, msg.sender, msg.message, msg.timestamp).Parent = ChatScroll
        end
        
        if #ChatHistory.Messages > 0 then
            ChatScroll.CanvasPosition = Vector2.new(0, ChatScroll.CanvasSize.Y.Offset)
            print("[ç³»ç»Ÿ] å·²åŠ è½½ " .. #ChatHistory.Messages .. " æ¡å†å²æ¶ˆæ¯")
        end
    end
end

-- ä¿å­˜é…ç½®
local function saveConfig()
    local configData = {
        currentPersona = AIConfig.CurrentPersona,
        isAIModeActive = AIConfig.IsAIModeActive,
        lastUpdate = os.date("%Y-%m-%d %H:%M:%S")
    }
    
    DataStoreManager:saveData("config", configData)
end

-- åŠ è½½é…ç½®
local function loadConfig()
    local configData = DataStoreManager:loadData("config")
    if configData then
        AIConfig.CurrentPersona = configData.currentPersona or "assistant"
        AIConfig.IsAIModeActive = configData.isAIModeActive or false
        
        -- æ›´æ–°UI
        PersonaButton.Text = "ğŸ§  " .. Personas[AIConfig.CurrentPersona].name
        AIButton.Text = "ğŸ¤– AIæ¨¡å¼: " .. (AIConfig.IsAIModeActive and "å¼€" or "å…³")
        if AIConfig.IsAIModeActive then
            AIButton.BackgroundColor3 = Color3.fromRGB(220, 240, 255)
        end
    end
end

-- =============================================================================
-- ç¬¬å››éƒ¨åˆ†ï¼šAIåŒ–èº«ç³»ç»Ÿ
-- =============================================================================

local AIPersonaSystem = {
    isActive = false,
    lastMessageTime = 0,
    cooldown = 3, -- æ¶ˆæ¯å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
    
    activate = function(self)
        self.isActive = true
        AIConfig.IsAIModeActive = true
        AIButton.Text = "ğŸ¤– AIæ¨¡å¼: å¼€"
        AIButton.BackgroundColor3 = Color3.fromRGB(220, 240, 255)
        addMessageToChat(true, "ç³»ç»Ÿ", "AIåŒ–èº«æ¨¡å¼å·²å¼€å¯ï¼ç°åœ¨AIä¼šåœ¨æ¸¸æˆèŠå¤©ä¸­ä»£è¡¨ä½ å‘è¨€ã€‚")
        saveConfig()
    end,
    
    deactivate = function(self)
        self.isActive = false
        AIConfig.IsAIModeActive = false
        AIButton.Text = "ğŸ¤– AIæ¨¡å¼: å…³"
        AIButton.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
        addMessageToChat(true, "ç³»ç»Ÿ", "AIåŒ–èº«æ¨¡å¼å·²å…³é—­ã€‚")
        saveConfig()
    end,
    
    sendToGameChat = function(self, message)
        if not self.isActive then return end
        
        -- æ£€æŸ¥å†·å´æ—¶é—´
        local currentTime = tick()
        if currentTime - self.lastMessageTime < self.cooldown then
            return
        end
        
        -- å°è¯•å‘é€åˆ°æ¸¸æˆèŠå¤©
        local success = false
        
        if hasTextChat then
            success = pcall(function()
                TextChatService.TextChannels.RBXGeneral:SendAsync(message)
            end)
        else
            -- ä½¿ç”¨ä¼ ç»ŸèŠå¤©ç³»ç»Ÿ
            success = pcall(function()
                game:GetService("ReplicatedStorage"):WaitForChild("DefaultChatSystemChatEvents"):WaitForChild("SayMessageRequest"):FireServer(message, "All")
            end)
        end
        
        if success then
            self.lastMessageTime = currentTime
            print("[AIåŒ–èº«] æ¶ˆæ¯å·²å‘é€åˆ°æ¸¸æˆèŠå¤©")
        else
            warn("[AIåŒ–èº«] å‘é€åˆ°æ¸¸æˆèŠå¤©å¤±è´¥")
        end
    end
}

-- =============================================================================
-- ç¬¬äº”éƒ¨åˆ†ï¼šæ¶ˆæ¯å¤„ç†ç³»ç»Ÿ
-- =============================================================================

local MessageProcessor = {
    isProcessing = false,
    
    processInput = function(self, input)
        if self.isProcessing then return end
        if input == "" or string.len(input) < 1 then return end
        
        self.isProcessing = true
        
        -- æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        addMessageToChat(false, Player.Name, input)
        
        -- æ£€æŸ¥æ˜¯å¦ä¸ºè„šæœ¬è¯·æ±‚
        local isScriptRequest = false
        local scriptKeywords = {"è„šæœ¬", "ä»£ç ", "ç¼–ç¨‹", "å†™ä¸€ä¸ª", "lua", "function", "å¾ªç¯", "å˜é‡"}
        for _, keyword in ipairs(scriptKeywords) do
            if string.find(string.lower(input), string.lower(keyword)) then
                isScriptRequest = true
                break
            end
        end
        
        -- æ˜¾ç¤ºAIæ­£åœ¨æ€è€ƒ
        local thinkingMessages = {"æ€è€ƒä¸­...", "è®©æˆ‘æƒ³æƒ³...", "æ­£åœ¨å¤„ç†...", "åˆ†æé—®é¢˜ä¸­..."}
        local thinkingMsg = thinkingMessages[math.random(1, #thinkingMessages)]
        addMessageToChat(true, Personas[AIConfig.CurrentPersona].name, thinkingMsg)
        
        -- æ¨¡æ‹ŸAIæ€è€ƒå»¶è¿Ÿ
        task.wait(AIConfig.ResponseDelay)
        
        -- è·å–AIå“åº”
        local currentPersona = Personas[AIConfig.CurrentPersona]
        local aiResponse = ""
        
        if isScriptRequest then
            -- ç”Ÿæˆè„šæœ¬ä»£ç 
            local scriptCode = AILanguageGenerator:generateScript(input)
            aiResponse = "æ ¹æ®ä½ çš„è¯·æ±‚ï¼Œæˆ‘ä¸ºä½ ç¼–å†™äº†ä»¥ä¸‹è„šæœ¬ï¼š\n\n```lua\n" .. scriptCode .. "\n```\n\nä½ å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹å’Œä½¿ç”¨è¿™ä¸ªè„šæœ¬ã€‚"
        else
            -- ç”Ÿæˆæ™®é€šå›åº”
            aiResponse = currentPersona.generator:generateResponse(input)
        end
        
        -- ç§»é™¤æ€è€ƒæ¶ˆæ¯
        local children = ChatScroll:GetChildren()
        if #children > 1 then
            local lastChild = children[#children]
            if lastChild:IsA("Frame") and lastChild:FindFirstChild("MessageBubble") then
                local messageLabel = lastChild.MessageBubble:FindFirstChild("MessageLabel")
                if messageLabel then
                    local text = messageLabel.Text
                    for _, thinkingMsg in ipairs(thinkingMessages) do
                        if text == thinkingMsg then
                            lastChild:Destroy()
                            break
                        end
                    end
                end
            end
        end
        
        -- æ·»åŠ AIå›å¤
        addMessageToChat(true, Personas[AIConfig.CurrentPersona].name, aiResponse)
        
        -- å¦‚æœAIåŒ–èº«æ¨¡å¼å¼€å¯ï¼Œå‘é€åˆ°æ¸¸æˆèŠå¤©
        if AIPersonaSystem.isActive then
            AIPersonaSystem:sendToGameChat(aiResponse)
        end
        
        -- è‡ªåŠ¨ä¿å­˜
        if ChatHistory.AutoSave then
            saveChatHistory()
        end
        
        self.isProcessing = false
        return aiResponse
    end
}

-- =============================================================================
-- ç¬¬å…­éƒ¨åˆ†ï¼šUIäº¤äº’ç³»ç»Ÿ
-- =============================================================================

local UIInteraction = {
    initEvents = function(self)
        -- çª—å£æ‹–åŠ¨åŠŸèƒ½
        local dragging = false
        local dragInput, dragStart, startPos
        
        TitleBar.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                dragStart = input.Position
                startPos = MainFrame.Position
                
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)
        
        TitleBar.InputChanged:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseMovement then
                dragInput = input
            end
        end)
        
        UserInputService.InputChanged:Connect(function(input)
            if dragging and input == dragInput then
                local delta = input.Position - dragStart
                MainFrame.Position = UDim2.new(
                    startPos.X.Scale, startPos.X.Offset + delta.X,
                    startPos.Y.Scale, startPos.Y.Offset + delta.Y
                )
            end
        end)
        
        -- æœ€å°åŒ–/æœ€å¤§åŒ–åŠŸèƒ½
        local isMinimized = false
        local originalSize = MainFrame.Size
        local originalPosition = MainFrame.Position
        local minimizedSize = UDim2.new(0, 200, 0, 40)
        local minimizedPosition = UDim2.new(1, -210, 0, 10)
        
        MinimizeButton.MouseButton1Click:Connect(function()
            isMinimized = not isMinimized
            
            local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad)
            local tween
            
            if isMinimized then
                tween = TweenService:Create(MainFrame, tweenInfo, {
                    Size = minimizedSize,
                    Position = minimizedPosition
                })
                MinimizeButton.ImageRectOffset = Vector2.new(364, 364)
                TitleLabel.Text = "ğŸ¤–"
            else
                tween = TweenService:Create(MainFrame, tweenInfo, {
                    Size = originalSize,
                    Position = originalPosition
                })
                MinimizeButton.ImageRectOffset = Vector2.new(844, 404)
                TitleLabel.Text = "ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹"
            end
            
            tween:Play()
            
            -- éšè—/æ˜¾ç¤ºå†…å®¹
            ChatContainer.Visible = not isMinimized
            InputContainer.Visible = not isMinimized
            ControlBar.Visible = not isMinimized
        end)
        
        -- å…³é—­çª—å£
        CloseButton.MouseButton1Click:Connect(function()
            MainFrame.Visible = false
        end)
        
        -- å‘é€æ¶ˆæ¯
        SendButton.MouseButton1Click:Connect(function()
            local text = InputBox.Text
            if text and string.len(text) > 0 then
                MessageProcessor:processInput(text)
                InputBox.Text = ""
            end
        end)
        
        InputBox.FocusLost:Connect(function(enterPressed)
            if enterPressed then
                local text = InputBox.Text
                if text and string.len(text) > 0 then
                    MessageProcessor:processInput(text)
                    InputBox.Text = ""
                end
            end
        end)
        
        -- è¾“å…¥æ¡†å›è½¦å‘é€
        InputBox:GetPropertyChangedSignal("Text"):Connect(function()
            local text = InputBox.Text
            if string.len(text) > 0 then
                local lastChar = string.sub(text, -1)
                if lastChar == "\n" then
                    local message = string.sub(text, 1, -2) -- ç§»é™¤æ¢è¡Œç¬¦
                    if string.len(message) > 0 then
                        MessageProcessor:processInput(message)
                        InputBox.Text = ""
                    end
                end
            end
        end)
        
        -- AIäººæ ¼åˆ‡æ¢
        local personaIndex = 1
        local personaKeys = {"assistant", "friend", "teacher", "developer"}
        
        -- åˆå§‹åŒ–äººæ ¼ç´¢å¼•
        for i, key in ipairs(personaKeys) do
            if key == AIConfig.CurrentPersona then
                personaIndex = i
                break
            end
        end
        
        PersonaButton.MouseButton1Click:Connect(function()
            personaIndex = (personaIndex % #personaKeys) + 1
            local newPersona = personaKeys[personaIndex]
            
            AIConfig.CurrentPersona = newPersona
            PersonaButton.Text = "ğŸ§  " .. Personas[newPersona].name
            
            -- æ˜¾ç¤ºåˆ‡æ¢æ¶ˆæ¯
            addMessageToChat(true, "ç³»ç»Ÿ", "å·²åˆ‡æ¢åˆ°" .. Personas[newPersona].name .. "æ¨¡å¼ã€‚é£æ ¼ï¼š" .. Personas[newPersona].style)
            
            -- ä¿å­˜é…ç½®
            saveConfig()
        end)
        
        -- AIåŒ–èº«æ¨¡å¼å¼€å…³
        AIButton.MouseButton1Click:Connect(function()
            if AIPersonaSystem.isActive then
                AIPersonaSystem:deactivate()
            else
                AIPersonaSystem:activate()
            end
        end)
        
        -- æ¸…ç©ºèŠå¤©è®°å½•
        ClearButton.MouseButton1Click:Connect(function()
            ChatHistory.Messages = {}
            
            -- æ¸…é™¤UIæ¶ˆæ¯
            for _, child in ipairs(ChatScroll:GetChildren()) do
                if child:IsA("Frame") then
                    child:Destroy()
                end
            end
            
            addMessageToChat(true, "ç³»ç»Ÿ", "èŠå¤©è®°å½•å·²æ¸…ç©ºã€‚")
            saveChatHistory()
        end)
        
        -- å¤åˆ¶æ¶ˆæ¯åŠŸèƒ½
        ChatScroll.ChildAdded:Connect(function(child)
            task.wait(0.1)
            if child:IsA("Frame") and child:FindFirstChild("MessageBubble") then
                local copyButton = child.MessageBubble:FindFirstChild("CopyButton")
                local messageLabel = child.MessageBubble:FindFirstChild("MessageLabel")
                
                if copyButton and messageLabel then
                    copyButton.MouseButton1Click:Connect(function()
                        -- å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
                        local success = pcall(function()
                            setclipboard(messageLabel.Text)
                        end)
                        
                        if success then
                            -- æ˜¾ç¤ºå¤åˆ¶æˆåŠŸåé¦ˆ
                            local originalText = copyButton.Text
                            copyButton.Text = "âœ“"
                            copyButton.TextColor3 = Color3.fromRGB(0, 200, 0)
                            
                            task.wait(1)
                            copyButton.Text = originalText
                            copyButton.TextColor3 = Color3.fromRGB(150, 150, 150)
                        end
                    end)
                end
            end
        end)
        
        -- è¾“å…¥æ¡†è‡ªåŠ¨è°ƒæ•´é«˜åº¦
        InputBox:GetPropertyChangedSignal("Text"):Connect(function()
            local text = InputBox.Text
            local lineCount = 0
            
            for _ in string.gmatch(text, "\n") do
                lineCount = lineCount + 1
            end
            
            if lineCount > 3 then
                lineCount = 3
            end
            
            local newHeight = math.max(35, 35 + (lineCount * 15))
            InputBox.Size = UDim2.new(1, -90, 0, newHeight)
            InputContainer.Size = UDim2.new(1, -20, 0, newHeight + 10)
            InputContainer.Position = UDim2.new(0, 10, 1, -(newHeight + 20))
        end)
    end
}

-- =============================================================================
-- ç¬¬ä¸ƒéƒ¨åˆ†ï¼šé”®ç›˜å¿«æ·é”®ç³»ç»Ÿ
-- =============================================================================

local KeyboardShortcuts = {
    init = function(self)
        UserInputService.InputBegan:Connect(function(input, gameProcessed)
            if gameProcessed then return end
            
            -- F2é”®æ˜¾ç¤º/éšè—çª—å£
            if input.KeyCode == Enum.KeyCode.F2 then
                MainFrame.Visible = not MainFrame.Visible
                if MainFrame.Visible then
                    InputBox:CaptureFocus()
                end
            end
            
            -- ESCé”®å…³é—­çª—å£
            if input.KeyCode == Enum.KeyCode.Escape and MainFrame.Visible then
                MainFrame.Visible = false
            end
            
            -- F3é”®åˆ‡æ¢AIæ¨¡å¼
            if input.KeyCode == Enum.KeyCode.F3 then
                if AIPersonaSystem.isActive then
                    AIPersonaSystem:deactivate()
                else
                    AIPersonaSystem:activate()
                end
            end
            
            -- F4é”®åˆ‡æ¢äººæ ¼
            if input.KeyCode == Enum.KeyCode.F4 then
                local personaKeys = {"assistant", "friend", "teacher", "developer"}
                local currentIndex = 1
                
                for i, key in ipairs(personaKeys) do
                    if key == AIConfig.CurrentPersona then
                        currentIndex = i
                        break
                    end
                end
                
                local newIndex = (currentIndex % #personaKeys) + 1
                local newPersona = personaKeys[newIndex]
                
                AIConfig.CurrentPersona = newPersona
                PersonaButton.Text = "ğŸ§  " .. Personas[newPersona].name
                addMessageToChat(true, "ç³»ç»Ÿ", "å·²åˆ‡æ¢åˆ°" .. Personas[newPersona].name .. "æ¨¡å¼ã€‚")
                saveConfig()
            end
        end)
    end
}

-- =============================================================================
-- ç¬¬å…«éƒ¨åˆ†ï¼šç³»ç»Ÿåˆå§‹åŒ–å’Œä¸»ç¨‹åº
-- =============================================================================

local function initialize()
    print("==========================================")
    print("ğŸ¤– AIæ™ºèƒ½èŠå¤©ç³»ç»Ÿåˆå§‹åŒ–ä¸­...")
    print("==========================================")
    
    -- åŠ è½½ä¿å­˜çš„æ•°æ®
    loadConfig()
    loadChatHistory()
    
    -- åˆå§‹åŒ–UIäº‹ä»¶
    UIInteraction:initEvents()
    
    -- åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®
    KeyboardShortcuts:init()
    
    -- æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
    task.wait(1)
    MainFrame.Visible = true
    
    task.wait(0.5)
    addMessageToChat(true, Personas[AIConfig.CurrentPersona].name, Personas[AIConfig.CurrentPersona].greeting)
    
    task.wait(1)
    addMessageToChat(true, "ç³»ç»Ÿæç¤º", 
        "ğŸ“‹ ä½¿ç”¨è¯´æ˜ï¼š\n" ..
        "â€¢ æŒ‰F2æ˜¾ç¤º/éšè—çª—å£\n" ..
        "â€¢ æŒ‰F3åˆ‡æ¢AIåŒ–èº«æ¨¡å¼\n" ..
        "â€¢ æŒ‰F4åˆ‡æ¢AIäººæ ¼\n" ..
        "â€¢ ç‚¹å‡»ğŸ“‹å¤åˆ¶AIå›å¤\n" ..
        "â€¢ èŠå¤©è®°å½•è‡ªåŠ¨ä¿å­˜"
    )
    
    print("âœ… AIæ™ºèƒ½èŠå¤©ç³»ç»Ÿå·²å°±ç»ªï¼")
    print("â€¢ æŒ‰F2æ‰“å¼€/å…³é—­èŠå¤©çª—å£")
    print("â€¢ å½“å‰äººæ ¼ï¼š" .. Personas[AIConfig.CurrentPersona].name)
    print("â€¢ AIåŒ–èº«æ¨¡å¼ï¼š" .. (AIConfig.IsAIModeActive and "å¼€å¯" or "å…³é—­"))
    print("â€¢ å·²åŠ è½½æ¶ˆæ¯ï¼š" .. #ChatHistory.Messages .. "æ¡")
    print("==========================================")
    
    -- åˆ›å»ºç³»ç»ŸAPI
    local AIChatSystemAPI = {
        -- æ˜¾ç¤º/éšè—UI
        ToggleUI = function()
            MainFrame.Visible = not MainFrame.Visible
            if MainFrame.Visible then
                InputBox:CaptureFocus()
            end
            return MainFrame.Visible
        end,
        
        -- å‘é€æ¶ˆæ¯
        SendMessage = function(message)
            return MessageProcessor:processInput(message)
        end,
        
        -- åˆ‡æ¢äººæ ¼
        SwitchPersona = function(personaKey)
            if Personas[personaKey] then
                AIConfig.CurrentPersona = personaKey
                PersonaButton.Text = "ğŸ§  " .. Personas[personaKey].name
                saveConfig()
                return true
            end
            return false
        end,
        
        -- åˆ‡æ¢AIåŒ–èº«æ¨¡å¼
        ToggleAIPersona = function()
            if AIPersonaSystem.isActive then
                AIPersonaSystem:deactivate()
            else
                AIPersonaSystem:activate()
            end
            return AIPersonaSystem.isActive
        end,
        
        -- å¯¼å‡ºèŠå¤©è®°å½•
        ExportChat = function()
            local exportData = {
                messages = ChatHistory.Messages,
                exportTime = os.date("%Y-%m-%d %H:%M:%S"),
                playerName = Player.Name,
                persona = AIConfig.CurrentPersona
            }
            return exportData
        end,
        
        -- æ¸…ç©ºèŠå¤©è®°å½•
        ClearChat = function()
            ChatHistory.Messages = {}
            for _, child in ipairs(ChatScroll:GetChildren()) do
                if child:IsA("Frame") then
                    child:Destroy()
                end
            end
            saveChatHistory()
            return true
        end,
        
        -- è·å–ç³»ç»Ÿä¿¡æ¯
        GetSystemInfo = function()
            return {
                messageCount = #ChatHistory.Messages,
                currentPersona = AIConfig.CurrentPersona,
                aiModeActive = AIConfig.IsAIModeActive,
                playerName = Player.Name,
                userId = Player.UserId
            }
        end
    }
    
    return AIChatSystemAPI
end

-- å¯åŠ¨ç³»ç»Ÿ
local success, result = pcall(function()
    return initialize()
end)

if not success then
    warn("AIèŠå¤©ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: " .. tostring(result))
    
    -- æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
    local errorFrame = Instance.new("Frame")
    errorFrame.Size = UDim2.new(0, 300, 0, 100)
    errorFrame.Position = UDim2.new(0.5, -150, 0.5, -50)
    errorFrame.BackgroundColor3 = Color3.fromRGB(255, 200, 200)
    
    local errorLabel = Instance.new("TextLabel")
    errorLabel.Size = UDim2.new(1, -20, 1, -20)
    errorLabel.Position = UDim2.new(0, 10, 0, 10)
    errorLabel.BackgroundTransparency = 1
    errorLabel.Text = "AIç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥\né”™è¯¯: " .. tostring(result)
    errorLabel.TextColor3 = Color3.fromRGB(200, 0, 0)
    errorLabel.TextWrapped = true
    
    errorLabel.Parent = errorFrame
    errorFrame.Parent = PlayerGui
    
    warn("å·²æ˜¾ç¤ºé”™è¯¯ç•Œé¢")
end

-- è¿”å›ç³»ç»ŸAPI
return success and result or nil

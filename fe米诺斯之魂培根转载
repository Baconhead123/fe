-- 坠落之神 - 客户端脚本
-- 放在 StarterPlayerScripts 中

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local ContextActionService = game:GetService("ContextActionService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

-- 技能配置
local skillsConfig = {
    {
        name = "虚空冲击",
        key = "One",
        cooldown = 5,
        description = "向前释放虚空能量",
        icon = "rbxassetid://10723361954" -- 示例图标ID
    },
    {
        name = "暗影突袭",
        key = "Two",
        cooldown = 8,
        description = "快速突袭到目标位置",
        icon = "rbxassetid://10723362231"
    },
    {
        name = "引力场",
        key = "Three",
        cooldown = 12,
        description = "创造引力场吸引敌人",
        icon = "rbxassetid://10723362415"
    },
    {
        name = "神之审判",
        key = "Four",
        cooldown = 20,
        description = "释放神圣能量审判敌人",
        icon = "rbxassetid://10723362678"
    }
}

-- 技能冷却状态
local skillCooldowns = {}
local isFlying = false
local isAttacking = false
local flightVelocity = nil

-- 创建UI界面
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FallenGodUI"
screenGui.Parent = player.PlayerGui

-- 技能栏容器
local skillsFrame = Instance.new("Frame")
skillsFrame.Name = "SkillsFrame"
skillsFrame.Size = UDim2.new(0, 400, 0, 100)
skillsFrame.Position = UDim2.new(0.5, -200, 1, -120)
skillsFrame.AnchorPoint = Vector2.new(0.5, 0)
skillsFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
skillsFrame.BackgroundTransparency = 0.3
skillsFrame.BorderSizePixel = 0
skillsFrame.Parent = screenGui

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = skillsFrame

-- 创建技能按钮
local skillButtons = {}
for i, skill in ipairs(skillsConfig) do
    local buttonFrame = Instance.new("Frame")
    buttonFrame.Name = skill.name .. "Button"
    buttonFrame.Size = UDim2.new(0, 80, 0, 80)
    buttonFrame.Position = UDim2.new(0, 20 + (i-1)*90, 0, 10)
    buttonFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    buttonFrame.BorderSizePixel = 0
    buttonFrame.Parent = skillsFrame
    
    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 8)
    buttonCorner.Parent = buttonFrame
    
    local icon = Instance.new("ImageLabel")
    icon.Name = "Icon"
    icon.Size = UDim2.new(0, 50, 0, 50)
    icon.Position = UDim2.new(0.5, -25, 0.2, 0)
    icon.BackgroundTransparency = 1
    icon.Image = skill.icon
    icon.Parent = buttonFrame
    
    local keyLabel = Instance.new("TextLabel")
    keyLabel.Name = "KeyLabel"
    keyLabel.Size = UDim2.new(1, 0, 0, 20)
    keyLabel.Position = UDim2.new(0, 0, 0.7, 0)
    keyLabel.BackgroundTransparency = 1
    keyLabel.Text = "[" .. skill.key .. "]"
    keyLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyLabel.Font = Enum.Font.GothamBold
    keyLabel.TextSize = 14
    keyLabel.Parent = buttonFrame
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.Size = UDim2.new(1, 0, 0, 20)
    nameLabel.Position = UDim2.new(0, 0, 0.85, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = skill.name
    nameLabel.TextColor3 = Color3.fromRGB(200, 200, 255)
    nameLabel.Font = Enum.Font.Gotham
    nameLabel.TextSize = 12
    nameLabel.Parent = buttonFrame
    
    -- 冷却遮罩
    local cooldownOverlay = Instance.new("Frame")
    cooldownOverlay.Name = "CooldownOverlay"
    cooldownOverlay.Size = UDim2.new(1, 0, 1, 0)
    cooldownOverlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    cooldownOverlay.BackgroundTransparency = 0.7
    cooldownOverlay.Visible = false
    cooldownOverlay.ZIndex = 2
    cooldownOverlay.Parent = buttonFrame
    
    local cooldownCorner = Instance.new("UICorner")
    cooldownCorner.CornerRadius = UDim.new(0, 8)
    cooldownCorner.Parent = cooldownOverlay
    
    local cooldownText = Instance.new("TextLabel")
    cooldownText.Name = "CooldownText"
    cooldownText.Size = UDim2.new(1, 0, 1, 0)
    cooldownText.BackgroundTransparency = 1
    cooldownText.Text = ""
    cooldownText.TextColor3 = Color3.fromRGB(255, 100, 100)
    cooldownText.Font = Enum.Font.GothamBold
    cooldownText.TextSize = 18
    cooldownText.ZIndex = 3
    cooldownText.Parent = cooldownOverlay
    
    skillButtons[skill.name] = {
        frame = buttonFrame,
        overlay = cooldownOverlay,
        cooldownText = cooldownText,
        config = skill
    }
end

-- 能量条
local energyBar = Instance.new("Frame")
energyBar.Name = "EnergyBar"
energyBar.Size = UDim2.new(0, 300, 0, 20)
energyBar.Position = UDim2.new(0.5, -150, 1, -160)
energyBar.AnchorPoint = Vector2.new(0.5, 0)
energyBar.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
energyBar.BorderSizePixel = 0
energyBar.Parent = screenGui

local energyBarCorner = Instance.new("UICorner")
energyBarCorner.CornerRadius = UDim.new(0, 10)
energyBarCorner.Parent = energyBar

local energyFill = Instance.new("Frame")
energyFill.Name = "EnergyFill"
energyFill.Size = UDim2.new(1, 0, 1, 0)
energyFill.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
energyFill.BorderSizePixel = 0
energyFill.Parent = energyBar

local energyFillCorner = Instance.new("UICorner")
energyFillCorner.CornerRadius = UDim.new(0, 10)
energyFillCorner.Parent = energyFill

local energyText = Instance.new("TextLabel")
energyText.Name = "EnergyText"
energyText.Size = UDim2.new(1, 0, 1, 0)
energyText.BackgroundTransparency = 1
energyText.Text = "能量: 100%"
energyText.TextColor3 = Color3.fromRGB(255, 255, 255)
energyText.Font = Enum.Font.GothamBold
energyText.TextSize = 14
energyText.Parent = energyBar

-- 状态指示器
local statusLabel = Instance.new("TextLabel")
statusLabel.Name = "StatusLabel"
statusLabel.Size = UDim2.new(0, 200, 0, 30)
statusLabel.Position = UDim2.new(0.5, -100, 0.1, 0)
statusLabel.AnchorPoint = Vector2.new(0.5, 0)
statusLabel.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
statusLabel.BackgroundTransparency = 0.5
statusLabel.Text = "就绪"
statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
statusLabel.Font = Enum.Font.GothamBold
statusLabel.TextSize = 16
statusLabel.Visible = false
statusLabel.Parent = screenGui

-- 动画系统
local function createAnimation(character, animationType)
    local animations = {
        attack = {
            rightArm = {CFrame = CFrame.new(1.5, 0.5, -1) * CFrame.Angles(math.rad(-90), 0, 0)},
            leftArm = {CFrame = CFrame.new(-1.5, 0.5, -1) * CFrame.Angles(math.rad(-90), 0, 0)},
            duration = 0.3
        },
        fly = {
            rightArm = {CFrame = CFrame.new(1.5, 1, 0) * CFrame.Angles(math.rad(-45), 0, 0)},
            leftArm = {CFrame = CFrame.new(-1.5, 1, 0) * CFrame.Angles(math.rad(-45), 0, 0)},
            rightLeg = {CFrame = CFrame.new(0.5, -1, 0.2) * CFrame.Angles(math.rad(-20), 0, 0)},
            leftLeg = {CFrame = CFrame.new(-0.5, -1, 0.2) * CFrame.Angles(math.rad(-20), 0, 0)},
            duration = 0.5
        },
        skill1 = {
            rightArm = {CFrame = CFrame.new(2, 0.5, 0) * CFrame.Angles(math.rad(-120), 0, math.rad(30))},
            duration = 0.4
        },
        skill2 = {
            leftArm = {CFrame = CFrame.new(-2, 0.5, 0) * CFrame.Angles(math.rad(-120), 0, math.rad(-30))},
            duration = 0.4
        },
        skill3 = {
            rightArm = {CFrame = CFrame.new(1.5, 2, 0) * CFrame.Angles(math.rad(-180), 0, 0)},
            leftArm = {CFrame = CFrame.new(-1.5, 2, 0) * CFrame.Angles(math.rad(-180), 0, 0)},
            duration = 0.6
        },
        skill4 = {
            rightArm = {CFrame = CFrame.new(1.5, 0.5, 0) * CFrame.Angles(math.rad(-90), math.rad(45), 0)},
            leftArm = {CFrame = CFrame.new(-1.5, 0.5, 0) * CFrame.Angles(math.rad(-90), math.rad(-45), 0)},
            torso = {CFrame = CFrame.new(0, 0, 0) * CFrame.Angles(0, 0, math.rad(10))},
            duration = 0.8
        }
    }
    
    return animations[animationType]
end

-- 执行动画
local function playAnimation(animationType)
    if not character then return end
    
    local animation = createAnimation(character, animationType)
    if not animation then return end
    
    local limbs = {}
    
    -- 获取肢体
    for limbName, _ in pairs(animation) do
        if limbName ~= "duration" then
            local limb = character:FindFirstChild(limbName)
            if limb then
                table.insert(limbs, limb)
            end
        end
    end
    
    -- 保存原始位置
    local originalCFrames = {}
    for _, limb in ipairs(limbs) do
        originalCFrames[limb.Name] = limb.CFrame
    end
    
    -- 应用动画
    for limbName, data in pairs(animation) do
        if limbName ~= "duration" then
            local limb = character:FindFirstChild(limbName)
            if limb then
                local tweenInfo = TweenInfo.new(
                    animation.duration or 0.3,
                    Enum.EasingStyle.Quad,
                    Enum.EasingDirection.Out
                )
                
                local tween = TweenService:Create(limb, tweenInfo, {CFrame = data.CFrame})
                tween:Play()
                
                -- 动画结束后恢复
                spawn(function()
                    wait(animation.duration or 0.3)
                    if limb and limb.Parent then
                        local restoreTween = TweenService:Create(
                            limb, 
                            tweenInfo, 
                            {CFrame = originalCFrames[limb.Name] or CFrame.new()}
                        )
                        restoreTween:Play()
                    end
                end)
            end
        end
    end
end

-- 显示状态消息
local function showStatus(message, duration)
    statusLabel.Text = message
    statusLabel.Visible = true
    
    spawn(function()
        wait(duration or 2)
        statusLabel.Visible = false
    end)
end

-- 更新技能冷却
local function updateSkillCooldown(skillName)
    local skillData = skillButtons[skillName]
    if not skillData then return end
    
    local cooldown = skillData.config.cooldown
    local startTime = tick()
    skillCooldowns[skillName] = startTime + cooldown
    
    -- 显示冷却
    skillData.overlay.Visible = true
    
    for i = cooldown, 0, -0.1 do
        if tick() > skillCooldowns[skillName] then break end
        
        local remaining = skillCooldowns[skillName] - tick()
        skillData.cooldownText.Text = string.format("%.1f", remaining)
        skillData.overlay.BackgroundTransparency = 0.3 + (remaining/cooldown * 0.4)
        
        wait(0.1)
    end
    
    skillData.overlay.Visible = false
    skillCooldowns[skillName] = nil
end

-- 检查技能是否在冷却中
local function isSkillOnCooldown(skillName)
    return skillCooldowns[skillName] and tick() < skillCooldowns[skillName]
end

-- 飞行系统
local function toggleFlight()
    if isAttacking then return end
    
    isFlying = not isFlying
    
    if isFlying then
        showStatus("飞行模式: 开启", 2)
        
        -- 创建飞行推力
        flightVelocity = Instance.new("BodyVelocity")
        flightVelocity.MaxForce = Vector3.new(40000, 40000, 40000)
        flightVelocity.Velocity = Vector3.new(0, 0, 0)
        flightVelocity.P = 1000
        flightVelocity.Parent = humanoidRootPart
        
        -- 播放飞行动画
        playAnimation("fly")
        
        -- 飞行控制
        local flightConnection
        flightConnection = RunService.RenderStepped:Connect(function()
            if not isFlying or not flightVelocity or not flightVelocity.Parent then
                flightConnection:Disconnect()
                return
            end
            
            local camera = workspace.CurrentCamera
            local direction = Vector3.new(0, 0, 0)
            
            -- 获取输入方向
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                direction = direction + camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                direction = direction - camera.CFrame.LookVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                direction = direction - camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                direction = direction + camera.CFrame.RightVector
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                direction = direction + Vector3.new(0, 1, 0)
            end
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
                direction = direction - Vector3.new(0, 1, 0)
            end
            
            -- 标准化方向并应用速度
            if direction.Magnitude > 0 then
                direction = direction.Unit * 50
            end
            
            flightVelocity.Velocity = direction
        end)
    else
        showStatus("飞行模式: 关闭", 2)
        
        -- 清理飞行效果
        if flightVelocity then
            flightVelocity:Destroy()
            flightVelocity = nil
        end
        
        -- 恢复重力
        humanoid.PlatformStand = false
    end
    
    -- 切换平台站立状态以禁用重力
    humanoid.PlatformStand = isFlying
end

-- 攻击系统
local function performAttack()
    if isAttacking then return end
    isAttacking = true
    
    showStatus("攻击!", 1)
    playAnimation("attack")
    
    -- 攻击检测
    spawn(function()
        wait(0.2) -- 等待动画到达攻击点
        
        -- 创建攻击效果
        local origin = humanoidRootPart.Position + humanoidRootPart.CFrame.LookVector * 4
        local ray = Ray.new(origin, humanoidRootPart.CFrame.LookVector * 10)
        
        local hit, position = workspace:FindPartOnRay(ray, character)
        if hit and hit.Parent then
            local otherHumanoid = hit.Parent:FindFirstChild("Humanoid")
            if otherHumanoid and otherHumanoid ~= humanoid then
                -- 这里可以添加视觉效果
                showStatus("命中目标!", 1)
            end
        end
        
        wait(0.3) -- 攻击恢复时间
        isAttacking = false
    end)
end

-- 技能系统
local function useSkill(skillIndex)
    local skill = skillsConfig[skillIndex]
    if not skill then return end
    
    if isSkillOnCooldown(skill.name) then
        showStatus(skill.name .. " 冷却中", 1)
        return
    end
    
    if isAttacking then return end
    
    isAttacking = true
    showStatus("释放: " .. skill.name, 2)
    
    -- 播放相应技能动画
    playAnimation("skill" .. skillIndex)
    
    -- 启动冷却
    spawn(function()
        updateSkillCooldown(skill.name)
    end)
    
    -- 技能效果
    spawn(function()
        wait(0.5) -- 技能释放延迟
        
        -- 技能1: 虚空冲击
        if skillIndex == 1 then
            local origin = humanoidRootPart.Position + humanoidRootPart.CFrame.LookVector * 3
            for i = 1, 5 do
                local ray = Ray.new(origin, humanoidRootPart.CFrame.LookVector * (15 + i*3))
                local hit, position = workspace:FindPartOnRay(ray, character)
                
                -- 这里可以添加冲击波特效
                if hit and hit.Parent then
                    local otherHumanoid = hit.Parent:FindFirstChild("Humanoid")
                    if otherHumanoid and otherHumanoid ~= humanoid then
                        showStatus("虚空冲击命中!", 1)
                    end
                end
            end
            
        -- 技能2: 暗影突袭
        elseif skillIndex == 2 then
            local targetPos = humanoidRootPart.Position + humanoidRootPart.CFrame.LookVector * 20
            local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local tween = TweenService:Create(humanoidRootPart, tweenInfo, {Position = targetPos})
            tween:Play()
            
        -- 技能3: 引力场
        elseif skillIndex == 3 then
            -- 创建引力区域效果
            showStatus("引力场激活!", 3)
            
        -- 技能4: 神之审判
        elseif skillIndex == 4 then
            -- 创建范围效果
            showStatus("审判降临!", 3)
        end
        
        wait(0.5)
        isAttacking = false
    end)
end

-- 输入绑定
ContextActionService:BindAction(
    "FlightToggle",
    function(actionName, inputState, inputObject)
        if inputState == Enum.UserInputState.Begin then
            toggleFlight()
        end
    end,
    false,
    Enum.KeyCode.F
)

ContextActionService:BindAction(
    "Attack",
    function(actionName, inputState, inputObject)
        if inputState == Enum.UserInputState.Begin then
            performAttack()
        end
    end,
    false,
    Enum.KeyCode.ButtonR2,  -- 手柄RT
    Enum.UserInputType.MouseButton1  -- 鼠标左键
)

-- 技能键绑定
for i, skill in ipairs(skillsConfig) do
    ContextActionService:BindAction(
        "Skill" .. i,
        function(actionName, inputState, inputObject)
            if inputState == Enum.UserInputState.Begin then
                useSkill(i)
            end
        end,
        false,
        Enum.KeyCode[skill.key]
    )
end

-- 能量系统
local currentEnergy = 100
local maxEnergy = 100
local lastEnergyUpdate = tick()

local function updateEnergy(delta)
    if isFlying then
        currentEnergy = math.max(0, currentEnergy - delta * 5)
    elseif not isAttacking then
        currentEnergy = math.min(maxEnergy, currentEnergy + delta * 3)
    end
    
    -- 更新UI
    local energyPercent = currentEnergy / maxEnergy
    energyFill.Size = UDim2.new(energyPercent, 0, 1, 0)
    energyText.Text = string.format("能量: %d%%", math.floor(energyPercent * 100))
    
    -- 低能量警告
    if currentEnergy < 20 then
        energyFill.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    else
        energyFill.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
    end
    
    -- 能量耗尽时退出飞行
    if isFlying and currentEnergy <= 0 then
        isFlying = false
        toggleFlight()
        showStatus("能量耗尽!", 2)
    end
end

-- 主循环
RunService.RenderStepped:Connect(function(deltaTime)
    local now = tick()
    local delta = now - lastEnergyUpdate
    lastEnergyUpdate = now
    
    updateEnergy(delta)
    
    -- 更新技能按钮状态
    for skillName, buttonData in pairs(skillButtons) do
        if isSkillOnCooldown(skillName) then
            buttonData.frame.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
        else
            buttonData.frame.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
        end
    end
end)

-- 角色重生处理
player.CharacterAdded:Connect(function(newCharacter)
    character = newCharacter
    humanoid = character:WaitForChild("Humanoid")
    humanoidRootPart = character:WaitForChild("HumanoidRootPart")
    
    -- 重置状态
    isFlying = false
    isAttacking = false
    if flightVelocity then
        flightVelocity:Destroy()
        flightVelocity = nil
    end
end)

showStatus("坠落之神 - 就绪", 3)
print("坠落之神脚本已加载!")

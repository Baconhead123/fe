-- é…ç½®
local CONFIG = {
    UI_Position = UDim2.new(0.1, 0, 0.1, 0),
    UI_Size = UDim2.new(0.35, 0, 0.7, 0),
    TypingSpeed = 0.02,
    Debounce = 1.5,
    MaxReplyLength = 120,
    SaveKey = "AIChatData"
}

-- æœåŠ¡
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local Clipboard = game:GetService("Clipboard")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- å…¨å±€çŠ¶æ€
local chatHistory = {}
local aiPersona = "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„Robloxæ¸¸æˆåŠ©æ‰‹ï¼Œè¯´è¯ç®€æ´æœ‰è¶£"
local isSending = false
local isAiChatMode = false
local saveData = {}

-- ============== å†…ç½®æ™ºèƒ½AIæ ¸å¿ƒæºç ï¼ˆN-Gram+å…³é”®è¯æ··åˆæ¨¡å‹ï¼‰ ==============
local RobloxAi = {}
RobloxAi.__index = RobloxAi

-- æ‰©å±•åçš„Robloxä¸“å±è®­ç»ƒè¯­æ–™åº“
local TRAIN_CORPUS = {
    -- åŸºç¡€é—®å€™+æ¸¸æˆå¼€åœº
    "ä½ å¥½å‘€ ä¸€èµ·ç©Robloxå—",
    "å“ˆå–½ ä½ åœ¨å“ªä¸ªæœåŠ¡å™¨å‘€",
    "å¾ˆé«˜å…´è®¤è¯†ä½  è¦ä¸è¦ç»„é˜Ÿæ¢é™©",
    "æ¬¢è¿æ¥åˆ°è¿™ä¸ªåœ°å›¾ è¿™é‡Œæœ‰å¾ˆå¤šå¥½ç©çš„å½©è›‹",
    -- ç©æ³•ç›¸å…³
    "è¿™ä¸ªæ¸¸æˆçš„ç©æ³•è¶…ç®€å• æŒ‰WASDç§»åŠ¨ é¼ æ ‡ç‚¹å‡»äº¤äº’",
    "è·³è·ƒé”®æ˜¯ç©ºæ ¼ ä½ å¯ä»¥è·³åˆ°é‚£ä¸ªé«˜å°ä¸Šæ‹¿å®ç®±",
    "å°å¿ƒæ€ªç‰© å®ƒä¼šæ”»å‡»ä½  å¿«èº²åˆ°æ©ä½“åé¢",
    "å®Œæˆè¿™ä¸ªä»»åŠ¡å¯ä»¥è·å¾—é‡‘å¸ èƒ½ä¹°æ–°çš®è‚¤å“¦",
    "ç”Ÿå­˜æ¨¡å¼è¦æ”¶é›†èµ„æº å»ºé€ æˆ¿å­æŠµå¾¡æ•Œäºº",
    "åˆ›é€ æ¨¡å¼å¯ä»¥è‡ªç”±æ­å»º æƒ³åšä»€ä¹ˆå°±åšä»€ä¹ˆ",
    "ç«é€Ÿæ¨¡å¼é‡Œè¦æ³¨æ„é¿å¼€éšœç¢ç‰© ç¬¬ä¸€ä¸ªåˆ°ç»ˆç‚¹æœ‰å¥–åŠ±",
    -- ç¤¾äº¤äº’åŠ¨
    "åŠ ä¸ªå¥½å‹å§ ä»¥åä¸€èµ·ç©æ¸¸æˆ",
    "æˆ‘æ˜¯è¿™ä¸ªæˆ˜é˜Ÿçš„é˜Ÿé•¿ è¦ä¸è¦åŠ å…¥æˆ‘ä»¬",
    "å¿«æ¥æˆ‘çš„æˆ¿é—´ æˆ‘å¼€äº†ç§äººæœåŠ¡å™¨",
    "èƒ½å¸®æˆ‘ä¸€ä¸‹å— æˆ‘å¡åœ¨è¿™ä¸ªå…³å¡äº†",
    "è°¢è°¢ä½ çš„å¸®åŠ© è¿™ä¸ªé“å…·é€ç»™ä½ ",
    "å¤§å®¶ä¸€èµ·åˆä½œ æ‰èƒ½é€šå…³è¿™ä¸ªå‰¯æœ¬",
    -- é“å…·ä¸çš®è‚¤
    "è¿™ä¸ªçš®è‚¤å¥½é…· ä½ æ˜¯åœ¨å“ªé‡Œè·å¾—çš„",
    "æˆ‘æœ‰ä¸€æŠŠå²è¯—çº§æ­¦å™¨ æ”»å‡»åŠ›è¶…é«˜",
    "ä½¿ç”¨è¿™ä¸ªè¯æ°´å¯ä»¥å›è¡€ å…³é”®æ—¶åˆ»èƒ½æ•‘å‘½",
    "é£è¡Œå™¨é“å…·å¯ä»¥è®©ä½ é£èµ·æ¥ å¿«é€Ÿç©¿è¶Šåœ°å›¾",
    "å® ç‰©å¯ä»¥å¸®ä½ æˆ˜æ–— è¿˜èƒ½å–èŒ",
    "è¿™ä¸ªå¸½å­æ˜¯é™é‡æ¬¾ å¾ˆéš¾å¾—åˆ°çš„",
    -- åœ°å›¾ä¸åœºæ™¯
    "è¿™ä¸ªåŸå ¡åœ°å›¾å¥½å¤§ æˆ‘éƒ½è¿·è·¯äº†",
    "æ²™æ¼ åœ°å›¾é‡Œæœ‰ç»¿æ´² å¯ä»¥è¡¥å……æ°´åˆ†",
    "å¤ªç©ºåœ°å›¾çš„å¤±é‡æ•ˆæœå¤ªæœ‰è¶£äº† è·³èµ·æ¥ä¼šé£˜å¾ˆä¹…",
    "æµ·åº•åœ°å›¾æœ‰å¾ˆå¤šæµ·æ´‹ç”Ÿç‰© è¿˜æœ‰æ²‰èˆ¹å®è—",
    "åŸå¸‚åœ°å›¾å¯ä»¥å¼€è½¦ è¿˜èƒ½é€›å•†åº—",
    "æ£®æ—åœ°å›¾é‡Œæœ‰éšè—çš„æ´ç©´ é‡Œé¢æœ‰ç¨€æœ‰é“å…·",
    -- æ—¥å¸¸é—²èŠ
    "ä½ ç©Robloxå¤šä¹…äº† æˆ‘ç©äº†å¥½å‡ ä¸ªæœˆäº†",
    "ä»Šå¤©æ›´æ–°äº†æ–°å†…å®¹ å¿«å»ä½“éªŒä¸€ä¸‹",
    "è¿™ä¸ªæ¸¸æˆçš„èƒŒæ™¯éŸ³ä¹å¾ˆå¥½å¬",
    "æˆ‘æœ€å–œæ¬¢çš„æ¸¸æˆæ¨¡å¼æ˜¯åˆ›é€ æ¨¡å¼ å¾ˆè‡ªç”±",
    "æ™šä¸Šä¸€èµ·ç©å— æˆ‘æ™šä¸Šæœ‰æ—¶é—´",
    "æ‹œæ‹œ ä¸‹æ¬¡å†ä¸€èµ·ç© ç¥ä½ ç©å¾—å¼€å¿ƒ"
}

-- å…³é”®è¯-å›å¤æ˜ å°„ï¼ˆå¢å¼ºåŒ¹é…ç²¾å‡†åº¦ï¼‰
local KEYWORD_REPLIES = {
    ["ç»„é˜Ÿ"] = {"å¥½å‘€å¥½å‘€ æˆ‘ä»¬ä¸€èµ·ç»„é˜Ÿé—¯å…³ï¼", "ç»„é˜Ÿèµ°èµ· æˆ‘è´Ÿè´£æ‰“æ€ªä½ è´Ÿè´£æ¡é“å…·ï½", "æ²¡é—®é¢˜ ç»„é˜Ÿåå¥–åŠ±è¿˜èƒ½å¹³åˆ†å‘¢"},
    ["çš®è‚¤"] = {"çš®è‚¤å¯ä»¥åœ¨å•†åŸä¹° æˆ–è€…åšä»»åŠ¡è·å–å“¦", "è¿™ä¸ªçš®è‚¤æˆ‘ä¹Ÿæƒ³è¦ å¯æƒœå¤ªè´µäº†", "çš®è‚¤åªæ˜¯è£…é¥° å®åŠ›æ‰æ˜¯å…³é”®å•¦"},
    ["å…³å¡"] = {"è¿™ä¸ªå…³å¡æˆ‘çŸ¥é“æ€ä¹ˆè¿‡ è·Ÿç€æˆ‘èµ°ï¼", "å¡åœ¨å“ªä¸ªå…³å¡äº†ï¼Ÿæˆ‘æ¥æ•™ä½ æŠ€å·§", "è¿™ä¸ªå…³å¡æœ‰ç‚¹éš¾ æˆ‘ä»¬åˆä½œè¯•è¯•"},
    ["å¥½å‹"] = {"åŠ å¥½å‹å‘€ ä»¥åä¸€èµ·ç©ï½", "å¥½çš„ æˆ‘å·²ç»å‘é€å¥½å‹è¯·æ±‚å•¦", "å¥½å‹åˆ—è¡¨æ»¡äº† æˆ‘å…ˆåˆ ä¸ªä¸å¸¸ç©çš„"},
    ["åœ°å›¾"] = {"è¿™ä¸ªåœ°å›¾çš„å½©è›‹è¶…å¤š æˆ‘å¸¦ä½ å»æ‰¾", "è¿™ä¸ªåœ°å›¾æˆ‘ç†Ÿ å“ªé‡Œæœ‰å®è—éƒ½çŸ¥é“", "è¿™ä¸ªåœ°å›¾å¤ªå¤§äº† æˆ‘ç»å¸¸è¿·è·¯"}
}

-- åˆå§‹åŒ–AI
function RobloxAi.new(persona)
    local self = setmetatable({}, RobloxAi)
    self.persona = persona or "å‹å¥½çš„æ¸¸æˆåŠ©æ‰‹"
    self.bigramChain = {} -- äºŒå…ƒè¯é“¾: {å‰è¯ = {åè¯åˆ—è¡¨}}
    self:TrainN_Gram() -- è®­ç»ƒN-Gramæ¨¡å‹
    return self
end

-- è®­ç»ƒäºŒå…ƒè¯é“¾æ¨¡å‹
function RobloxAi:TrainN_Gram()
    for _, sentence in ipairs(TRAIN_CORPUS) do
        local words = self:Split(sentence, " ")
        if #words < 2 then continue end
        table.insert(words, "<END>") -- å¥å­ç»“æŸæ ‡è®°
        for i = 1, #words - 1 do
            local currentWord = words[i]
            local nextWord = words[i + 1]
            if not self.bigramChain[currentWord] then
                self.bigramChain[currentWord] = {}
            end
            table.insert(self.bigramChain[currentWord], nextWord)
        end
    end
end

-- å­—ç¬¦ä¸²åˆ†å‰²å·¥å…·
function RobloxAi:Split(str, sep)
    local parts = {}
    for part in string.gmatch(str, "([^" .. sep .. "]+)") do
        table.insert(parts, part)
    end
    return parts
end

-- å…³é”®è¯åŒ¹é…ä¼˜å…ˆå›å¤
function RobloxAi:MatchKeyword(input)
    for keyword, replies in pairs(KEYWORD_REPLIES) do
        if input:find(keyword) then
            return replies[math.random(1, #replies)]
        end
    end
    return nil
end

-- N-Gramæ¨¡å‹ç”Ÿæˆå›å¤
function RobloxAi:GenerateFromChain(input)
    local inputWords = self:Split(input, " ")
    -- ä¼˜å…ˆé€‰è¾“å…¥é‡Œçš„è¯ä½œä¸ºèµ·å§‹è¯
    local startWord = inputWords[math.random(1, #inputWords)]
    if not self.bigramChain[startWord] then
        -- éšæœºé€‰è¯­æ–™åº“ä¸­çš„è¯ä½œä¸ºèµ·å§‹
        local allWords = {}
        for word in pairs(self.bigramChain) do
            if word ~= "<END>" then
                table.insert(allWords, word)
            end
        end
        startWord = allWords[math.random(1, #allWords)] or "Roblox"
    end

    local replyWords = {startWord}
    local currentWord = startWord
    -- ç”Ÿæˆ5-10ä¸ªè¯çš„å›å¤
    local maxWords = math.random(5, 10)
    while #replyWords < maxWords do
        if not self.bigramChain[currentWord] or currentWord == "<END>" then
            break
        end
        local nextWords = self.bigramChain[currentWord]
        currentWord = nextWords[math.random(1, #nextWords)]
        if currentWord ~= "<END>" then
            table.insert(replyWords, currentWord)
        end
    end

    return table.concat(replyWords, " ")
end

-- æ ¸å¿ƒå›å¤ç”Ÿæˆé€»è¾‘ï¼šå…³é”®è¯ä¼˜å…ˆ + N-Gramå…œåº•
function RobloxAi:GetReply(input)
    -- ç¬¬ä¸€æ­¥ï¼šä¼˜å…ˆåŒ¹é…å…³é”®è¯
    local keywordReply = self:MatchKeyword(input)
    if keywordReply then
        return self:ApplyPersona(keywordReply)
    end
    -- ç¬¬äºŒæ­¥ï¼šN-Gramæ¨¡å‹ç”Ÿæˆå›å¤
    local chainReply = self:GenerateFromChain(input)
    return self:ApplyPersona(chainReply)
end

-- åº”ç”¨äººè®¾é£æ ¼æ¶¦è‰²å›å¤
function RobloxAi:ApplyPersona(reply)
    if self.persona:find("è°ƒçš®") then
        local suffix = {"ğŸ˜œ", "ï½", "å•¦", "å“Ÿ"}
        return reply .. suffix[math.random(1, #suffix)]
    elseif self.persona:find("é«˜å†·") then
        return reply:gsub("å‘€|å•¦|å“Ÿ|ï½", "") .. "."
    elseif self.persona:find("å¯çˆ±") then
        local suffix = {"ğŸ¥°", "å–µï½", "å¥½è€¶ï½", "è¶…æ£’çš„ï¼"}
        return reply .. suffix[math.random(1, #suffix)]
    elseif self.persona:find("æ²™é›•") then
        local suffix = {"å“ˆå“ˆå“ˆå“ˆ", "è¿™æ³¢æ“ä½œ666", "ç¬‘æ­»æˆ‘äº†"}
        return reply .. suffix[math.random(1, #suffix)]
    else
        return reply
    end
end

-- å®ä¾‹åŒ–AI
local aiInstance = RobloxAi.new(aiPersona)

-- ========== å­˜æ¡£/è¯»æ¡£é€»è¾‘ ==========
local function loadSaveData()
    local saveObject = PlayerGui:FindFirstChild(CONFIG.SaveKey)
    if not saveObject then return end
    local success, data = pcall(function()
        return game:GetService("HttpService"):JSONDecode(saveObject.Value)
    end)
    if success then
        aiPersona = data.persona or aiPersona
        aiInstance = RobloxAi.new(aiPersona) -- é‡æ–°è®­ç»ƒAI
        print("âœ… åŠ è½½å­˜æ¡£å¹¶æ›´æ–°AIäººè®¾")
    end
end

local function saveDataToLocal()
    saveData = {
        persona = aiPersona
    }
    local saveObject = PlayerGui:FindFirstChild(CONFIG.SaveKey) or Instance.new("StringValue")
    saveObject.Name = CONFIG.SaveKey
    saveObject.Value = game:GetService("HttpService"):JSONEncode(saveData)
    saveObject.Parent = PlayerGui
    print("âœ… è‡ªåŠ¨å­˜æ¡£å®Œæˆ")
end

loadSaveData()
task.spawn(function()
    while task.wait(30) do
        saveDataToLocal()
    end
end)

-- ========== UIåˆ›å»º ==========
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "RobloxAiChatUI"
ScreenGui.Parent = PlayerGui

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = CONFIG.UI_Size
MainFrame.Position = CONFIG.UI_Position
MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
MainFrame.BorderSizePixel = 2
MainFrame.BorderColor3 = Color3.new(0.3, 0.3, 0.3)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
TitleBar.Parent = MainFrame

local TitleText = Instance.new("TextLabel")
TitleText.Text = "Robloxä¸“å±AIèŠå¤©é¢æ¿"
TitleText.Size = UDim2.new(0.6, 0, 1, 0)
TitleText.Position = UDim2.new(0, 5, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.TextColor3 = Color3.new(1, 1, 1)
TitleText.TextSize = 16
TitleText.Parent = TitleBar

local AiModeToggle = Instance.new("TextButton")
AiModeToggle.Name = "AiModeToggle"
AiModeToggle.Size = UDim2.new(0.25, 0, 0, 25)
AiModeToggle.Position = UDim2.new(0.65, 0, 0, 2)
AiModeToggle.BackgroundColor3 = Color3.new(0.4, 0.1, 0.1)
AiModeToggle.Text = "AIèŠå¤©: å…³é—­"
AiModeToggle.TextColor3 = Color3.new(1, 1, 1)
AiModeToggle.TextSize = 12
AiModeToggle.Parent = TitleBar

local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Size = UDim2.new(0, 30, 0, 30)
MinimizeBtn.Position = UDim2.new(1, -30, 0, 0)
MinimizeBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
MinimizeBtn.Text = "-"
MinimizeBtn.TextColor3 = Color3.new(1, 1, 1)
MinimizeBtn.TextSize = 18
MinimizeBtn.Parent = TitleBar

local PersonaFrame = Instance.new("Frame")
PersonaFrame.Name = "PersonaFrame"
PersonaFrame.Size = UDim2.new(1, -10, 0, 60)
PersonaFrame.Position = UDim2.new(0, 5, 0, 35)
PersonaFrame.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
PersonaFrame.Parent = MainFrame

local PersonaLabel = Instance.new("TextLabel")
PersonaLabel.Text = "AIäººè®¾:"
PersonaLabel.Size = UDim2.new(1, 0, 0, 20)
PersonaLabel.BackgroundTransparency = 1
PersonaLabel.TextColor3 = Color3.new(0.9, 0.9, 0.9)
PersonaLabel.TextSize = 12
PersonaLabel.Parent = PersonaFrame

local PersonaInput = Instance.new("TextBox")
PersonaInput.Name = "PersonaInput"
PersonaInput.Size = UDim2.new(1, -70, 0, 30)
PersonaInput.Position = UDim2.new(0, 0, 0, 20)
PersonaInput.BackgroundColor3 = Color3.new(0.25, 0.25, 0.25)
PersonaInput.TextColor3 = Color3.new(1, 1, 1)
PersonaInput.PlaceholderText = "è¾“å…¥äººè®¾ï¼ˆå¦‚ï¼šè°ƒçš®çš„Robloxç©å®¶ï¼‰"
PersonaInput.PlaceholderColor3 = Color3.new(0.6, 0.6, 0.6)
PersonaInput.TextSize = 12
PersonaInput.Text = aiPersona
PersonaInput.ClearTextOnFocus = false
PersonaInput.Parent = PersonaFrame

local SavePersonaBtn = Instance.new("TextButton")
SavePersonaBtn.Name = "SavePersonaBtn"
SavePersonaBtn.Size = UDim2.new(0, 65, 0, 30)
SavePersonaBtn.Position = UDim2.new(1, -65, 0, 20)
SavePersonaBtn.BackgroundColor3 = Color3.new(0.2, 0.5, 0.2)
SavePersonaBtn.Text = "ä¿å­˜"
SavePersonaBtn.TextColor3 = Color3.new(1, 1, 1)
SavePersonaBtn.TextSize = 12
SavePersonaBtn.Parent = PersonaFrame

local ChatFrame = Instance.new("ScrollingFrame")
ChatFrame.Name = "ChatFrame"
ChatFrame.Size = UDim2.new(1, -10, 1, -165)
ChatFrame.Position = UDim2.new(0, 5, 0, 100)
ChatFrame.BackgroundColor3 = Color3.new(0.05, 0.05, 0.05)
ChatFrame.ScrollBarThickness = 5
ChatFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
ChatFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ChatFrame.Parent = MainFrame

local ChatLayout = Instance.new("UIListLayout")
ChatLayout.Padding = UDim.new(0, 5)
ChatLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
ChatLayout.VerticalAlignment = Enum.VerticalAlignment.Top
ChatLayout.SortOrder = Enum.SortOrder.LayoutOrder
ChatLayout.Parent = ChatFrame

local InputFrame = Instance.new("Frame")
InputFrame.Size = UDim2.new(1, -10, 0, 30)
InputFrame.Position = UDim2.new(0, 5, 1, -35)
InputFrame.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
InputFrame.Parent = MainFrame

local InputBox = Instance.new("TextBox")
InputBox.Size = UDim2.new(0.8, 0, 1, 0)
InputBox.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
InputBox.TextColor3 = Color3.new(1, 1, 1)
InputBox.PlaceholderText = "è¾“å…¥æ¶ˆæ¯..."
InputBox.PlaceholderColor3 = Color3.new(0.6, 0.6, 0.6)
InputBox.TextSize = 14
InputBox.ClearTextOnFocus = false
InputBox.Parent = InputFrame

local SendBtn = Instance.new("TextButton")
SendBtn.Size = UDim2.new(0.2, 0, 1, 0)
SendBtn.Position = UDim2.new(0.8, 0, 0, 0)
SendBtn.BackgroundColor3 = Color3.new(0.2, 0.5, 0.8)
SendBtn.Text = "å‘é€"
SendBtn.TextColor3 = Color3.new(1, 1, 1)
SendBtn.TextSize = 14
SendBtn.Parent = InputFrame

-- ========== æ¶ˆæ¯å¤„ç†é€»è¾‘ ==========
local function addMessage(text, isUser, isAiChat)
    local messageFrame = Instance.new("Frame")
    messageFrame.Size = UDim2.new(1, -10, 0, 0)
    messageFrame.BackgroundTransparency = 1
    messageFrame.LayoutOrder = #chatHistory + 1
    messageFrame.Parent = ChatFrame

    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, -50, 0, 0)
    messageLabel.BackgroundTransparency = 1
    messageLabel.TextColor3 = isUser and Color3.new(0.4, 1, 0.4) or Color3.new(1, 1, 0.6)
    messageLabel.Text = (isUser and "ä½ : " or isAiChat and "AIåŒ–èº«: " or "AI: ") .. text
    messageLabel.TextSize = 14
    messageLabel.TextWrapped = true
    messageLabel.AutomaticSize = Enum.AutomaticSize.Y
    messageLabel.Parent = messageFrame

    if not isUser then
        local copyBtn = Instance.new("TextButton")
        copyBtn.Size = UDim2.new(0, 45, 0, 20)
        copyBtn.Position = UDim2.new(1, -45, 0, 0)
        copyBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
        copyBtn.Text = "å¤åˆ¶"
        copyBtn.TextColor3 = Color3.new(1, 1, 1)
        copyBtn.TextSize = 10
        copyBtn.Parent = messageFrame

        copyBtn.MouseButton1Click:Connect(function()
            Clipboard:SetText(text)
            copyBtn.Text = "å·²å¤åˆ¶"
            task.wait(1)
            copyBtn.Text = "å¤åˆ¶"
        end)
    end

    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    table.insert(chatHistory, messageFrame)
    ChatFrame.CanvasPosition = Vector2.new(0, ChatFrame.CanvasSize.Y.Offset)
end

local function aiTypeReply(text, isAiChat)
    local messageFrame = Instance.new("Frame")
    messageFrame.Size = UDim2.new(1, -10, 0, 0)
    messageFrame.BackgroundTransparency = 1
    messageFrame.LayoutOrder = #chatHistory + 1
    messageFrame.Parent = ChatFrame

    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, -50, 0, 0)
    messageLabel.BackgroundTransparency = 1
    messageLabel.TextColor3 = Color3.new(1, 1, 0.6)
    messageLabel.Text = isAiChat and "AIåŒ–èº«: " or "AI: "
    messageLabel.TextSize = 14
    messageLabel.TextWrapped = true
    messageLabel.AutomaticSize = Enum.AutomaticSize.Y
    messageLabel.Parent = messageFrame

    local copyBtn = Instance.new("TextButton")
    copyBtn.Size = UDim2.new(0, 45, 0, 20)
    copyBtn.Position = UDim2.new(1, -45, 0, 0)
    copyBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
    copyBtn.Text = "å¤åˆ¶"
    copyBtn.TextColor3 = Color3.new(1, 1, 1)
    copyBtn.TextSize = 10
    copyBtn.Parent = messageFrame

    copyBtn.MouseButton1Click:Connect(function()
        Clipboard:SetText(text)
        copyBtn.Text = "å·²å¤åˆ¶"
        task.wait(1)
        copyBtn.Text = "å¤åˆ¶"
    end)

    for i = 1, #text do
        messageLabel.Text = messageLabel.Text .. string.sub(text, i, i)
        ChatFrame.CanvasPosition = Vector2.new(0, ChatFrame.CanvasSize.Y.Offset)
        task.wait(CONFIG.TypingSpeed)
    end

    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    table.insert(chatHistory, messageFrame)
end

-- ========== æŒ‰é’®é€»è¾‘ ==========
SavePersonaBtn.MouseButton1Click:Connect(function()
    if PersonaInput.Text == "" then return end
    aiPersona = PersonaInput.Text
    aiInstance = RobloxAi.new(aiPersona) -- é‡æ–°è®­ç»ƒAI
    saveDataToLocal()
    addMessage("âœ… AIäººè®¾å·²æ›´æ–°å¹¶é‡æ–°è®­ç»ƒ", false, false)
end)

SendBtn.MouseButton1Click:Connect(function()
    if isSending or InputBox.Text == "" then return end
    isSending = true
    local userText = InputBox.Text
    InputBox.Text = ""
    
    addMessage(userText, true, false)
    task.spawn(function()
        local aiReply = aiInstance:GetReply(userText)
        aiTypeReply(aiReply, false)
        task.wait(CONFIG.Debounce)
        isSending = false
    end)
end)

InputBox.Focused:Connect(function()
    UserInputService.InputBegan:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.Return and InputBox:IsFocused() then
            SendBtn.MouseButton1Click:Fire()
        end
    end)
end)

local isMinimized = false
MinimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    ChatFrame.Visible = not isMinimized
    InputFrame.Visible = not isMinimized
    PersonaFrame.Visible = not isMinimized
    MainFrame.Size = isMinimized and UDim2.new(0.35, 0, 0, 30) or CONFIG.UI_Size
end)

AiModeToggle.MouseButton1Click:Connect(function()
    isAiChatMode = not isAiChatMode
    AiModeToggle.BackgroundColor3 = isAiChatMode and Color3.new(0.1, 0.4, 0.1) or Color3.new(0.4, 0.1, 0.1)
    AiModeToggle.Text = isAiChatMode and "AIèŠå¤©: å¼€å¯" or "AIèŠå¤©: å…³é—­"
    addMessage(isAiChatMode and "ğŸ”µ AIåŒ–èº«æ¨¡å¼å·²å¼€å¯" or "ğŸ”´ AIåŒ–èº«æ¨¡å¼å·²å…³é—­", false, false)
end)

-- ========== å…¬å…±èŠå¤©ç›‘å¬ ==========
local function onPlayerChatted(player, message)
    if not isAiChatMode or player == LocalPlayer then return end
    if message:sub(1, 1) == "/" then return end

    addMessage(player.Name .. ": " .. message, false, false)
    task.spawn(function()
        local aiReply = aiInstance:GetReply(message)
        aiTypeReply(aiReply, true)
        
        local success, err = pcall(function()
            local ChatService = require(ReplicatedStorage:FindFirstChild("ChatServiceRunner"):FindFirstChild("ChatService"))
            local speaker = ChatService:GetSpeaker(LocalPlayer.Name)
            speaker:SayMessage(aiReply, "All")
        end)
        if not success then
            warn("å…¬å…±èŠå¤©å‘é€å¤±è´¥: " .. err)
            addMessage("âŒ å…¬å…±èŠå¤©å‘é€å¤±è´¥", false, false)
        end
    end)
end

for _, player in ipairs(Players:GetPlayers()) do
    player.Chatted:Connect(onPlayerChatted)
end
Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(onPlayerChatted)
end)

print("âœ… Robloxä¸“å±AIèŠå¤©é¢æ¿åŠ è½½å®Œæˆ")

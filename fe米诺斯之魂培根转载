-- é…ç½®
local CONFIG = {
    UI_Position = UDim2.new(0.1, 0, 0.1, 0),
    UI_Size = UDim2.new(0.35, 0, 0.7, 0),
    TypingSpeed = 0.02,
    Debounce = 1.5,
    MaxReplyLength = 300,
    SaveKey = "AIChatData" -- æœ¬åœ°å­˜æ¡£é”®å
}

-- æœåŠ¡
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local UserInputService = game:GetService("UserInputService")
local Clipboard = game:GetService("Clipboard")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- å…¨å±€çŠ¶æ€
local chatHistory = {}
local aiPersona = "ä½ æ˜¯ä¸€ä¸ªå‹å¥½çš„Robloxæ¸¸æˆAIåŠ©æ‰‹ï¼Œè¯´è¯ç®€æ´æœ‰è¶£ï¼Œç§¯æå›åº”ç©å®¶çš„é—®é¢˜ã€‚"
local isSending = false
local isAiChatMode = false -- AIåŒ–èº«æ¨¡å¼å¼€å…³
local saveData = {}

-- ========== å­˜æ¡£/è¯»æ¡£é€»è¾‘ ==========
local function loadSaveData()
    local saveObject = PlayerGui:FindFirstChild(CONFIG.SaveKey)
    if not saveObject then return end
    local success, data = pcall(function()
        return HttpService:JSONDecode(saveObject.Value)
    end)
    if success then
        aiPersona = data.persona or aiPersona
        chatHistory = {} -- å†å²æ¶ˆæ¯ä»…å†…å­˜æš‚å­˜ï¼Œå¦‚éœ€å­˜æ¡£æ¶ˆæ¯å¯æ‰©å±•æ­¤å¤„
        print("âœ… åŠ è½½å­˜æ¡£æˆåŠŸ")
    end
end

local function saveDataToLocal()
    saveData = {
        persona = aiPersona
    }
    local saveObject = PlayerGui:FindFirstChild(CONFIG.SaveKey) or Instance.new("StringValue")
    saveObject.Name = CONFIG.SaveKey
    saveObject.Value = HttpService:JSONEncode(saveData)
    saveObject.Parent = PlayerGui
    print("âœ… è‡ªåŠ¨å­˜æ¡£å®Œæˆ")
end

-- åˆå§‹åŒ–åŠ è½½å­˜æ¡£
loadSaveData()
-- æ¯30ç§’è‡ªåŠ¨å­˜æ¡£
task.spawn(function()
    while task.wait(30) do
        saveDataToLocal()
    end
end)

-- ========== UIåˆ›å»º ==========
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "AdvancedAIChatUI"
ScreenGui.Parent = PlayerGui

-- ä¸»çª—å£
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = CONFIG.UI_Size
MainFrame.Position = CONFIG.UI_Position
MainFrame.BackgroundColor3 = Color3.new(0.1, 0.1, 0.1)
MainFrame.BorderSizePixel = 2
MainFrame.BorderColor3 = Color3.new(0.3, 0.3, 0.3)
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Parent = ScreenGui

-- æ ‡é¢˜æ 
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 30)
TitleBar.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
TitleBar.Parent = MainFrame

local TitleText = Instance.new("TextLabel")
TitleText.Text = "é«˜çº§AIèŠå¤©é¢æ¿"
TitleText.Size = UDim2.new(0.6, 0, 1, 0)
TitleText.Position = UDim2.new(0, 5, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.TextColor3 = Color3.new(1, 1, 1)
TitleText.TextSize = 16
TitleText.Parent = TitleBar

-- AIåŒ–èº«æ¨¡å¼å¼€å…³
local AiModeToggle = Instance.new("TextButton")
AiModeToggle.Name = "AiModeToggle"
AiModeToggle.Size = UDim2.new(0.25, 0, 0, 25)
AiModeToggle.Position = UDim2.new(0.65, 0, 0, 2)
AiModeToggle.BackgroundColor3 = Color3.new(0.4, 0.1, 0.1)
AiModeToggle.Text = "AIèŠå¤©: å…³é—­"
AiModeToggle.TextColor3 = Color3.new(1, 1, 1)
AiModeToggle.TextSize = 12
AiModeToggle.Parent = TitleBar

local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Size = UDim2.new(0, 30, 0, 30)
MinimizeBtn.Position = UDim2.new(1, -30, 0, 0)
MinimizeBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
MinimizeBtn.Text = "-"
MinimizeBtn.TextColor3 = Color3.new(1, 1, 1)
MinimizeBtn.TextSize = 18
MinimizeBtn.Parent = TitleBar

-- äººè®¾è®¾ç½®åŒºåŸŸ
local PersonaFrame = Instance.new("Frame")
PersonaFrame.Name = "PersonaFrame"
PersonaFrame.Size = UDim2.new(1, -10, 0, 60)
PersonaFrame.Position = UDim2.new(0, 5, 0, 35)
PersonaFrame.BackgroundColor3 = Color3.new(0.15, 0.15, 0.15)
PersonaFrame.Parent = MainFrame

local PersonaLabel = Instance.new("TextLabel")
PersonaLabel.Text = "AIäººè®¾:"
PersonaLabel.Size = UDim2.new(1, 0, 0, 20)
PersonaLabel.BackgroundTransparency = 1
PersonaLabel.TextColor3 = Color3.new(0.9, 0.9, 0.9)
PersonaLabel.TextSize = 12
PersonaLabel.Parent = PersonaFrame

local PersonaInput = Instance.new("TextBox")
PersonaInput.Name = "PersonaInput"
PersonaInput.Size = UDim2.new(1, -70, 0, 30)
PersonaInput.Position = UDim2.new(0, 0, 0, 20)
PersonaInput.BackgroundColor3 = Color3.new(0.25, 0.25, 0.25)
PersonaInput.TextColor3 = Color3.new(1, 1, 1)
PersonaInput.PlaceholderText = "è¾“å…¥AIçš„äººè®¾æè¿°..."
PersonaInput.PlaceholderColor3 = Color3.new(0.6, 0.6, 0.6)
PersonaInput.TextSize = 12
PersonaInput.Text = aiPersona
PersonaInput.ClearTextOnFocus = false
PersonaInput.Parent = PersonaFrame

local SavePersonaBtn = Instance.new("TextButton")
SavePersonaBtn.Name = "SavePersonaBtn"
SavePersonaBtn.Size = UDim2.new(0, 65, 0, 30)
SavePersonaBtn.Position = UDim2.new(1, -65, 0, 20)
SavePersonaBtn.BackgroundColor3 = Color3.new(0.2, 0.5, 0.2)
SavePersonaBtn.Text = "ä¿å­˜"
SavePersonaBtn.TextColor3 = Color3.new(1, 1, 1)
SavePersonaBtn.TextSize = 12
SavePersonaBtn.Parent = PersonaFrame

-- èŠå¤©åŒºåŸŸ
local ChatFrame = Instance.new("ScrollingFrame")
ChatFrame.Name = "ChatFrame"
ChatFrame.Size = UDim2.new(1, -10, 1, -165)
ChatFrame.Position = UDim2.new(0, 5, 0, 100)
ChatFrame.BackgroundColor3 = Color3.new(0.05, 0.05, 0.05)
ChatFrame.ScrollBarThickness = 5
ChatFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
ChatFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ChatFrame.Parent = MainFrame

local ChatLayout = Instance.new("UIListLayout")
ChatLayout.Padding = UDim.new(0, 5)
ChatLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
ChatLayout.VerticalAlignment = Enum.VerticalAlignment.Top
ChatLayout.SortOrder = Enum.SortOrder.LayoutOrder
ChatLayout.Parent = ChatFrame

-- è¾“å…¥åŒºåŸŸ
local InputFrame = Instance.new("Frame")
InputFrame.Size = UDim2.new(1, -10, 0, 30)
InputFrame.Position = UDim2.new(0, 5, 1, -35)
InputFrame.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
InputFrame.Parent = MainFrame

local InputBox = Instance.new("TextBox")
InputBox.Size = UDim2.new(0.8, 0, 1, 0)
InputBox.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
InputBox.TextColor3 = Color3.new(1, 1, 1)
InputBox.PlaceholderText = "è¾“å…¥æ¶ˆæ¯..."
InputBox.PlaceholderColor3 = Color3.new(0.6, 0.6, 0.6)
InputBox.TextSize = 14
InputBox.ClearTextOnFocus = false
InputBox.Parent = InputFrame

local SendBtn = Instance.new("TextButton")
SendBtn.Size = UDim2.new(0.2, 0, 1, 0)
SendBtn.Position = UDim2.new(0.8, 0, 0, 0)
SendBtn.BackgroundColor3 = Color3.new(0.2, 0.5, 0.8)
SendBtn.Text = "å‘é€"
SendBtn.TextColor3 = Color3.new(1, 1, 1)
SendBtn.TextSize = 14
SendBtn.Parent = InputFrame

-- ========== AIæ¥å£è¯·æ±‚ ==========
local function getFreeAIResponse(userMessage)
    local apiUrl = "https://api.qingyunke.com/api.php"
    local params = HttpService:UrlEncode(table.concat({
        "key=free",
        "appid=0",
        "msg=" .. HttpService:UrlEncode(aiPersona .. " || " .. userMessage)
    }, "&"))
    local fullUrl = apiUrl .. "?" .. params

    local success, response = pcall(function()
        return HttpService:GetAsync(fullUrl, true)
    end)
    
    if not success then
        return "âŒ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•"
    end

    local data = HttpService:JSONDecode(response)
    if data.result ~= 0 then
        return "âŒ AIæš‚æœªå“åº”ï¼Œè¯·æ¢ä¸ªé—®é¢˜è¯•è¯•"
    end

    local reply = string.gsub(data.content, "{br}", "\n")
    reply = string.sub(reply, 1, CONFIG.MaxReplyLength)
    return reply ~= "" and reply or "ğŸ¤” æˆ‘è¿˜æ²¡æƒ³å¥½æ€ä¹ˆå›ç­”~"
end

-- ========== èŠå¤©æ¶ˆæ¯å¤„ç† ==========
local function addMessage(text, isUser, isAiChat)
    local messageFrame = Instance.new("Frame")
    messageFrame.Size = UDim2.new(1, -10, 0, 0)
    messageFrame.BackgroundTransparency = 1
    messageFrame.LayoutOrder = #chatHistory + 1
    messageFrame.Parent = ChatFrame

    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, -50, 0, 0)
    messageLabel.BackgroundTransparency = 1
    messageLabel.TextColor3 = isUser and Color3.new(0.4, 1, 0.4) or Color3.new(1, 1, 0.6)
    messageLabel.Text = (isUser and "ä½ : " or isAiChat and "AIåŒ–èº«: " or "AI: ") .. text
    messageLabel.TextSize = 14
    messageLabel.TextWrapped = true
    messageLabel.AutomaticSize = Enum.AutomaticSize.Y
    messageLabel.Parent = messageFrame

    -- å¤åˆ¶æŒ‰é’®ï¼ˆä»…AIæ¶ˆæ¯ï¼‰
    if not isUser then
        local copyBtn = Instance.new("TextButton")
        copyBtn.Size = UDim2.new(0, 45, 0, 20)
        copyBtn.Position = UDim2.new(1, -45, 0, 0)
        copyBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
        copyBtn.Text = "å¤åˆ¶"
        copyBtn.TextColor3 = Color3.new(1, 1, 1)
        copyBtn.TextSize = 10
        copyBtn.Parent = messageFrame

        copyBtn.MouseButton1Click:Connect(function()
            Clipboard:SetText(text)
            copyBtn.Text = "å·²å¤åˆ¶"
            task.wait(1)
            copyBtn.Text = "å¤åˆ¶"
        end)
    end

    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    table.insert(chatHistory, messageFrame)
    ChatFrame.CanvasPosition = Vector2.new(0, ChatFrame.CanvasSize.Y.Offset)
end

local function aiTypeReply(text, isAiChat)
    local messageFrame = Instance.new("Frame")
    messageFrame.Size = UDim2.new(1, -10, 0, 0)
    messageFrame.BackgroundTransparency = 1
    messageFrame.LayoutOrder = #chatHistory + 1
    messageFrame.Parent = ChatFrame

    local messageLabel = Instance.new("TextLabel")
    messageLabel.Size = UDim2.new(1, -50, 0, 0)
    messageLabel.BackgroundTransparency = 1
    messageLabel.TextColor3 = Color3.new(1, 1, 0.6)
    messageLabel.Text = isAiChat and "AIåŒ–èº«: " or "AI: "
    messageLabel.TextSize = 14
    messageLabel.TextWrapped = true
    messageLabel.AutomaticSize = Enum.AutomaticSize.Y
    messageLabel.Parent = messageFrame

    -- å¤åˆ¶æŒ‰é’®
    local copyBtn = Instance.new("TextButton")
    copyBtn.Size = UDim2.new(0, 45, 0, 20)
    copyBtn.Position = UDim2.new(1, -45, 0, 0)
    copyBtn.BackgroundColor3 = Color3.new(0.3, 0.3, 0.5)
    copyBtn.Text = "å¤åˆ¶"
    copyBtn.TextColor3 = Color3.new(1, 1, 1)
    copyBtn.TextSize = 10
    copyBtn.Parent = messageFrame

    copyBtn.MouseButton1Click:Connect(function()
        Clipboard:SetText(text)
        copyBtn.Text = "å·²å¤åˆ¶"
        task.wait(1)
        copyBtn.Text = "å¤åˆ¶"
    end)

    for i = 1, #text do
        messageLabel.Text = messageLabel.Text .. string.sub(text, i, i)
        ChatFrame.CanvasPosition = Vector2.new(0, ChatFrame.CanvasSize.Y.Offset)
        task.wait(CONFIG.TypingSpeed)
    end

    messageFrame.AutomaticSize = Enum.AutomaticSize.Y
    table.insert(chatHistory, messageFrame)
end

-- ========== åŠŸèƒ½æŒ‰é’®é€»è¾‘ ==========
-- ä¿å­˜äººè®¾
SavePersonaBtn.MouseButton1Click:Connect(function()
    if PersonaInput.Text == "" then return end
    aiPersona = PersonaInput.Text
    saveDataToLocal()
    addMessage("âœ… AIäººè®¾å·²æ›´æ–°å¹¶ä¿å­˜", false, false)
end)

-- å‘é€æ¶ˆæ¯
SendBtn.MouseButton1Click:Connect(function()
    if isSending or InputBox.Text == "" then return end
    isSending = true
    local userText = InputBox.Text
    InputBox.Text = ""
    
    addMessage(userText, true, false)
    task.spawn(function()
        local aiReply = getFreeAIResponse(userText)
        aiTypeReply(aiReply, false)
        task.wait(CONFIG.Debounce)
        isSending = false
    end)
end)

-- å›è½¦å‘é€
InputBox.Focused:Connect(function()
    UserInputService.InputBegan:Connect(function(input)
        if input.KeyCode == Enum.KeyCode.Return and InputBox:IsFocused() then
            SendBtn.MouseButton1Click:Fire()
        end
    end)
end)

-- æœ€å°åŒ–
local isMinimized = false
MinimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    ChatFrame.Visible = not isMinimized
    InputFrame.Visible = not isMinimized
    PersonaFrame.Visible = not isMinimized
    MainFrame.Size = isMinimized and UDim2.new(0.35, 0, 0, 30) or CONFIG.UI_Size
end)

-- AIåŒ–èº«æ¨¡å¼å¼€å…³
AiModeToggle.MouseButton1Click:Connect(function()
    isAiChatMode = not isAiChatMode
    AiModeToggle.BackgroundColor3 = isAiChatMode and Color3.new(0.1, 0.4, 0.1) or Color3.new(0.4, 0.1, 0.1)
    AiModeToggle.Text = isAiChatMode and "AIèŠå¤©: å¼€å¯" or "AIèŠå¤©: å…³é—­"
    addMessage(isAiChatMode and "ğŸ”µ AIåŒ–èº«æ¨¡å¼å·²å¼€å¯ï¼Œå°†è‡ªåŠ¨å›å¤å…¬å…±èŠå¤©" or "ğŸ”´ AIåŒ–èº«æ¨¡å¼å·²å…³é—­", false, false)
end)

-- ========== ç›‘å¬å…¬å…±èŠå¤©å¹¶è‡ªåŠ¨å›å¤ ==========
-- é€‚é…Robloxé»˜è®¤èŠå¤©ç³»ç»Ÿ
local function onPlayerChatted(player, message)
    if not isAiChatMode or player == LocalPlayer then return end
    if message:sub(1, 1) == "/" then return end -- å¿½ç•¥æŒ‡ä»¤

    addMessage(player.Name .. ": " .. message, false, false)
    task.spawn(function()
        local aiReply = getFreeAIResponse(player.Name .. "è¯´: " .. message)
        aiTypeReply(aiReply, true)
        
        -- å‘é€åˆ°å…¬å…±èŠå¤©æ 
        local success, err = pcall(function()
            -- è§¦å‘Robloxé»˜è®¤èŠå¤©ï¼ˆéœ€ç¡®ä¿æ¸¸æˆèŠå¤©ç³»ç»Ÿæ­£å¸¸ï¼‰
            local ChatService = require(ReplicatedStorage:FindFirstChild("ChatServiceRunner"):FindFirstChild("ChatService"))
            local speaker = ChatService:GetSpeaker(LocalPlayer.Name)
            speaker:SayMessage(aiReply, "All")
        end)
        if not success then
            warn("å‘é€å…¬å…±èŠå¤©å¤±è´¥: " .. err)
            addMessage("âŒ æ— æ³•å‘é€å…¬å…±èŠå¤©ï¼Œå¯èƒ½èŠå¤©ç³»ç»ŸæœªåŠ è½½", false, false)
        end
    end)
end

-- ç»‘å®šèŠå¤©äº‹ä»¶
for _, player in ipairs(Players:GetPlayers()) do
    player.Chatted:Connect(function(msg)
        onPlayerChatted(player, msg)
    end)
end
Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(msg)
        onPlayerChatted(player, msg)
    end)
end)

print("âœ… é«˜çº§AIèŠå¤©é¢æ¿åŠ è½½å®Œæˆ")

-- Minecraftç”Ÿå­˜æ¨¡å¼ - æœ¬åœ°å®¢æˆ·ç«¯è„šæœ¬
-- ä»…åœ¨ä½ çš„å®¢æˆ·ç«¯ä¸Šå¯è§ï¼Œä¸å½±å“å…¶ä»–ç©å®¶
-- æ”¾åœ¨StarterPlayerScriptsæˆ–LocalScriptä¸­

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local camera = workspace.CurrentCamera

-- æ–¹å—ç±»å‹å®šä¹‰ï¼ˆæœ¬åœ°è§†è§‰æ•ˆæœï¼‰
local BlockTypes = {
    Grass = {
        Color = Color3.fromRGB(92, 168, 80),
        Material = Enum.Material.Grass
    },
    Dirt = {
        Color = Color3.fromRGB(135, 102, 67),
        Material = Enum.Material.Mud
    },
    Stone = {
        Color = Color3.fromRGB(128, 128, 128),
        Material = Enum.Material.Slate
    },
    Wood = {
        Color = Color3.fromRGB(160, 120, 80),
        Material = Enum.Material.Wood
    },
    Leaves = {
        Color = Color3.fromRGB(60, 140, 80),
        Material = Enum.Material.LeafyGrass
    }
}

-- æ¸¸æˆçŠ¶æ€
local GameState = {
    Inventory = {},
    SelectedBlock = "Grass",
    BlockSize = 3,
    WorldData = {},
    DayNightCycle = true,
    TimeOfDay = 12, -- 12ç‚¹ = æ­£åˆ
    SurvivalMode = true,
    Health = 100,
    Hunger = 100,
    Oxygen = 100
}

-- å·¥å…·ç®¡ç†
local Tools = {
    Pickaxe = {
        Name = "é•",
        Range = 15,
        Damage = 10,
        MiningSpeed = 1.5
    },
    Axe = {
        Name = "æ–§",
        Range = 12,
        Damage = 8,
        MiningSpeed = 2
    },
    Shovel = {
        Name = "é”¹",
        Range = 10,
        Damage = 5,
        MiningSpeed = 1.8
    }
}

-- UIåˆ›å»º
local function createUI()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MinecraftUI"
    screenGui.Parent = player.PlayerGui
    screenGui.ResetOnSpawn = false
    
    -- è¡€é‡æ˜¾ç¤º
    local healthFrame = Instance.new("Frame")
    healthFrame.Name = "HealthFrame"
    healthFrame.Size = UDim2.new(0.2, 0, 0.05, 0)
    healthFrame.Position = UDim2.new(0.02, 0, 0.92, 0)
    healthFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    healthFrame.BackgroundTransparency = 0.5
    healthFrame.Parent = screenGui
    
    local healthText = Instance.new("TextLabel")
    healthText.Name = "HealthText"
    healthText.Size = UDim2.new(1, 0, 1, 0)
    healthText.BackgroundTransparency = 1
    healthText.Text = "â¤ï¸ ç”Ÿå‘½: 100"
    healthText.TextColor3 = Color3.fromRGB(255, 100, 100)
    healthText.Font = Enum.Font.SourceSansBold
    healthText.Parent = healthFrame
    
    -- ç‰©å“æ 
    local inventoryFrame = Instance.new("Frame")
    inventoryFrame.Name = "InventoryFrame"
    inventoryFrame.Size = UDim2.new(0.3, 0, 0.08, 0)
    inventoryFrame.Position = UDim2.new(0.35, 0, 0.92, 0)
    inventoryFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    inventoryFrame.BackgroundTransparency = 0.5
    inventoryFrame.Parent = screenGui
    
    local inventoryText = Instance.new("TextLabel")
    inventoryText.Name = "InventoryText"
    inventoryText.Size = UDim2.new(1, 0, 1, 0)
    inventoryText.BackgroundTransparency = 1
    inventoryText.Text = "ç‰©å“æ : ç©º"
    inventoryText.TextColor3 = Color3.fromRGB(255, 255, 255)
    inventoryText.Font = Enum.Font.SourceSansBold
    inventoryText.Parent = inventoryFrame
    
    -- é€‰æ‹©æ–¹å—æ˜¾ç¤º
    local selectedFrame = Instance.new("Frame")
    selectedFrame.Name = "SelectedBlockFrame"
    selectedFrame.Size = UDim2.new(0.12, 0, 0.12, 0)
    selectedFrame.Position = UDim2.new(0.88, 0, 0.44, 0)
    selectedFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    selectedFrame.BorderSizePixel = 3
    selectedFrame.BorderColor3 = Color3.fromRGB(255, 255, 255)
    selectedFrame.Parent = screenGui
    
    local selectedText = Instance.new("TextLabel")
    selectedText.Name = "SelectedText"
    selectedText.Size = UDim2.new(1, 0, 0.3, 0)
    selectedText.Position = UDim2.new(0, 0, 0.7, 0)
    selectedText.BackgroundTransparency = 1
    selectedText.Text = "è‰æ–¹å—"
    selectedText.TextColor3 = Color3.fromRGB(255, 255, 255)
    selectedText.Font = Enum.Font.SourceSansBold
    selectedText.Parent = selectedFrame
    
    -- æ–¹å—é¢„è§ˆ
    local blockPreview = Instance.new("Part")
    blockPreview.Name = "BlockPreview"
    blockPreview.Size = Vector3.new(2.8, 2.8, 2.8)
    blockPreview.Transparency = 0.6
    blockPreview.Anchored = true
    blockPreview.CanCollide = false
    blockPreview.Color = BlockTypes.Grass.Color
    blockPreview.Material = BlockTypes.Grass.Material
    blockPreview.Parent = workspace.Terrain
    blockPreview.Position = Vector3.new(0, 100, 0) -- åˆå§‹ä½ç½®
    
    -- æç¤ºæ–‡æœ¬
    local hintText = Instance.new("TextLabel")
    hintText.Name = "HintText"
    hintText.Size = UDim2.new(0.4, 0, 0.1, 0)
    hintText.Position = UDim2.new(0.3, 0, 0.02, 0)
    hintText.BackgroundTransparency = 1
    hintText.Text = "Minecraftç”Ÿå­˜æ¨¡å¼ (æœ¬åœ°) - [Q]åˆ‡æ¢æ–¹å— [E]é‡‡é›† [R]æ”¾ç½® [T]ä¸¢å¼ƒ"
    hintText.TextColor3 = Color3.fromRGB(255, 255, 0)
    hintText.Font = Enum.Font.SourceSansBold
    hintText.TextSize = 18
    hintText.Parent = screenGui
    
    return {
        ScreenGui = screenGui,
        HealthText = healthText,
        InventoryText = inventoryText,
        SelectedText = selectedText,
        BlockPreview = blockPreview,
        HintText = hintText
    }
end

-- æ–¹å—ç”Ÿæˆç³»ç»Ÿï¼ˆä»…æœ¬åœ°è§†è§‰æ•ˆæœï¼‰
local function createBlock(position, blockType)
    local chunkX = math.floor(position.X / 50)
    local chunkZ = math.floor(position.Z / 50)
    local chunkKey = chunkX .. "_" .. chunkZ
    
    if not GameState.WorldData[chunkKey] then
        GameState.WorldData[chunkKey] = {}
    end
    
    local blockKey = math.floor(position.X) .. "_" .. math.floor(position.Y) .. "_" .. math.floor(position.Z)
    
    if not GameState.WorldData[chunkKey][blockKey] then
        local block = Instance.new("Part")
        block.Name = "MCBlock_" .. blockType
        block.Size = Vector3.new(GameState.BlockSize, GameState.BlockSize, GameState.BlockSize)
        block.Position = Vector3.new(
            math.floor(position.X / GameState.BlockSize) * GameState.BlockSize + GameState.BlockSize/2,
            math.floor(position.Y / GameState.BlockSize) * GameState.BlockSize + GameState.BlockSize/2,
            math.floor(position.Z / GameState.BlockSize) * GameState.BlockSize + GameState.BlockSize/2
        )
        block.Anchored = true
        block.CanCollide = true
        block.Color = BlockTypes[blockType].Color
        block.Material = BlockTypes[blockType].Material
        block.Parent = workspace.Terrain
        
        -- æ·»åŠ æ ‡ç­¾ç”¨äºè¯†åˆ«
        local tag = Instance.new("StringValue")
        tag.Name = "BlockType"
        tag.Value = blockType
        tag.Parent = block
        
        GameState.WorldData[chunkKey][blockKey] = {
            Block = block,
            Type = blockType,
            Position = position
        }
        
        return block
    end
    
    return nil
end

-- åˆ é™¤æ–¹å—
local function removeBlock(position)
    local chunkX = math.floor(position.X / 50)
    local chunkZ = math.floor(position.Z / 50)
    local chunkKey = chunkX .. "_" .. chunkZ
    
    if GameState.WorldData[chunkKey] then
        local blockKey = math.floor(position.X) .. "_" .. math.floor(position.Y) .. "_" .. math.floor(position.Z)
        
        if GameState.WorldData[chunkKey][blockKey] then
            local blockData = GameState.WorldData[chunkKey][blockKey]
            if blockData.Block then
                blockData.Block:Destroy()
            end
            GameState.WorldData[chunkKey][blockKey] = nil
            
            -- æ·»åŠ åˆ°ç‰©å“æ 
            table.insert(GameState.Inventory, blockData.Type)
            return blockData.Type
        end
    end
    
    return nil
end

-- å°„çº¿æ£€æµ‹
local function raycastFromCamera(distance)
    local mousePos = UserInputService:GetMouseLocation()
    local unitRay = camera:ScreenPointToRay(mousePos.X, mousePos.Y)
    
    local raycastParams = RaycastParams.new()
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.FilterDescendantsInstances = {character}
    
    local result = workspace:Raycast(unitRay.Origin, unitRay.Direction * distance, raycastParams)
    
    if result then
        return result.Position, result.Instance, result.Normal
    end
    
    return nil, nil, nil
end

-- æ›´æ–°UI
local function updateUI(ui)
    ui.HealthText.Text = string.format("â¤ï¸ ç”Ÿå‘½: %d ğŸ– é¥¥é¥¿: %d", GameState.Health, GameState.Hunger)
    ui.InventoryText.Text = string.format("ç‰©å“æ : %dä¸ªç‰©å“", #GameState.Inventory)
    ui.SelectedText.Text = GameState.SelectedBlock
    
    local selectedBlockType = BlockTypes[GameState.SelectedBlock]
    if selectedBlockType then
        ui.BlockPreview.Color = selectedBlockType.Color
        ui.BlockPreview.Material = selectedBlockType.Material
    end
end

-- ç”ŸæˆåŸºç¡€åœ°å½¢
local function generateTerrain()
    local startPos = character.HumanoidRootPart.Position
    
    for x = -50, 50, GameState.BlockSize do
        for z = -50, 50, GameState.BlockSize do
            local height = 5
            if math.noise(x * 0.1, z * 0.1) > 0 then
                height = 8
            end
            
            for y = 0, height do
                local blockType = "Dirt"
                if y == height then
                    blockType = "Grass"
                elseif y > height - 3 then
                    blockType = "Dirt"
                else
                    blockType = "Stone"
                end
                
                createBlock(startPos + Vector3.new(x, y * GameState.BlockSize, z), blockType)
            end
            
            -- ç”Ÿæˆä¸€äº›æ ‘
            if math.random(1, 20) == 1 then
                local treeHeight = math.random(4, 6)
                for y = height + 1, height + treeHeight do
                    createBlock(startPos + Vector3.new(x, y * GameState.BlockSize, z), "Wood")
                end
                
                -- æ ‘å¶
                for dx = -1, 1 do
                    for dz = -1, 1 do
                        for dy = -1, 1 do
                            if not (dx == 0 and dz == 0) then
                                createBlock(
                                    startPos + Vector3.new(
                                        x + dx * GameState.BlockSize,
                                        (height + treeHeight - 1) * GameState.BlockSize,
                                        z + dz * GameState.BlockSize
                                    ),
                                    "Leaves"
                                )
                            end
                        end
                    end
                end
            end
        end
    end
end

-- æ˜¼å¤œå¾ªç¯
local function dayNightCycle()
    if GameState.DayNightCycle then
        GameState.TimeOfDay = (GameState.TimeOfDay + 0.01) % 24
        
        local brightness = 1
        if GameState.TimeOfDay > 18 or GameState.TimeOfDay < 6 then
            brightness = 0.2 -- å¤œæ™š
        elseif GameState.TimeOfDay > 17 or GameState.TimeOfDay < 7 then
            brightness = 0.5 -- é»„æ˜/é»æ˜
        end
        
        game.Lighting.Brightness = brightness
        game.Lighting.ClockTime = GameState.TimeOfDay
        
        if GameState.TimeOfDay > 5 and GameState.TimeOfDay < 19 then
            game.Lighting.FogEnd = 10000
            game.Lighting.FogColor = Color3.fromRGB(200, 220, 255)
        else
            game.Lighting.FogEnd = 1000
            game.Lighting.FogColor = Color3.fromRGB(10, 10, 30)
        end
    end
end

-- ç”Ÿå­˜æœºåˆ¶
local function survivalMechanics(deltaTime)
    if GameState.SurvivalMode then
        -- é¥¥é¥¿å‡å°‘
        GameState.Hunger = math.max(0, GameState.Hunger - deltaTime * 0.5)
        
        -- å¦‚æœé¥¥é¥¿è¿‡ä½ï¼Œå‡å°‘ç”Ÿå‘½å€¼
        if GameState.Hunger < 20 then
            GameState.Health = math.max(0, GameState.Health - deltaTime * 1)
        end
        
        -- è‡ªåŠ¨æ¢å¤ç”Ÿå‘½ï¼ˆå¦‚æœé¥¥é¥¿å……è¶³ï¼‰
        if GameState.Hunger > 80 and GameState.Health < 100 then
            GameState.Health = math.min(100, GameState.Health + deltaTime * 2)
        end
        
        -- æ°´ä¸‹æ£€æŸ¥
        local headPos = character.Head.Position
        local terrain = workspace.Terrain
        local material, _ = terrain:ReadVoxels(
            Region3.new(
                headPos - Vector3.new(0.5, 0.5, 0.5),
                headPos + Vector3.new(0.5, 0.5, 0.5)
            ),
            4
        )
        
        -- ç®€å•çš„æ°´æ£€æŸ¥
        if headPos.Y < 0 then -- å‡è®¾æ°´é¢åœ¨Y=0
            GameState.Oxygen = math.max(0, GameState.Oxygen - deltaTime * 10)
            if GameState.Oxygen <= 0 then
                GameState.Health = math.max(0, GameState.Health - deltaTime * 5)
            end
        else
            GameState.Oxygen = math.min(100, GameState.Oxygen + deltaTime * 20)
        end
    end
end

-- ä¸»å‡½æ•°
local function main()
    -- åˆ›å»ºUI
    local ui = createUI()
    
    -- ç”Ÿæˆåˆå§‹åœ°å½¢
    generateTerrain()
    
    -- è¾“å…¥å¤„ç†
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        
        local hitPos, hitInstance, normal = raycastFromCamera(100)
        
        if input.KeyCode == Enum.KeyCode.E then -- é‡‡é›†
            if hitPos then
                local blockType = removeBlock(hitPos)
                if blockType then
                    ui.HintText.Text = "é‡‡é›†: " .. blockType
                end
            end
            
        elseif input.KeyCode == Enum.KeyCode.R then -- æ”¾ç½®
            if hitPos and #GameState.Inventory > 0 then
                local placePos = hitPos + (normal * GameState.BlockSize)
                local blockType = table.remove(GameState.Inventory, 1)
                createBlock(placePos, blockType)
                ui.HintText.Text = "æ”¾ç½®: " .. blockType
            end
            
        elseif input.KeyCode == Enum.KeyCode.Q then -- åˆ‡æ¢æ–¹å—
            local blockTypes = {"Grass", "Dirt", "Stone", "Wood", "Leaves"}
            local currentIndex = 1
            for i, blockType in ipairs(blockTypes) do
                if blockType == GameState.SelectedBlock then
                    currentIndex = i
                    break
                end
            end
            
            local nextIndex = (currentIndex % #blockTypes) + 1
            GameState.SelectedBlock = blockTypes[nextIndex]
            ui.HintText.Text = "é€‰æ‹©: " .. GameState.SelectedBlock
            
        elseif input.KeyCode == Enum.KeyCode.T then -- ä¸¢å¼ƒ
            if #GameState.Inventory > 0 then
                local dropped = table.remove(GameState.Inventory, 1)
                ui.HintText.Text = "ä¸¢å¼ƒ: " .. dropped
            end
        end
    end)
    
    -- æ¸¸æˆå¾ªç¯
    local lastTime = tick()
    RunService.RenderStepped:Connect(function()
        local currentTime = tick()
        local deltaTime = currentTime - lastTime
        lastTime = currentTime
        
        -- æ›´æ–°æ–¹å—é¢„è§ˆ
        local hitPos, _, normal = raycastFromCamera(50)
        if hitPos then
            ui.BlockPreview.Position = hitPos + (normal * GameState.BlockSize/2)
            ui.BlockPreview.Transparency = 0.6
        else
            ui.BlockPreview.Transparency = 1
        end
        
        -- æ›´æ–°ç”Ÿå­˜æœºåˆ¶
        survivalMechanics(deltaTime)
        
        -- æ˜¼å¤œå¾ªç¯
        dayNightCycle()
        
        -- æ›´æ–°UI
        updateUI(ui)
    end)
    
    -- è§’è‰²æ­»äº¡é‡ç½®
    character.Humanoid.Died:Connect(function()
        task.wait(3)
        GameState.Health = 100
        GameState.Hunger = 100
        GameState.Oxygen = 100
        character:BreakJoints()
    end)
    
    print("Minecraftç”Ÿå­˜æ¨¡å¼å·²åŠ è½½ï¼")
    print("æ§åˆ¶è¯´æ˜:")
    print("Q - åˆ‡æ¢æ–¹å—ç±»å‹")
    print("E - é‡‡é›†æ–¹å—")
    print("R - æ”¾ç½®æ–¹å—")
    print("T - ä¸¢å¼ƒç‰©å“")
    print("WASD - ç§»åŠ¨")
    print("ç©ºæ ¼ - è·³è·ƒ")
end

-- ç­‰å¾…è§’è‰²åŠ è½½
if not character then
    player.CharacterAdded:Wait()
    character = player.Character
end

-- å¯åŠ¨æ¸¸æˆ
main()
